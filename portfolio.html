let projects = [];
let curIdx = 0;
let imgIdx = 0;
let slideTimer = null;

async function init() {
    try {
        const res = await fetch('/.netlify/functions/portfolio');
        const data = await res.json();
        // Notion API 응답 구조 확인
        projects = data.results || data;
        
        document.getElementById('portfolioGrid').innerHTML = projects.map((p, i) => {
            const firstImg = getImageUrl(p.properties.URL?.files?.[0]);
            const title = p.properties.이름?.title?.[0]?.plain_text || "제목 없음";
            return `
                <div class="portfolio-card" onclick="openDetail(${i})">
                    <img src="${firstImg}" alt="${title}">
                    <h3>${title}</h3>
                </div>
            `;
        }).join('');
    } catch (err) { 
        console.error('포트폴리오 로드 실패:', err); 
        document.getElementById('portfolioGrid').innerHTML = 
            '<p style="text-align:center; padding:60px;">프로젝트를 불러올 수 없습니다.</p>';
    }
}

// 이미지 URL 추출 헬퍼 함수
function getImageUrl(file) {
    if (!file) return '/images/placeholder.jpg'; // 기본 이미지
    return file.external?.url || file.file?.url || '';
}

function openDetail(i) {
    curIdx = i;
    imgIdx = 0;
    updateContent();
    document.getElementById('detailView').classList.add('active');
    document.body.style.overflow = 'hidden';
    startAutoSlide();
}

function updateContent() {
    const p = projects[curIdx].properties;
    const images = p.URL?.files || [];
    
    // 이미지가 있을 때만 표시
    if (images.length > 0) {
        document.getElementById('mainImg').src = getImageUrl(images[imgIdx]);
    } else {
        document.getElementById('mainImg').src = '/images/placeholder.jpg';
    }
    
    document.getElementById('projTitle').textContent = 
        p.이름?.title?.[0]?.plain_text || "제목 없음";
    
    document.getElementById('infoGrid').innerHTML = `
        <div class="info-item"><h4>면적</h4><p>${p.면적?.select?.name || "-"}</p></div>
        <div class="info-item"><h4>주거형태</h4><p>${p.카테고리?.select?.name || "-"}</p></div>
        <div class="info-item"><h4>바닥</h4><p>${p.바닥?.select?.name || "-"}</p></div>
        <div class="info-item"><h4>가구</h4><p>${p.가구?.select?.name || "-"}</p></div>
    `;
}

function changeImg(dir) {
    const imgs = projects[curIdx].properties.URL?.files || [];
    
    // 이미지가 없으면 리턴
    if (imgs.length === 0) return;
    
    // 이미지가 1개만 있으면 슬라이드 불필요
    if (imgs.length === 1) return;
    
    imgIdx = (imgIdx + dir + imgs.length) % imgs.length;
    
    // 페이드 효과
    const img = document.getElementById('mainImg');
    img.style.opacity = '0';
    setTimeout(() => {
        updateContent();
        img.style.opacity = '1';
    }, 250);
}

function startAutoSlide() {
    if (slideTimer) clearInterval(slideTimer);
    
    const imgs = projects[curIdx].properties.URL?.files || [];
    // 이미지가 2개 이상일 때만 자동 슬라이드
    if (imgs.length > 1) {
        slideTimer = setInterval(() => changeImg(1), 4000); // 4초로 변경
    }
}

function closeDetail() {
    if (slideTimer) {
        clearInterval(slideTimer);
        slideTimer = null;
    }
    document.getElementById('detailView').classList.remove('active');
    document.body.style.overflow = 'auto';
}

// ESC 키로 상세 뷰 닫기
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && document.getElementById('detailView').classList.contains('active')) {
        closeDetail();
    }
});

window.onload = init;