
<!-- [Step 1] ë°ì´í„° ì§„ë‹¨ ë° ë³‘í•© ëª¨ë‹¬ -->
<div id="step1Modal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <span class="close" onclick="closeStep1Modal()">&times;</span>
        <h2>ğŸ” [Step 1] ë¡œì»¬ ë°ì´í„° ì§„ë‹¨ ë° ë³‘í•©</h2>
        <div style="margin: 20px 0; max-height: 500px; overflow-y: auto;">
            <p>ë¸Œë¼ìš°ì €(ë¡œì»¬)ì—ë§Œ ì €ì¥ë˜ì–´ ìˆê³  í´ë¼ìš°ë“œ(êµ¬ê¸€ì‹œíŠ¸)ì— ì—†ëŠ” ë°ì´í„°ë¥¼ ì°¾ìŠµë‹ˆë‹¤.</p>
            
            <div id="step1Status" style="padding: 15px; background: #f5f5f7; border-radius: 8px; margin-bottom: 20px;">
                <div id="step1Log">ì§„ë‹¨ ì‹œì‘ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”...</div>
            </div>

            <table class="report-table" style="width:100%; font-size:13px; border-collapse: collapse;">
                <thead>
                    <tr style="background:#eee; text-align:left;">
                        <th style="padding:8px;">ë°ì´í„° ì¢…ë¥˜ (Key)</th>
                        <th style="padding:8px;">ë¡œì»¬ ê±´ìˆ˜</th>
                        <th style="padding:8px;">í´ë¼ìš°ë“œ ê±´ìˆ˜</th>
                        <th style="padding:8px;">ë¡œì»¬ ì „ìš© (ëˆ„ë½)</th>
                        <th style="padding:8px;">ìƒíƒœ</th>
                    </tr>
                </thead>
                <tbody id="step1ReportBody"></tbody>
            </table>
        </div>
        <div style="text-align: right; margin-top: 20px;">
            <button class="btn-sub" onclick="runStep1Diagnosis()">â–¶ 1. ì§„ë‹¨ ì‹œì‘</button>
            <button id="step1MergeBtn" class="btn-main" onclick="runStep1Merge()" style="display:none; margin-left:10px;">â˜ï¸ 2. í´ë¼ìš°ë“œë¡œ ë³‘í•© (ì €ì¥)</button>
        </div>
    </div>
</div>

<script>
    // [Step 1] ì „ì—­ ë³€ìˆ˜
    let step1MergeCandidates = {
        customers: [],
        expenses: [],
        fixedExpenses: []
    };
    let step1CloudData = {
        customers: [],
        expenses: [],
        fixedExpenses: []
    };

    function openStep1Modal() {
        document.getElementById('step1Modal').classList.add('show');
        document.getElementById('step1Log').innerHTML = 'ì§„ë‹¨ ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.';
        document.getElementById('step1MergeBtn').style.display = 'none';
        document.getElementById('step1ReportBody').innerHTML = '';
    }

    function closeStep1Modal() {
        document.getElementById('step1Modal').classList.remove('show');
    }

    function logStep1(msg) {
        const logDiv = document.getElementById('step1Log');
        logDiv.innerHTML += `<div>${msg}</div>`;
        logDiv.scrollTop = logDiv.scrollHeight;
        console.log(`[Step1] ${msg}`);
    }

    async function runStep1Diagnosis() {
        logStep1('ğŸ”„ í´ë¼ìš°ë“œ ë°ì´í„° ê°€ì ¸ì˜¤ëŠ” ì¤‘...');
        try {
            // 1. Fetch Cloud Data
            // Customers
            const custRes = await fetch(CUSTOMER_SYNC_URL + '?sheet=customer');
            const custJson = await custRes.json();
            step1CloudData.customers = custJson.data || [];

            // Expenses
            const expRes = await fetch(CUSTOMER_SYNC_URL + '?sheet=expenses');
            const expJson = await expRes.json();
            step1CloudData.expenses = expJson.data || [];
            
            // Fixed Expenses
            step1CloudData.fixedExpenses = expJson.fixed || [];

            logStep1('âœ… í´ë¼ìš°ë“œ ë°ì´í„° ìˆ˜ì‹  ì™„ë£Œ.');

            // 2. Load Local Data
            const localCust = JSON.parse(localStorage.getItem('dz_customers') || '[]');
            const localExp = JSON.parse(localStorage.getItem('designzig_expenses') || '[]');
            const localFixed = JSON.parse(localStorage.getItem('designzig_fixed_expenses') || '[]');

            // 3. Compare - Customers
            const cloudCustIds = new Set(step1CloudData.customers.map(c => c.customerId));
            const localOnlyCust = localCust.filter(c => !cloudCustIds.has(c.customerId));
            step1MergeCandidates.customers = localOnlyCust;

            // Compare - Expenses (IDê°€ ì—†ìœ¼ë¯€ë¡œ ë‚´ìš© ë¹„êµê°€ ì–´ë µì§€ë§Œ, ë‚ ì§œ+ë‚´ìš©ìœ¼ë¡œ ì¶”ì •í•˜ê±°ë‚˜ ì „ì²´ ë®ì–´ì“°ê¸° ì •ì±… í™•ì¸ í•„ìš”)
            // ì—¬ê¸°ì„œëŠ” 'ë¡œì»¬ì—ë§Œ ìˆëŠ” ë°ì´í„°'ë¥¼ ì‹ë³„í•˜ê¸° ì–´ë ¤ìš°ë¯€ë¡œ (ID ë¶€ì¬), ë‹¨ìˆœ ê°œìˆ˜ ë¹„êµë§Œ ìˆ˜í–‰
            // ë‹¨, ì§€ì¶œê²°ì˜ì„œëŠ” IDê°€ ì—†ìœ¼ë¯€ë¡œ ë³‘í•© ìë™í™”ê°€ ìœ„í—˜í•¨. ë¦¬í¬íŠ¸ë§Œ ì œê³µ.
            
            const reportBody = document.getElementById('step1ReportBody');
            reportBody.innerHTML = '';

            // Render Report
            // Customers
            addStep1Row('ê³ ê° ëª©ë¡ (dz_customers)', localCust.length, step1CloudData.customers.length, localOnlyCust.length, localOnlyCust.length > 0 ? 'ë³‘í•© í•„ìš”' : 'ì •ìƒ');
            
            // Expenses
            // ì§€ì¶œê²°ì˜ì„œëŠ” ë™ê¸°í™” ë¡œì§ì´ 'ì „ì²´ ë¡œë“œ' ë°©ì‹ì´ë¯€ë¡œ ë¡œì»¬ì´ ë” ë§ë‹¤ë©´ ì•„ì§ ì €ì¥ ì•ˆëœ ê²ƒì¼ ìˆ˜ ìˆìŒ.
            const expDiff = localExp.length - step1CloudData.expenses.length;
            addStep1Row('ì§€ì¶œê²°ì˜ì„œ (designzig_expenses)', localExp.length, step1CloudData.expenses.length, expDiff > 0 ? `${expDiff}ê±´ (ì¶”ì •)` : '0', expDiff > 0 ? 'í™•ì¸ í•„ìš”' : 'ì •ìƒ');

            // Fixed Expenses
            const fixedDiff = localFixed.length - step1CloudData.fixedExpenses.length;
            addStep1Row('ê³ ì •ì§€ì¶œ (designzig_fixed_expenses)', localFixed.length, step1CloudData.fixedExpenses.length, fixedDiff > 0 ? `${fixedDiff}ê±´ (ì¶”ì •)` : '0', fixedDiff > 0 ? 'í™•ì¸ í•„ìš”' : 'ì •ìƒ');

            logStep1('ğŸ“Š ì§„ë‹¨ ì™„ë£Œ.');

            if (localOnlyCust.length > 0) {
                document.getElementById('step1MergeBtn').style.display = 'inline-block';
                logStep1(`â— í´ë¼ìš°ë“œì— ì—†ëŠ” ê³ ê° ë°ì´í„° ${localOnlyCust.length}ê±´ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            } else {
                 logStep1(`âœ… ë¡œì»¬ ì „ìš© ê³ ê° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`);
            }

        } catch (e) {
            logStep1(`âŒ ì˜¤ë¥˜ ë°œìƒ: ${e.message}`);
            alert('ì§„ë‹¨ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.message);
        }
    }

    function addStep1Row(name, localCnt, cloudCnt, missingCnt, status) {
        const tbody = document.getElementById('step1ReportBody');
        const color = status === 'ì •ìƒ' ? 'green' : 'red';
        const tr = `
            <tr style="border-bottom:1px solid #ddd;">
                <td style="padding:8px;">${name}</td>
                <td style="padding:8px;">${localCnt}</td>
                <td style="padding:8px;">${cloudCnt}</td>
                <td style="padding:8px; font-weight:bold; color:${missingCnt > 0 || typeof missingCnt === 'string' && missingCnt !== '0' ? 'red' : 'black'}">${missingCnt}</td>
                <td style="padding:8px; color:${color}; font-weight:bold;">${status}</td>
            </tr>
        `;
        tbody.innerHTML += tr;
    }

    async function runStep1Merge() {
        if (!confirm(`ì´ ${step1MergeCandidates.customers.length}ê±´ì˜ ê³ ê° ë°ì´í„°ë¥¼ í´ë¼ìš°ë“œë¡œ ì „ì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ê¸°ì¡´ í´ë¼ìš°ë“œ ë°ì´í„°ëŠ” ë³´ì¡´ë©ë‹ˆë‹¤)`)) return;

        logStep1('â˜ï¸ ë°ì´í„° ë³‘í•©(ì „ì†¡) ì‹œì‘...');
        let successCount = 0;
        let failCount = 0;

        for (const cust of step1MergeCandidates.customers) {
            try {
                // ê°œë³„ ê³ ê° ì €ì¥ API í˜¸ì¶œ (ê¸°ì¡´ saveCustomerToCloud ë¡œì§ í™œìš© ë˜ëŠ” ì§ì ‘ fetch)
                // ì—¬ê¸°ì„œëŠ” payloadë¥¼ ì§ì ‘ êµ¬ì„±í•˜ì—¬ ì „ì†¡
                const payload = {
                    action: 'update_customer',
                    ...cust
                };
                
                // ê¸°ì¡´ sync í•¨ìˆ˜ ì¬ì‚¬ìš© ë¶ˆê°€ ì‹œ fetch ì§ì ‘ í˜¸ì¶œ
                const response = await fetch(CUSTOMER_SYNC_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // Apps Script Web App requirement
                    body: JSON.stringify(payload)
                });
                
                const res = await response.json();
                if (res.result === 'success') {
                    successCount++;
                    logStep1(`âœ… [ì „ì†¡ì™„ë£Œ] ${cust.clientName} (${cust.customerId})`);
                } else {
                    throw new Error(res.message);
                }
            } catch (e) {
                failCount++;
                logStep1(`âŒ [ì „ì†¡ì‹¤íŒ¨] ${cust.clientName}: ${e.message}`);
            }
        }

        logStep1(`ğŸ ë³‘í•© ì¢…ë£Œ. ì„±ê³µ: ${successCount}, ì‹¤íŒ¨: ${failCount}`);
        
        if (successCount > 0) {
            alert(`${successCount}ê±´ì˜ ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë³‘í•©í–ˆìŠµë‹ˆë‹¤.`);
            // í™”ë©´ ìƒˆë¡œê³ ì¹¨ ê¶Œì¥
            if(confirm('ë°ì´í„° ê°±ì‹ ì„ ìœ„í•´ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                location.reload();
            }
        }
    }
</script>
