{\rtf1\ansi\ansicpg949\cocoartf2867
\cocoatextscaling0\cocoaplatform0{\fonttbl\f0\fswiss\fcharset0 Helvetica;}
{\colortbl;\red255\green255\blue255;}
{\*\expandedcolortbl;;}
\paperw11900\paperh16840\margl1440\margr1440\vieww11520\viewh8400\viewkind0
\pard\tx720\tx1440\tx2160\tx2880\tx3600\tx4320\tx5040\tx5760\tx6480\tx7200\tx7920\tx8640\pardirnatural\partightenfactor0

\f0\fs24 \cf0 /**\
 * [\uc0\u53685 \u54633 \u54805 ] \u46356 \u51088 \u51064 \u51648 \u44536  \u50937 \u49324 \u51060 \u53944  & \u44288 \u47532 \u51088  \u46041 \u44592 \u54868  \u49828 \u53356 \u47549 \u53944 \
 *\
 * 1. \uc0\u50937 \u49324 \u51060 \u53944  \u49345 \u45812  \u47928 \u51032  \u51217 \u49688  \u48143  \u51060 \u47700 \u51068  \u48156 \u49569 \
 * 2. \uc0\u44288 \u47532 \u51088  \u54168 \u51060 \u51648 (adminwonpro.html) \u44256 \u44061  \u45936 \u51060 \u53552  \u46041 \u44592 \u54868 \
 * 3. \uc0\u53944 \u47532 \u44144  \u44592 \u48152  \u51088 \u46041 \u54868  (\u49345 \u45812  \u49345 \u53468  \u48320 \u44221  \u49884  \u51060 \u46041 , A/S \u47564 \u47308  \u50508 \u47548 )\
 *\
 * \uc0\u47560 \u51648 \u47561  \u50629 \u45936 \u51060 \u53944 : 2026-01-21 (\u44256 \u44061  \u49345 \u53468  \u51088 \u46041  \u44081 \u49888  \u44592 \u45733  \u52628 \u44032 )\
 */\
\
// ==========================================\
// [\uc0\u46356 \u48260 \u44536 \u50857 ] DriveApp \u44428 \u54620  \u49849 \u51064  \u54632 \u49688  (\u49892 \u54665  \u54980  \u49325 \u51228  \u44032 \u45733 )\
// 1. \uc0\u51060  \u54632 \u49688 \u47484  \u49440 \u53469 \u54616 \u44256  '\u49892 \u54665 ' \u48260 \u53948 \u51012  \u53364 \u47533 \u54616 \u49464 \u50836 .\
// 2. \uc0\u44428 \u54620  \u44160 \u53664  \u54045 \u50629 \u50640 \u49436  \u49849 \u51064 \u51012  \u50756 \u47308 \u54616 \u49464 \u50836 .\
// ==========================================\
function debugUseDriveApp() \{\
    console.log("Drive \uc0\u44428 \u54620  \u54869 \u51064  \u51473 ...");\
    var files = DriveApp.getFiles();\
    if (files.hasNext()) \{\
        console.log("Drive \uc0\u51217 \u44540  \u49457 \u44277 : " + files.next().getName());\
    \} else \{\
        console.log("Drive \uc0\u51217 \u44540  \u49457 \u44277  (\u54028 \u51068  \u50630 \u51020 )");\
    \}\
\}\
\
// ==========================================\
// 1. \uc0\u49444 \u51221  \u48143  \u49345 \u49688  \u51221 \u51032 \
// ==========================================\
\
// [\uc0\u49345 \u45812 \u50857 ] \u49828 \u54532 \u47112 \u46300 \u49884 \u53944  ID (\u44592 \u51316  \u49345 \u45812  \u47928 \u51032 \u44032  \u49939 \u51060 \u45716  \u49884 \u53944 )\
// \uc0\u47564 \u50557  \u51060  \u49828 \u53356 \u47549 \u53944 \u44032  '\u49345 \u45812 \u50857  \u49884 \u53944 '\u50640  \u48148 \u51064 \u46377 \u46104 \u50612  \u51080 \u45796 \u47732  getActiveSpreadsheet()\u47484  \u50024 \u46020  \u46104 \u51648 \u47564 ,\
// \uc0\u47749 \u49884 \u51201 \u51004 \u47196  ID\u47484  \u51648 \u51221 \u54616 \u45716  \u44163 \u51060  \u50504 \u51204 \u54633 \u45768 \u45796 .\
const CONSULTING_SHEET_ID = '1Yp9UjY37PlBgXdyC2_acwfa8prxo7yD_VKAOcnIQQVw';\
\
// [\uc0\u44256 \u44061 \u44288 \u47532 \u50857 ] \u49828 \u54532 \u47112 \u46300 \u49884 \u53944  ID (\u44288 \u47532 \u51088  \u54168 \u51060 \u51648 \u50752  \u50672 \u46041 \u46104 \u45716  \u49884 \u53944 )\
// [\uc0\u49688 \u51221 ] Make \u50672 \u46041  \u49884 \u53944 \u47196  \u53685 \u54633 \u54616 \u44592  \u50948 \u54644  ID\u47484  \u49345 \u45812 \u50857 \u44284  \u46041 \u51068 \u54616 \u44172  \u49444 \u51221 \
const CUSTOMER_SHEET_ID = '1Yp9UjY37PlBgXdyC2_acwfa8prxo7yD_VKAOcnIQQVw';\
\
// [\uc0\u50896 \u44032 \u44288 \u47532 \u54364 \u50857 ] \u49828 \u54532 \u47112 \u46300 \u49884 \u53944  ID (\u53685 \u54633  \u49884 \u53944 \u50640  \u52628 \u44032 \u46120 )\
// [\uc0\u50896 \u44032 \u44288 \u47532 \u54364 \u50857 ] \u49828 \u54532 \u47112 \u46300 \u49884 \u53944  ID (\u53685 \u54633  \u49884 \u53944 \u50640  \u52628 \u44032 \u46120 )\
const COST_SHEET_ID = '1Yp9UjY37PlBgXdyC2_acwfa8prxo7yD_VKAOcnIQQVw';\
const SETTLEMENT_SHEET_NAME = '\uc0\u51221 \u49328 \u44288 \u47532 \u45824 \u51109 ';\
const LOG_SHEET_NAME = '\uc0\u51089 \u50629 \u44592 \u47197 ';\
\
// [\uc0\u49345 \u45812 \u50857 ] \u49444 \u47928  Form URL\
const FORM_BASE_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSdcsD1hjKMNezFTaPAZRlKovdRDfCW08cy4VfLHL_LJDcmbVw/viewform';\
\
// [\uc0\u49345 \u45812 \u50857 ] \u49444 \u47928  Entry IDs\
const ENTRY_IDS = \{\
    NAME: '2076163714',\
    PHONE: '217138793',\
    EMAIL: '916215270',\
    ADDRESS: '840428259',\
    MESSAGE: '1360575573'\
\};\
\
const SENDER_NAME = '\uc0\u46356 \u51088 \u51064 \u51648 \u44536 ';\
// [\uc0\u45432 \u49496  \u50672 \u46041  \u49444 \u51221 ]\
// \uc0\u51452 \u51032 : API \u53412 \u45716  \u49828 \u53356 \u47549 \u53944  \u49549 \u49457 (Project Settings > Script Properties)\u50640  \u51200 \u51109 \u54644 \u50556  \u50504 \u51204 \u54633 \u45768 \u45796 .\
// \uc0\u50500 \u47000  setupNotionProperties() \u54632 \u49688 \u47484  \u54620  \u48264  \u49892 \u54665 \u54616 \u50668  \u53412 \u47484  \u51200 \u51109 \u54616 \u49464 \u50836 .\
// \uc0\u44611 \u54728 \u48652 \u50640  \u53076 \u46300 \u47484  \u50732 \u47140 \u46020  \u53412 \u45716  \u45432 \u52636 \u46104 \u51648  \u50506 \u49845 \u45768 \u45796 .\
\
// [\uc0\u49688 \u51221 ] \u54632 \u49688 \u47196  \u48320 \u44221 \u54616 \u50668  \u47588 \u48264  \u49352 \u47196  \u51069 \u46020 \u47197  \u54632  (\u52880 \u49905  \u47928 \u51228  \u54644 \u44208 )\
function getNotionApiKey() \{\
    return PropertiesService.getScriptProperties().getProperty('NOTION_API_KEY');\
\}\
\
const NOTION_DB_IDS = \{\
    PROJECTS: '22bc2a121ce94ff28e171cf91bcdf3a8',\
    SCHEDULE: '6b993a15bb2643979ceb382460ed7e77',\
    CHECKLIST: '6040d967e63e4268905739f2a8be436e',\
    AS_LIST: '4f22eaa4dab246f2b32ab9dcbb37bd7a',\
    FAQ: 'dd49a5148c7a41cf8244f8f97dd8e0eb' // [\uc0\u52628 \u44032 ] \u44256 \u44061  \u50504 \u45236 \'b7FAQ\
\};\
\
// \uc0\u52964 \u48260  \u51060 \u48120 \u51648  URL\
const NOTION_COVER_IMAGE = 'https://res.cloudinary.com/designjig/image/upload/v1766495336/%E1%84%85%E1%85%A9%E1%84%80%E1%85%A9_w3be1q.png';\
\
/**\
 * [\uc0\u48372 \u50504  \u49444 \u51221 ] Notion API \u53412  \u50504 \u51204  \u51200 \u51109 \u49548 \
 * 1. \uc0\u45432 \u49496  \u44060 \u48156 \u51088  \u49468 \u53552 \u50640 \u49436  '\u49884 \u53356 \u47551  \u51116 \u48156 \u44553 '\u51012  \u48155 \u51004 \u49464 \u50836 .\
 * 2. \uc0\u50500 \u47000  \u48320 \u49688  newKey\u50640  '\u49352 \u47196 \u50868  \u49884 \u53356 \u47551  \u53412 '\u47484  \u48537 \u50668 \u45347 \u51004 \u49464 \u50836 .\
 * 3. \uc0\u51060  \u54632 \u49688 \u47484  \u49440 \u53469 \u54616 \u44256  [\u49892 \u54665 ] \u48260 \u53948 \u51012  \u54620  \u48264 \u47564  \u45572 \u47476 \u49464 \u50836 .\
 * 4. \uc0\u49892 \u54665  \u54980 \u50640 \u45716  newKey \u44050 \u51012  \u51648 \u50864 \u44256  \u51200 \u51109 \u49548 \u50640  \u50732 \u47532 \u49492 \u46020  \u50504 \u51204 \u54633 \u45768 \u45796 .\
 */\
function setupNotionProperties() \{\
    const newKey = 'ntn_g60962876676w2fQWeGwE9AKT6VA4HCkMQpo9yRo3cGaH9'; // \uc0\u50696 : ntn_...\
\
    PropertiesService.getScriptProperties().setProperty('NOTION_API_KEY', newKey);\
    Logger.log('\uc0\u9989  \u49352 \u47196 \u50868  Notion API Key\u44032  \u50504 \u51204 \u54616 \u44172  \u51200 \u51109 \u46104 \u50632 \u49845 \u45768 \u45796 !');\
    Logger.log('\uc0\u51060 \u51228  \u53076 \u46300 \u47484  \u44611 \u54728 \u48652 \u50640  \u50732 \u47140 \u46020  \u53412 \u45716  \u50976 \u52636 \u46104 \u51648  \u50506 \u49845 \u45768 \u45796 .');\
\}\
\
// [\uc0\u44592 \u48376  \u45936 \u51060 \u53552 ] \u44277 \u49324  \u49828 \u52992 \u51460  \u53596 \u54540 \u47551 \
const DEFAULT_SCHEDULE_TEMPLATE = [\
    ['01. \uc0\u44592 \u54925 \'b7\u51456 \u48708 ', '\u54788 \u51109  \u49892 \u52769  \u48143  \u46356 \u51088 \u51064  \u49345 \u45812 ', '\u46356 \u51088 \u51064  \u52968 \u49481  \u54869 \u51221  \u50668 \u48512 ', '', '', '\u46356 \u51088 \u51064 \u54016 ', ''],\
    ['01. \uc0\u44592 \u54925 \'b7\u51456 \u48708 ', '\u46020 \u47732  \u49444 \u44228  \u48143  \u44204 \u51201  \u54869 \u51221 ', '\u52572 \u51333  \u46020 \u47732 /\u44204 \u51201  \u49849 \u51064 ', '', '', '\u46356 \u51088 \u51064 \u54016 ', ''],\
    ['01. \uc0\u44592 \u54925 \'b7\u51456 \u48708 ', '\u44277 \u49324  \u50504 \u45236 \u47928  \u48512 \u52265  \u48143  \u46041 \u51032 \u49436 ', '\u44288 \u47532 \u49324 \u47924 \u49548  \u49888 \u44256  \u50756 \u47308  \u50668 \u48512 ', '', '', '\u54788 \u51109 \u44288 \u47532 \u51088 ', ''],\
    ['01. \uc0\u44592 \u54925 \'b7\u51456 \u48708 ', '\u51088 \u51116  \u49440 \u51221  \u48143  \u48156 \u51452 ', '\u53440 \u51068 /\u46020 \u44592 /\u51312 \u47749  \u46321  \u51452 \u50836  \u51088 \u51116 ', '', '', '\u46356 \u51088 \u51064 \u54016 ', ''],\
    ['02. \uc0\u52384 \u44144  \u44277 \u49324 ', '\u51204 \u52404  \u52384 \u44144  \u48143  \u54224 \u44592 \u47932  \u48152 \u52636 ', '\u52384 \u44144  \u48276 \u50948  \u51116 \u54869 \u51064 ', '', '', '\u52384 \u44144 \u54016 ', ''],\
    ['02. \uc0\u52384 \u44144  \u44277 \u49324 ', '\u49444 \u48708  \u46972 \u51064  \u47560 \u53433  \u48143  \u54869 \u51064 ', '\u44553 \u48176 \u49688  \u50948 \u52824  \u54869 \u51064 ', '', '', '\u49444 \u48708 \u54016 ', ''],\
    ['03. \uc0\u49444 \u48708 /\u48169 \u49688 ', '\u49688 \u46020 /\u48176 \u44288  \u51060 \u49444  \u48143  \u49888 \u49444 ', '\u45572 \u49688  \u50668 \u48512  \u54869 \u51064  \u54596 \u49688 ', '', '', '\u49444 \u48708 \u54016 ', ''],\
    ['03. \uc0\u49444 \u48708 /\u48169 \u49688 ', '1\u52264  \u48169 \u49688  \u44277 \u49324  (\u50529 \u52404  \u48169 \u49688 )', '\u48169 \u49688 \u52789  \u50577 \u49373  \u49345 \u53468  \u54869 \u51064 ', '', '', '\u49444 \u48708 \u54016 ', ''],\
    ['03. \uc0\u49444 \u48708 /\u48169 \u49688 ', '2\u52264  \u48169 \u49688  \u44277 \u49324  (\u46020 \u47561  \u48169 \u49688 )', '\u53076 \u45320  \u48512 \u50948  \u48372 \u44053  \u54869 \u51064 ', '', '', '\u49444 \u48708 \u54016 ', ''],\
    ['04. \uc0\u51204 \u44592  \u44277 \u49324 ', '\u48176 \u49440  \u51089 \u50629  \u48143  \u49828 \u50948 \u52824 /\u53080 \u49468 \u53944  \u50948 \u52824  \u53440 \u44277 ', '\u46020 \u47732 \u44284  \u50948 \u52824  \u51068 \u52824  \u50668 \u48512 ', '', '', '\u51204 \u44592 \u54016 ', ''],\
    ['05. \uc0\u47785 \u44277  \u44277 \u49324 ', '\u52380 \u51109 /\u44032 \u48317  \u44396 \u51312 \u53952  \u51089 \u50629 ', '\u49688 \u54217 /\u49688 \u51649  \u47112 \u48296  \u54869 \u51064 ', '', '', '\u47785 \u44277 \u54016 ', ''],\
    ['05. \uc0\u47785 \u44277  \u44277 \u49324 ', '\u46020 \u50612 /\u47928 \u53952  \u49444 \u52824  \u48143  \u47792 \u46377  \u51089 \u50629 ', '\u47928  \u44060 \u54224  \u44036 \u49453  \u54869 \u51064 ', '', '', '\u47785 \u44277 \u54016 ', ''],\
    ['06. \uc0\u53440 \u51068 /\u50837 \u49892 ', '\u48317 /\u48148 \u45797  \u53440 \u51068  \u49884 \u44277 ', '\u51460 \u45576  \u44036 \u44201  \u48143  \u54217 \u54876 \u46020 ', '', '', '\u53440 \u51068 \u54016 ', ''],\
    ['06. \uc0\u53440 \u51068 /\u50837 \u49892 ', '\u50948 \u49373 \u46020 \u44592  \u48143  \u50529 \u49464 \u49436 \u47532  \u49464 \u54021 ', '\u49444 \u52824  \u44204 \u44256 \u49457  \u54869 \u51064 ', '', '', '\u46020 \u44592 \u54016 ', ''],\
    ['07. \uc0\u46020 \u51109 /\u54596 \u47492 ', '\u54140 \u54000  \u51089 \u50629  \u48143  \u49356 \u46377 ', '\u54364 \u47732  \u54217 \u54876 \u46020  \u52404 \u53356 ', '', '', '\u46020 \u51109 \u54016 ', ''],\
    ['07. \uc0\u46020 \u51109 /\u54596 \u47492 ', '\u51064 \u53580 \u47532 \u50612  \u54596 \u47492  \u49884 \u44277 ', '\u44592 \u54252  \u48143  \u46308 \u46904  \u54869 \u51064 ', '', '', '\u54596 \u47492 \u54016 ', ''],\
    ['08. \uc0\u46020 \u48176 /\u48148 \u45797 ', '\u46020 \u48176  \u44592 \u52488  \u48143  \u51221 \u48176 ', '\u51060 \u51020 \u47588  \u49345 \u53468  \u54869 \u51064 ', '', '', '\u46020 \u48176 \u54016 ', ''],\
    ['08. \uc0\u46020 \u48176 /\u48148 \u45797 ', '\u48148 \u45797 \u51116 (\u47560 \u47336 /\u51109 \u54032 ) \u49884 \u44277 ', '\u44152 \u47112 \u48155 \u51060  \u47560 \u44048  \u54869 \u51064 ', '', '', '\u48148 \u45797 \u54016 ', ''],\
    ['09. \uc0\u44032 \u44396  \u44277 \u49324 ', '\u51452 \u48169 /\u48537 \u48149 \u51060 \u51109  \u49444 \u52824 ', '\u46020 \u50612  \u46972 \u51064  \u48143  \u49688 \u54217  \u54869 \u51064 ', '', '', '\u44032 \u44396 \u54016 ', ''],\
    ['10. \uc0\u47560 \u44048 /\u51456 \u44277 ', '\u51312 \u47749 /\u49828 \u50948 \u52824 /\u53080 \u49468 \u53944  \u49444 \u52824 ', '\u51216 \u46321  \u48143  \u51089 \u46041  \u53580 \u49828 \u53944 ', '', '', '\u51204 \u44592 \u54016 ', ''],\
    ['10. \uc0\u47560 \u44048 /\u51456 \u44277 ', '\u51077 \u51452  \u52397 \u49548  \u48143  \u48288 \u51060 \u53356 \u50500 \u50883 ', '\u44277 \u49324  \u48516 \u51652  \u51228 \u44144  \u49345 \u53468 ', '', '', '\u52397 \u49548 \u54016 ', ''],\
    ['10. \uc0\u47560 \u44048 /\u51456 \u44277 ', '\u52572 \u51333  \u51216 \u44160  \u48143  \u51064 \u49688 \u51064 \u44228 ', '\u44256 \u44061  \u52572 \u51333  \u49849 \u51064 ', '', '', '\u54788 \u51109 \u44288 \u47532 \u51088 ', '']\
];\
\
// [\uc0\u44592 \u48376  \u45936 \u51060 \u53552 ] \u44277 \u49324  \u49828 \u52992 \u51460  \u50976 \u51032 \u49324 \u54637 \
const DEFAULT_SCHEDULE_GUIDELINES = [\
    '\uc0\u44277 \u49324  \u51068 \u51221 \u51008  \u54788 \u51109  \u49345 \u54889  \u48143  \u51088 \u51116  \u49688 \u44553  \u49345 \u54889 \u50640  \u46384 \u46972  \u48320 \u46041 \u46112  \u49688  \u51080 \u49845 \u45768 \u45796 .',\
    '\uc0\u51452 \u47568  \u48143  \u44277 \u55092 \u51068 \u51008  \u49548 \u51020  \u48156 \u49373  \u44277 \u49324 \u44032  \u48520 \u44032 \u45733 \u54616 \u48064 \u47196  \u51068 \u51221  \u54801 \u51032 \u44032  \u54596 \u50836 \u54633 \u45768 \u45796 .',\
    '\uc0\u50864 \u52380  \u49884  \u50808 \u48512  \u52285 \u54840  \u53076 \u53433  \u51089 \u50629  \u46321  \u51068 \u48512  \u44277 \u51221 \u51060  \u51648 \u50672 \u46112  \u49688  \u51080 \u49845 \u45768 \u45796 .',\
    '\uc0\u52628 \u44032  \u44277 \u49324  \u50836 \u52397  \u49884  \u51204 \u52404  \u51068 \u51221 \u51060  \u50672 \u44592 \u46112  \u49688  \u51080 \u51004 \u45768  \u49324 \u51204 \u50640  \u54801 \u51032  \u48512 \u53441 \u46300 \u47549 \u45768 \u45796 .',\
    '\uc0\u51077 \u51452  \u50696 \u51221 \u51068  \u52572 \u49548  3\u51068  \u51204 \u44620 \u51648 \u45716  \u47784 \u46304  \u44277 \u49324 \u47484  \u50756 \u47308 \u54616 \u45716  \u44163 \u51012  \u47785 \u54364 \u47196  \u54633 \u45768 \u45796 .'\
];\
\
// [\uc0\u44592 \u48376  \u45936 \u51060 \u53552 ] A/S \u50976 \u51032 \u49324 \u54637 \
const DEFAULT_AS_GUIDELINES = [\
    '\uc0\u47924 \u49345  A/S \u44592 \u44036 \u51008  \u44277 \u49324  \u50756 \u47308 \u51068 \u47196 \u48512 \u53552  1\u45380 \u51077 \u45768 \u45796 .',\
    '\uc0\u49324 \u50857 \u51088 \u51032  \u48512 \u51452 \u51032 \u45208  \u44284 \u49892 \u47196  \u51064 \u54620  \u54028 \u49552 \u51008  \u50976 \u49345 \u51004 \u47196  \u52376 \u47532 \u46121 \u45768 \u45796 .',\
    '\uc0\u49548 \u47784 \u54408 (\u51204 \u44396  \u46321 ) \u44368 \u52404 \u45716  A/S \u45824 \u49345 \u50640 \u49436  \u51228 \u50808 \u46121 \u45768 \u45796 .',\
    '\uc0\u44596 \u44553 \u54620  \u45572 \u49688 \u45208  \u51204 \u44592  \u47928 \u51228 \u45716  24\u49884 \u44036  \u45236  \u48169 \u47928  \u51216 \u44160 \u51012  \u50896 \u52825 \u51004 \u47196  \u54633 \u45768 \u45796 .',\
    'A/S \uc0\u51217 \u49688  \u49884  \u54616 \u51088  \u48512 \u50948 \u51032  \u49324 \u51652 \u51012  \u54632 \u44760  \u48372 \u45236 \u51452 \u49884 \u47732  \u48736 \u47480  \u52376 \u47532 \u44032  \u44032 \u45733 \u54633 \u45768 \u45796 .'\
];\
\
// ==========================================\
// 2. Main Entry Points (doPost, doGet)\
// ==========================================\
\
/**\
 * POST \uc0\u50836 \u52397  \u53685 \u54633  \u52376 \u47532 \u44592 \
 */\
function doPost(e) \{\
    var lock = LockService.getScriptLock();\
    // \uc0\u52572 \u45824  10\u52488  \u45824 \u44592  (\u46041 \u49884 \u49457  \u51228 \u50612 )\
    if (!lock.tryLock(10000)) \{\
        return ContentService.createTextOutput(JSON.stringify(\{ result: "error", error: "Server busy" \}))\
            .setMimeType(ContentService.MimeType.JSON);\
    \}\
\
    try \{\
        var contents = e.postData.contents;\
        var payload;\
\
        // JSON \uc0\u54028 \u49905  (text/plain \u45824 \u51025 )\
        try \{\
            payload = JSON.parse(contents);\
        \} catch (error) \{\
            payload = e.parameter || \{\};\
        \}\
\
        // --- [\uc0\u46972 \u50864 \u54021  \u47196 \u51649 ] ---\
        // 1. \uc0\u50896 \u44032 \u44288 \u47532 \u54364  \u50629 \u45936 \u51060 \u53944  \u50836 \u52397  (DISABLED: Master DB\u45716  \u51069 \u44592  \u51204 \u50857 )\
        if (payload.action === 'updateCost') \{\
            return ContentService.createTextOutput(JSON.stringify(\{\
                success: false,\
                error: '\uc0\u47560 \u49828 \u53552  \u45936 \u51060 \u53552 \u48288 \u51060 \u49828 (\u50896 \u44032 \u44288 \u47532 \u54364 )\u45716  \u51060  API\u47484  \u53685 \u54644  \u49688 \u51221 \u54624  \u49688  \u50630 \u49845 \u45768 \u45796 . \u49884 \u53944 \u50640 \u49436  \u51649 \u51217  \u49688 \u51221 \u54616 \u49464 \u50836 .'\
            \})).setMimeType(ContentService.MimeType.JSON);\
        \}\
\
        // 1.5. \uc0\u49368 \u54540  \u44204 \u51201 \u49436  \u52376 \u47532 \
        if (payload.action === 'saveSampleEstimate') \{\
            return handleSaveSampleEstimate(payload);\
        \}\
        if (payload.action === 'deleteSampleEstimate') \{\
            return handleDeleteSampleEstimate(payload);\
        \}\
        if (payload.action === 'restoreCostDatabase') \{\
            return ContentService.createTextOutput(JSON.stringify(\{\
                success: false,\
                error: '\uc0\u47560 \u49828 \u53552  \u45936 \u51060 \u53552 \u48288 \u51060 \u49828  \u48373 \u44396  \u44592 \u45733 \u51060  \u48708 \u54876 \u49457 \u54868 \u46104 \u50632 \u49845 \u45768 \u45796 .'\
            \})).setMimeType(ContentService.MimeType.JSON);\
        \}\
\
        // 1.6 \uc0\u51221 \u49328  \u44288 \u47532  \u45824 \u51109  \u51200 \u51109 \
        if (payload.action === 'updateSettlement') \{\
            return handleSettlementUpdate(payload);\
        \}\
\
        // 1.7 \uc0\u50868 \u50689 \u48708  \u44288 \u47532  \u45824 \u51109  \u51200 \u51109 \
        if (payload.action === 'updateExpenses') \{\
            return handleExpensesUpdate(payload);\
        \}\
\
        // 1.8 \uc0\u51089 \u50629  \u44592 \u47197  \u51200 \u51109 \
        if (payload.action === 'logUserAction') \{\
            return handleLogUserAction(payload);\
        \}\
\
        // 1.9 \uc0\u44277 \u51221 \u48324  \u52404 \u53356 \u47532 \u49828 \u53944  \u47560 \u49828 \u53552  \u51200 \u51109  (ENABLED)\
        if (payload.action === 'updateChecklistMaster' || payload.action === 'saveChecklistMaster') \{\
            return handleChecklistMasterUpdate(payload);\
        \}\
\
        // 2. \uc0\u45432 \u49496  \u45236 \u48372 \u45236 \u44592  \u50836 \u52397  (\u48152 \u46300 \u49884  CustomerSync\u48372 \u45796  \u47676 \u51200  \u52404 \u53356 !)\
        // exportToNotion \uc0\u50836 \u52397 \u46020  customerId\u47484  \u54252 \u54632 \u54616 \u48064 \u47196 , \u47676 \u51200  \u52404 \u53356 \u54644 \u50556  \u54632 \
        if (payload.action === 'exportToNotion') \{\
            return handleNotionExport(payload);\
        \}\
\
        // 3. \uc0\u44288 \u47532 \u51088  \u45936 \u51060 \u53552  \u46041 \u44592 \u54868  \u50836 \u52397 \u51064 \u51648  \u54869 \u51064 \
        // \uc0\u51312 \u44148 : action \u54596 \u46300 \u44032  \u51080 \u44144 \u45208 , \u45936 \u51060 \u53552  \u45236 \u50640  customerId\u44032  \u51080 \u51020  (\u44288 \u47532 \u51088  \u44592 \u45733 )\
        var isAdminAction = (payload.action === 'admin' || payload.action === 'deleteAdmin');\
        var isCustomerSync = (payload.data && payload.data.customerId) || (payload.customerId);\
\
        if (isAdminAction || isCustomerSync) \{\
            // -> \uc0\u44256 \u44061 \u44288 \u47532  \u47196 \u51649  \u49892 \u54665 \
            return handleCustomerSync(payload);\
        \}\
\
        // 4. \uc0\u44536  \u50808 \u50640 \u45716  \u49345 \u45812  \u47928 \u51032  \u51217 \u49688 \u47196  \u44036 \u51452 \
        // -> \uc0\u49345 \u45812  \u51217 \u49688  \u47196 \u51649  \u49892 \u54665 \
        return handleConsultingInquiry(payload);\
\
    \} catch (err) \{\
        return ContentService.createTextOutput(JSON.stringify(\{\
            result: "error",\
            error: err.toString(),\
            stack: err.stack\
        \})).setMimeType(ContentService.MimeType.JSON);\
\
    \} finally \{\
        lock.releaseLock();\
    \}\
\}\
\
/**\
 * GET \uc0\u50836 \u52397  \u53685 \u54633  \u52376 \u47532 \u44592 \
 */\
function doGet(e) \{\
    try \{\
        var sheetParam = e.parameter.sheet; // '\uc0\u44288 \u47532 \u51088 ', '\u44256 \u44061 \u44288 \u47532 ', '\u50896 \u44032 \u44288 \u47532 \u54364 ' \u46321 \
        var actionParam = e.parameter.action; // 'getGuidelines' \uc0\u46321 \
\
        // 1. \uc0\u50896 \u44032 \u44288 \u47532 \u54364  \u45936 \u51060 \u53552  \u50836 \u52397 \
        if (sheetParam === '\uc0\u50896 \u44032 \u44288 \u47532 \u54364 ') \{\
            return handleCostGet(e);\
        \}\
\
        // 2. \uc0\u44256 \u44061 \u44288 \u47532 /\u44288 \u47532 \u51088  \u45936 \u51060 \u53552  \u50836 \u52397 \u51064  \u44221 \u50864  (\u54028 \u46972 \u48120 \u53552 \u44032  \u47749 \u49884 \u51201 \u51064  \u44221 \u50864 )\
        if (sheetParam === '\uc0\u44288 \u47532 \u51088 ' || sheetParam === '\u44256 \u44061 \u44288 \u47532 ' || sheetParam === '\u44256 \u44061 \u44288 \u47532 _\u44204 \u51201 \u49436 ' || sheetParam === '\u44228 \u50557 \u50756 \u47308 \u44256 \u44061 ' || sheetParam === '\u44228 \u50557 \u50756 \u47308 ') \{\
            return handleCustomerGet(e);\
        \}\
\
        // 2.1. A/S \uc0\u44288 \u47532  \u47532 \u49828 \u53944  \u45936 \u51060 \u53552  \u50836 \u52397 \
        if (sheetParam === 'AS\uc0\u44288 \u47532 \u47532 \u49828 \u53944 ' || sheetParam === 'as_list') \{\
            // [\uc0\u52628 \u44032 ] \u50976 \u51032 \u49324 \u54637 \u47564  \u50836 \u52397 \u54616 \u45716  \u44221 \u50864 \
            if (actionParam === 'getGuidelines') \{\
                return handleGetASGuidelines(e);\
            \}\
            return handleASListGet(e);\
        \}\
\
        // 2.2. \uc0\u44277 \u49324  \u49828 \u52992 \u51460  \u53596 \u54540 \u47551  \u50836 \u52397  [\u49688 \u51221 : \u46916 \u50612 \u50416 \u44592  \u51080 \u45716  \u48260 \u51204  \u52628 \u44032 ]\
        if (sheetParam === 'schedule_template' || sheetParam === '\uc0\u44277 \u49324 \u49828 \u52992 \u51460 \u44288 \u47532 ' || sheetParam === '\u44277 \u49324  \u49828 \u52992 \u51460  \u44288 \u47532 ' || sheetParam === '\u44277 \u49324 _\u49828 \u52992 \u51460 ') \{\
            // [\uc0\u52628 \u44032 ] \u50976 \u51032 \u49324 \u54637 \u47564  \u50836 \u52397 \u54616 \u45716  \u44221 \u50864 \
            if (actionParam === 'getGuidelines') \{\
                return handleGetScheduleGuidelines(e);\
            \}\
            return handleScheduleTemplateGet(e);\
        \}\
\
        // [\uc0\u52628 \u44032 ] \u44277 \u51221 \u48324  \u52404 \u53356 \u47532 \u49828 \u53944  \u50836 \u52397 \
        if (sheetParam === '\uc0\u44277 \u51221 \u48324 \u52404 \u53356 \u47532 \u49828 \u53944 ' || sheetParam === '\u44277 \u51221 \u48324 _\u52404 \u53356 \u47532 \u49828 \u53944 ' || sheetParam === '\u44277 \u51221 \u48324  \u52404 \u53356 \u47532 \u49828 \u53944 ' || sheetParam === 'checklist') \{\
            return handleChecklistGet(e);\
        \}\
\
\
\
        // [\uc0\u52628 \u44032 ] \u51221 \u49328  \u44288 \u47532  \u45824 \u51109  \u50741 \u49496  \u47560 \u49828 \u53552  \u51312 \u54924 \
        if (sheetParam === 'settlement' && actionParam === 'getSettlementOptions') \{\
            return handleGetSettlementOptions(e);\
        \}\
\
        // [\uc0\u52628 \u44032 ] \u51221 \u49328  \u44288 \u47532  \u45824 \u51109  \u51312 \u54924 \
        if (sheetParam === 'settlement' || sheetParam === '\uc0\u51221 \u49328 \u44288 \u47532 \u45824 \u51109 ') \{\
            return handleSettlementGet(e);\
        \}\
\
        // [\uc0\u52628 \u44032 ] \u50868 \u50689 \u48708  \u44288 \u47532  \u45824 \u51109  \u51312 \u54924 \
        if (sheetParam === 'expenses' || sheetParam === '\uc0\u50868 \u50689 \u48708 \u44288 \u47532 ') \{\
            return handleExpensesGet(e);\
        \}\
\
        // [\uc0\u52628 \u44032 ] \u51089 \u50629  \u44592 \u47197  \u51312 \u54924 \
        if (sheetParam === 'action_log' || actionParam === 'getLogs') \{\
            return handleGetActionLogs(e);\
        \}\
\
        // 2.5. \uc0\u49368 \u54540  \u44204 \u51201 \u49436  \u51312 \u54924 \
        if (actionParam === 'getSampleEstimates') \{\
            return handleGetSampleEstimates();\
        \}\
        if (actionParam === 'getSampleEstimate') \{\
            return handleGetSampleEstimate(e.parameter.id);\
        \}\
\
\
        // 2.6. Excel \uc0\u45236 \u48372 \u45236 \u44592  (\u51069 \u44592  \u51204 \u50857 )\
        if (actionParam === 'exportExcel') \{\
            return handleExcelExport(e);\
        \}\
\
        // 3. \uc0\u44536  \u50808 (\u44592 \u48376 \u44050 )\u45716  \u49345 \u45812  \u47785 \u47197  \u51312 \u54924 \u47196  \u44036 \u51452  (\u44592 \u51316  \u50937 \u49324 \u51060 \u53944  \u54840 \u54872 )\
        return handleConsultingGet(e);\
\
    \} catch (err) \{\
        return ContentService.createTextOutput(JSON.stringify(\{ error: err.toString() \}))\
            .setMimeType(ContentService.MimeType.JSON);\
    \}\
\}\
\
/**\
 * [\uc0\u52628 \u44032 ] \u49828 \u52992 \u51460  \u50976 \u51032 \u49324 \u54637 \u47564  \u48152 \u54872 \
 */\
function handleGetScheduleGuidelines(e) \{\
    try \{\
        var spreadsheet = SpreadsheetApp.openById(CUSTOMER_SHEET_ID);\
        var sheet = spreadsheet.getSheetByName('\uc0\u44277 \u49324  \u49828 \u52992 \u51460  \u44288 \u47532 ');\
\
        if (!sheet) \{\
            return ContentService.createTextOutput(JSON.stringify(\{\
                success: false,\
                error: '\uc0\u44277 \u49324  \u49828 \u52992 \u51460  \u44288 \u47532  \u49884 \u53944 \u47484  \u52286 \u51012  \u49688  \u50630 \u49845 \u45768 \u45796 .'\
            \})).setMimeType(ContentService.MimeType.JSON);\
        \}\
\
        // [\uc0\u49688 \u51221 ] \u45936 \u51060 \u53552 \u44032  \u50630 \u51004 \u47732  \u44592 \u48376 \u44050 \u51004 \u47196  \u52488 \u44592 \u54868 \
        if (sheet.getLastRow() < 2) \{\
            // AS \uc0\u50976 \u51032 \u49324 \u54637  \u52488 \u44592 \u54868  (\u54756 \u45908  \u48143  \u45936 \u51060 \u53552 )\
            // \uc0\u44036 \u45800 \u54616 \u44172  \u50976 \u51032 \u49324 \u54637  \u47532 \u49828 \u53944 \u47564  \u48152 \u54872 \
            return ContentService.createTextOutput(JSON.stringify(\{\
                success: true,\
                guidelines: DEFAULT_SCHEDULE_GUIDELINES\
            \})).setMimeType(ContentService.MimeType.JSON);\
        \}\
\
        var data = sheet.getRange(2, 1, lastRow - 1, 7).getValues();\
        var guidelines = [];\
\
        data.forEach(function (row) \{\
            // '\uc0\u44277 \u49324  \u51652 \u54665  \u50504 \u45236  \u48143  \u50976 \u51032 \u49324 \u54637 ' \u46608 \u45716  '\u44277 \u49324  \u51652 \u54665  \u50504 \u45236 \u49324 \u54637 ' \u54665  \u52286 \u44592 \
            if (row[0] && (row[0].toString().indexOf('\uc0\u44277 \u49324  \u51652 \u54665 ') !== -1 || row[0].toString().indexOf('\u50976 \u51032 \u49324 \u54637 ') !== -1)) \{\
                var text = row[1]; // B\uc0\u50676 \u50640  \u45236 \u50857 \u51060  \u51080 \u45796 \u44256  \u44032 \u51221 \
                if (text) guidelines.push(text);\
            \}\
        \});\
\
        // \uc0\u52628 \u52636 \u46108  \u50976 \u51032 \u49324 \u54637 \u51060  \u50630 \u51004 \u47732  \u44592 \u48376 \u44050  \u49324 \u50857 \
        if (guidelines.length === 0) guidelines = DEFAULT_SCHEDULE_GUIDELINES;\
\
        return ContentService.createTextOutput(JSON.stringify(\{\
            success: true,\
            guidelines: guidelines\
        \})).setMimeType(ContentService.MimeType.JSON);\
\
    \} catch (err) \{\
        return ContentService.createTextOutput(JSON.stringify(\{\
            success: false,\
            error: err.toString()\
        \})).setMimeType(ContentService.MimeType.JSON);\
    \}\
\}\
\
/**\
 * [\uc0\u52628 \u44032 ] A/S \u50976 \u51032 \u49324 \u54637 \u47564  \u48152 \u54872 \
 */\
function handleGetASGuidelines(e) \{\
    try \{\
        var spreadsheet = SpreadsheetApp.openById(CUSTOMER_SHEET_ID);\
        var sheet = spreadsheet.getSheetByName('AS \uc0\u44288 \u47532  \u47532 \u49828 \u53944 ');\
        if (!sheet) \{\
            sheet = spreadsheet.getSheetByName('AS\uc0\u44288 \u47532 \u47532 \u49828 \u53944 ');\
        \}\
        if (!sheet) \{\
            sheet = spreadsheet.getSheetByName('as_list');\
        \}\
\
        if (!sheet) \{\
            return ContentService.createTextOutput(JSON.stringify(\{\
                success: false,\
                error: 'AS \uc0\u44288 \u47532  \u47532 \u49828 \u53944  \u49884 \u53944 \u47484  \u52286 \u51012  \u49688  \u50630 \u49845 \u45768 \u45796 .'\
            \})).setMimeType(ContentService.MimeType.JSON);\
        \}\
\
        var lastRow = sheet.getLastRow();\
        if (lastRow < 2) \{\
            return ContentService.createTextOutput(JSON.stringify(\{\
                success: true,\
                guidelines: []\
            \})).setMimeType(ContentService.MimeType.JSON);\
        \}\
\
        var data = sheet.getDataRange().getValues();\
        var guidelines = [];\
\
        for (var i = 1; i < data.length; i++) \{\
            var row = data[i];\
            // 'A/S' \uc0\u46608 \u45716  '\u50976 \u51032 \u49324 \u54637 ' \u46608 \u45716  '\u50504 \u45236 ' \u53412 \u50892 \u46300 \u44032  \u51080 \u45716  \u54665  \u52286 \u44592 \
            if (row[0] && (row[0].toString().indexOf('A/S') !== -1 || row[0].toString().indexOf('\uc0\u50976 \u51032 \u49324 \u54637 ') !== -1 || row[0].toString().indexOf('\u50504 \u45236 ') !== -1)) \{\
                var text = row[1]; // B\uc0\u50676 \u50640  \u45236 \u50857 \u51060  \u51080 \u45796 \u44256  \u44032 \u51221 \
                if (text) guidelines.push(text);\
            \}\
        \}\
\
        return ContentService.createTextOutput(JSON.stringify(\{\
            success: true,\
            guidelines: guidelines\
        \})).setMimeType(ContentService.MimeType.JSON);\
\
    \} catch (err) \{\
        return ContentService.createTextOutput(JSON.stringify(\{\
            success: false,\
            error: err.toString()\
        \})).setMimeType(ContentService.MimeType.JSON);\
    \}\
\}\
\
function handleScheduleTemplateGet(e) \{\
    var spreadsheet = SpreadsheetApp.openById(CUSTOMER_SHEET_ID);\
    var sheet = spreadsheet.getSheetByName('\uc0\u44277 \u49324  \u49828 \u52992 \u51460  \u44288 \u47532 ');\
\
    // \uc0\u49884 \u53944 \u44032  \u50630 \u51004 \u47732  \u49373 \u49457 \u54616 \u44256  \u54756 \u45908  \u49444 \u51221 \
    if (!sheet) \{\
        sheet = spreadsheet.insertSheet('\uc0\u44277 \u49324  \u49828 \u52992 \u51460  \u44288 \u47532 ');\
        var headers = ['\uc0\u52852 \u53580 \u44256 \u47532 ', '\u49464 \u48512  \u44277 \u51221 \u47749 ', '\u54645 \u49900  \u52404 \u53356 \u54252 \u51064 \u53944 ', '\u49884 \u51089 \u51068 ', '\u51333 \u47308 \u51068 ', '\u45812 \u45817 \u51088 ', '\u48708 \u44256 '];\
        sheet.appendRow(headers);\
        var headerRange = sheet.getRange(1, 1, 1, headers.length);\
        headerRange.setBackground('#6d9eeb');\
        headerRange.setFontColor('#ffffff');\
        headerRange.setFontWeight('bold');\
        sheet.setFrozenRows(1);\
    \}\
\
    var lastRow = sheet.getLastRow();\
\
    // [New] \uc0\u45936 \u51060 \u53552  \u50630 \u51004 \u47732  \u44592 \u48376  \u53596 \u54540 \u47551 \u51004 \u47196  \u52488 \u44592 \u54868 \
    if (lastRow < 2) \{\
        if (DEFAULT_SCHEDULE_TEMPLATE.length > 0) \{\
            sheet.getRange(2, 1, DEFAULT_SCHEDULE_TEMPLATE.length, DEFAULT_SCHEDULE_TEMPLATE[0].length)\
                .setValues(DEFAULT_SCHEDULE_TEMPLATE);\
        \}\
        // \uc0\u52488 \u44592 \u54868  \u54980  \u45796 \u49884  \u45936 \u51060 \u53552  \u47196 \u46300 \
        lastRow = sheet.getLastRow();\
    \}\
\
    if (lastRow < 2) \{\
        return ContentService.createTextOutput(JSON.stringify([])).setMimeType(ContentService.MimeType.JSON);\
    \}\
\
    var data = sheet.getRange(2, 1, lastRow - 1, 7).getValues();\
    var steps = [];\
    var notices = [];\
\
    data.forEach(function (row) \{\
        if (row[0] === '\uc0\u44277 \u49324  \u51652 \u54665  \u50504 \u45236 \u49324 \u54637 ' || row[0] === '\u44277 \u49324  \u51652 \u54665  \u50504 \u45236  \u48143  \u50976 \u51032 \u49324 \u54637 ') \{\
            // This is a notice row. The content is likely in Column B or spanned.\
            var text = row[1];\
            if (text) notices.push(text);\
        \} else \{\
            // Normal schedule step\
            steps.push(\{\
                category: row[0] || '',\
                name: row[1] || '',\
                checkPoint: row[2] || '',\
                start: row[3] instanceof Date ? Utilities.formatDate(row[3], Session.getScriptTimeZone(), 'yyyy-MM-dd') : (row[3] || ''),\
                end: row[4] instanceof Date ? Utilities.formatDate(row[4], Session.getScriptTimeZone(), 'yyyy-MM-dd') : (row[4] || ''),\
                inCharge: row[5] || '',\
                memo: row[6] || ''\
            \});\
        \}\
    \});\
\
    return ContentService.createTextOutput(JSON.stringify(\{\
        steps: steps,\
        notices: notices\
    \})).setMimeType(ContentService.MimeType.JSON);\
\}\
\
\
// ==========================================\
// 2.5 Notion Integration Logic\
// ==========================================\
\
function handleNotionExport(payload) \{\
    try \{\
        const type = payload.type;\
        const customerId = payload.customerId;\
        const data = typeof payload.data === 'string' ? JSON.parse(payload.data) : payload.data;\
\
        let result;\
\
        if (type === 'customer') \{\
            result = exportCustomerToNotion(customerId, data);\
        \} else if (type === 'schedule') \{\
            result = exportScheduleToNotion(customerId, data);\
        \} else if (type === 'checklist') \{\
            result = exportChecklistToNotion(customerId, data);\
        \} else if (type === 'asList') \{\
            result = exportASListToNotion(customerId, data);\
        \} else if (type === 'all') \{\
            // [\uc0\u53685 \u54633  \u45236 \u48372 \u45236 \u44592 ] \u49345 \u49464  \u44208 \u44284  \u52628 \u51201 \
            const details = \{\
                customer: \{ success: false, message: '\uc0\u49892 \u54056 ' \},\
                schedule: \{ success: false, message: '\uc0\u45936 \u51060 \u53552  \u50630 \u51020 ' \},\
                checklist: \{ success: false, message: '\uc0\u45936 \u51060 \u53552  \u50630 \u51020 ' \},\
                asList: \{ success: false, message: '\uc0\u45936 \u51060 \u53552  \u50630 \u51020 ' \}\
            \};\
\
            // 1. \uc0\u44256 \u44061  \u51221 \u48372  (\u54596 \u49688 )\
            const customerData = data.customer || data;\
            try \{\
                result = exportCustomerToNotion(customerId, customerData);\
                details.customer = \{ success: true, message: '\uc0\u49457 \u44277 ' \};\
            \} catch (e) \{\
                console.error('\uc0\u44256 \u44061  \u51221 \u48372  \u45236 \u48372 \u45236 \u44592  \u49892 \u54056 :', e);\
                details.customer = \{ success: false, message: e.toString() \};\
                // \uc0\u44256 \u44061  \u51221 \u48372  \u49373 \u49457  \u49892 \u54056  \u49884 \u50640 \u46020  \u45208 \u47672 \u51648  \u51652 \u54665  \u49884 \u46020  (\u45800 , pageId \u51032 \u51316 \u49457 \u51060  \u51080 \u45796 \u47732  \u49892 \u54056 \u54624  \u49688  \u51080 \u51020 )\
            \}\
\
            // 2. \uc0\u49828 \u52992 \u51460 \
            if (data.schedule) \{\
                Utilities.sleep(300); // \uc0\u46364 \u47112 \u51060  \u45800 \u52629 \
                try \{\
                    exportScheduleToNotion(customerId, data.schedule);\
                    details.schedule = \{ success: true, message: '\uc0\u49457 \u44277 ' \};\
                \} catch (e) \{\
                    console.error('\uc0\u49828 \u52992 \u51460  \u45236 \u48372 \u45236 \u44592  \u49892 \u54056 :', e);\
                    details.schedule = \{ success: false, message: e.toString() \};\
                \}\
            \}\
\
            // 3. \uc0\u52404 \u53356 \u47532 \u49828 \u53944 \
            if (data.checklist) \{\
                Utilities.sleep(300);\
                try \{\
                    exportChecklistToNotion(customerId, data.checklist);\
                    details.checklist = \{ success: true, message: '\uc0\u49457 \u44277 ' \};\
                \} catch (e) \{\
                    console.error('\uc0\u52404 \u53356 \u47532 \u49828 \u53944  \u45236 \u48372 \u45236 \u44592  \u49892 \u54056 :', e);\
                    details.checklist = \{ success: false, message: e.toString() \};\
                \}\
            \}\
\
            // 4. A/S \uc0\u47532 \u49828 \u53944 \
            if (data.asList) \{\
                Utilities.sleep(300);\
                try \{\
                    exportASListToNotion(customerId, data.asList);\
                    details.asList = \{ success: true, message: '\uc0\u49457 \u44277 ' \};\
                \} catch (e) \{\
                    console.error('A/S \uc0\u47532 \u49828 \u53944  \u45236 \u48372 \u45236 \u44592  \u49892 \u54056 :', e);\
                    details.asList = \{ success: false, message: e.toString() \};\
                \}\
            \}\
\
            // \uc0\u52572 \u51333  \u51025 \u45813 \u50640  details \u54252 \u54632 \
            return ContentService.createTextOutput(JSON.stringify(\{\
                success: true,\
                notionUrl: result ? result.url : null,\
                details: details,\
                message: '\uc0\u53685 \u54633  \u45236 \u48372 \u45236 \u44592  \u50756 \u47308 '\
            \})).setMimeType(ContentService.MimeType.JSON);\
\
        \} else \{\
            throw new Error('\uc0\u51648 \u50896 \u54616 \u51648  \u50506 \u45716  \u45236 \u48372 \u45236 \u44592  \u50976 \u54805 \u51077 \u45768 \u45796 : ' + type);\
        \}\
\
        return ContentService.createTextOutput(JSON.stringify(\{\
            success: true,\
            notionUrl: result ? result.url : null,\
            message: '\uc0\u49457 \u44277 \u51201 \u51004 \u47196  \u45236 \u48372 \u45256 \u49845 \u45768 \u45796 .'\
        \})).setMimeType(ContentService.MimeType.JSON);\
\
    \} catch (e) \{\
        return ContentService.createTextOutput(JSON.stringify(\{\
            success: false,\
            message: e.toString(),\
            stack: e.stack\
        \})).setMimeType(ContentService.MimeType.JSON);\
    \}\
\}\
\
// Notion API \uc0\u54840 \u52636  \u54764 \u54140 \
function callNotionAPI(endpoint, method, payload) \{\
    const url = 'https://api.notion.com/v1' + endpoint;\
    const options = \{\
        method: method,\
        headers: \{\
            'Authorization': 'Bearer ' + getNotionApiKey(),\
            'Content-Type': 'application/json',\
            'Notion-Version': '2022-06-28'\
        \},\
        payload: payload ? JSON.stringify(payload) : null,\
        muteHttpExceptions: true\
    \};\
\
    const response = UrlFetchApp.fetch(url, options);\
    const responseCode = response.getResponseCode();\
    const responseBody = response.getContentText();\
\
    if (responseCode >= 400) \{\
        throw new Error('Notion API Error (' + responseCode + '): ' + responseBody);\
    \}\
\
    return JSON.parse(responseBody);\
\}\
\
// 1. Notion Page ID \uc0\u52286 \u44592  (\u44277 \u53685  \u54764 \u54140 )\
function findCustomerPageId(customerId) \{\
    const dbId = NOTION_DB_IDS.PROJECTS;\
    try \{\
        const response = callNotionAPI('/databases/' + dbId + '/query', 'POST', \{\
            filter: \{\
                property: '\uc0\u44256 \u44061 ID',\
                rich_text: \{ equals: customerId \}\
            \}\
        \});\
        if (response.results && response.results.length > 0) \{\
            return response.results[0].id;\
        \}\
        return null; // \uc0\u50630 \u51020 \
    \} catch (e) \{\
        console.error('findCustomerPageId Error: ' + e.toString());\
        return null;\
    \}\
\}\
\
// 1. \uc0\u44256 \u44061  \u51221 \u48372  \u45236 \u48372 \u45236 \u44592 \
function exportCustomerToNotion(customerId, data) \{\
    // \uc0\u46356 \u48260 \u44613  \u47196 \u44536 \
    console.log('\uc0\u55357 \u56548  Notion Export - Customer ID:', customerId);\
    console.log('\uc0\u55357 \u56548  Notion Export - Data:', JSON.stringify(data));\
\
    if (!customerId) throw new Error('Customer ID is missing');\
\
    // PropertiesService\uc0\u50640 \u49436  API Key \u54869 \u51064 \
    const apiKey = getNotionApiKey();\
    if (!apiKey) throw new Error('Notion API Key\uc0\u44032  \u49444 \u51221 \u46104 \u51648  \u50506 \u50520 \u49845 \u45768 \u45796 .');\
\
    // DB ID \uc0\u54869 \u51064 \
    const dbId = NOTION_DB_IDS.PROJECTS;\
    if (!dbId) throw new Error('Notion Project Database ID not configured.');\
\
    // 1. \uc0\u44592 \u51316  \u54168 \u51060 \u51648  \u44160 \u49353 \
    let pageId = findCustomerPageId(customerId);\
    let notionUrl;\
\
    // 2. \uc0\u49549 \u49457  \u47588 \u54609 \
    const totalAmount = data['\uc0\u52509  \u44228 \u50557 \u44552 \u50529 '] ? Number(String(data['\u52509  \u44228 \u50557 \u44552 \u50529 ']).replace(/[^0-9]/g, '')) : 0;\
    const area = data['\uc0\u54217 \u49688 '] ? Number(String(data['\u54217 \u49688 ']).replace(/[^0-9.]/g, '')) : 0;\
\
    // \uc0\u54788 \u51109 \u47749  \u49373 \u49457 : \u49457 \u47749 &\u48176 \u50864 \u51088  \u49457 \u47749 _\u44256 \u44061 ID \u54805 \u49885 \
    const clientName = data['\uc0\u49457 \u47749 '] || '';\
    const spouseName = data['\uc0\u48176 \u50864 \u51088  \u49457 \u47749 '] || '';\
    let siteTitle = clientName;\
    if (spouseName) \{\
        siteTitle += '\uc0\u9829 \u65039 ' + spouseName;\
    \}\
    siteTitle += '_' + customerId;\
\
    const properties = \{\
        '\uc0\u54788 \u51109 \u47749 ': \{ title: [\{ text: \{ content: siteTitle \} \}] \},\
        '\uc0\u49457 \u47749 ': \{ rich_text: [\{ text: \{ content: data['\u49457 \u47749 '] || '' \} \}] \},\
        '\uc0\u51060 \u47700 \u51068 ': \{ email: data['\u51060 \u47700 \u51068 '] || null \},\
        '\uc0\u51452 \u49548 ': \{ rich_text: [\{ text: \{ content: data['\u51452 \u49548 '] || '' \} \}] \},\
        '\uc0\u54788 \u51109 \u51452 \u49548 ': \{ rich_text: [\{ text: \{ content: data['\u54788 \u51109 \u51452 \u49548 '] || '' \} \}] \},\
        '\uc0\u48176 \u50864 \u51088  \u49457 \u47749 ': \{ rich_text: [\{ text: \{ content: data['\u48176 \u50864 \u51088  \u49457 \u47749 '] || '' \} \}] \},\
        '\uc0\u44277 \u49324  \u45812 \u45817 \u51088 ': \{ rich_text: [\{ text: \{ content: data['\u44277 \u49324  \u45812 \u45817 \u51088 '] || '' \} \}] \},\
        '\uc0\u44148 \u47932 \u50976 \u54805 ': \{ rich_text: [\{ text: \{ content: data['\u44148 \u47932 \u50976 \u54805 '] || '' \} \}] \},\
        '\uc0\u50976 \u51077 \u44221 \u47196 ': \{ rich_text: [\{ text: \{ content: data['\u50976 \u51077 \u44221 \u47196 '] || '' \} \}] \},\
        '\uc0\u44256 \u44061  \u50836 \u52397 \u49324 \u54637 ': \{ rich_text: [\{ text: \{ content: data['\u44256 \u44061  \u50836 \u52397 \u49324 \u54637 '] || '' \} \}] \},\
        '\uc0\u45236 \u48512  \u47700 \u47784 ': \{ rich_text: [\{ text: \{ content: data['\u45236 \u48512  \u47700 \u47784 '] || '' \} \}] \},\
        '\uc0\u53945 \u50557 \u49324 \u54637 ': \{ rich_text: [\{ text: \{ content: data['\u53945 \u50557 \u49324 \u54637 '] || '' \} \}] \},\
        // '\uc0\u44277 \u49324  \u50976 \u51032 \u49324 \u54637 ': \{ rich_text: [\{ text: \{ content: data['\u44277 \u49324  \u50976 \u51032 \u49324 \u54637 '] || '' \} \}] \}, // \u45432 \u49496 \u50640  \u52972 \u47100  \u50630 \u51020 \
        // 'A/S \uc0\u50976 \u51032 \u49324 \u54637 ': \{ rich_text: [\{ text: \{ content: data['A/S \u50976 \u51032 \u49324 \u54637 '] || '' \} \}] \}, // \u45432 \u49496 \u50640  \u52972 \u47100  \u50630 \u51020 \
        '\uc0\u44256 \u44061 ID': \{ rich_text: [\{ text: \{ content: customerId || '' \} \}] \},\
        '\uc0\u52509  \u44228 \u50557 \u44552 \u50529  (VAT \u54252 \u54632 )': \{ number: totalAmount \},\
        '\uc0\u54217 \u49688 ': \{ number: area \}\
    \};\
\
    // \uc0\u50672 \u46973 \u52376  (\u44050 \u51060  \u51080 \u51012  \u46412 \u47564  \u54252 \u54632 )\
    if (data['\uc0\u50672 \u46973 \u52376 ']) \{\
        properties['\uc0\u50672 \u46973 \u52376 '] = \{ phone_number: data['\u50672 \u46973 \u52376 '] \};\
    \}\
    // \uc0\u48176 \u50864 \u51088  \u50672 \u46973 \u52376  (\u44050 \u51060  \u51080 \u51012  \u46412 \u47564  \u54252 \u54632 )\
    if (data['\uc0\u48176 \u50864 \u51088  \u50672 \u46973 \u52376 ']) \{\
        properties['\uc0\u48176 \u50864 \u51088  \u50672 \u46973 \u52376 '] = \{ phone_number: data['\u48176 \u50864 \u51088  \u50672 \u46973 \u52376 '] \};\
    \}\
\
    // \uc0\u45216 \u51676  \u54596 \u46300  (\u44277 \u48177 \u51068  \u44221 \u50864  \u51228 \u50808 ) - 'A/S \u44592 \u44036 ' \u54252 \u54632 \
    ['\uc0\u51060 \u49324 \u45216 \u51676 ', '\u44228 \u50557 \u51068 ', '\u52265 \u44277 \u51068 ', '\u51456 \u44277 \u51068 ', '\u51092 \u44552 \u51068 ', 'A/S \u44592 \u44036 '].forEach(field => \{\
        if (data[field] && data[field].match(/^\\d\{4\}-\\d\{2\}-\\d\{2\}/)) \{\
            properties[field] = \{ date: \{ start: data[field] \} \};\
        \}\
    \});\
\
    if (pageId) \{\
        // [\uc0\u50629 \u45936 \u51060 \u53944 ]\
        const response = callNotionAPI('/pages/' + pageId, 'PATCH', \{ properties: properties \});\
        notionUrl = response.url;\
    \} else \{\
        // [\uc0\u49373 \u49457 ] - \u52964 \u48260  \u51060 \u48120 \u51648  \u54252 \u54632 \
        const response = callNotionAPI('/pages', 'POST', \{\
            parent: \{ database_id: dbId \},\
            properties: properties,\
            cover: \{\
                type: 'external',\
                external: \{\
                    url: NOTION_COVER_IMAGE\
                \}\
            \}\
        \});\
        pageId = response.id;\
        notionUrl = response.url;\
    \}\
\
    // [\uc0\u52628 \u44032 ] \u54168 \u51060 \u51648  \u48376 \u47928 \u50640  \u53080 \u53584 \u52768  \u52628 \u44032 \
    const pageBlocks = [];\
\
    // 1. \uc0\u55357 \u56517  \u44277 \u49324  \u49828 \u52992 \u51460  \u49465 \u49496 \
    if (NOTION_DB_IDS.SCHEDULE) \{\
        pageBlocks.push(\{\
            object: 'block',\
            type: 'heading_2',\
            heading_2: \{\
                rich_text: [\{ type: 'text', text: \{ content: '\uc0\u55357 \u56517  \u44277 \u49324  \u49828 \u52992 \u51460 ' \} \}]\
            \}\
        \});\
\
        // \uc0\u44277 \u49324  \u50976 \u51032 \u49324 \u54637  \u49325 \u51228 \u46120  (\u49324 \u50857 \u51088  \u50836 \u52397 )\
        /*\
        if (data['\uc0\u44277 \u49324  \u50976 \u51032 \u49324 \u54637 '] && data['\u44277 \u49324  \u50976 \u51032 \u49324 \u54637 '].trim()) \{\
            pageBlocks.push(\{\
                object: 'block',\
                type: 'callout',\
                callout: \{\
                    rich_text: [\{ type: 'text', text: \{ content: '\uc0\u55357 \u56481  \u44277 \u49324  \u51652 \u54665  \u50504 \u45236  \u48143  \u50976 \u51032 \u49324 \u54637 ' \} \}],\
                    icon: \{ emoji: '\uc0\u55357 \u56481 ' \},\
                    color: 'yellow_background'\
                \}\
            \});\
\
            const constructionItems = data['\uc0\u44277 \u49324  \u50976 \u51032 \u49324 \u54637 '].split('\\n').filter(item => item.trim());\
            constructionItems.forEach(item => \{\
                pageBlocks.push(\{\
                    object: 'block',\
                    type: 'bulleted_list_item',\
                    bulleted_list_item: \{\
                        rich_text: [\{ type: 'text', text: \{ content: item.trim() \} \}]\
                    \}\
                \});\
            \});\
        \}\
        */\
\
        pageBlocks.push(\{\
            object: 'block',\
            type: 'linked_to_page',\
            linked_to_page: \{\
                type: 'database_id',\
                database_id: NOTION_DB_IDS.SCHEDULE\
            \}\
        \});\
    \}\
\
    // 2. \uc0\u9989  \u44277 \u51221 \u48324  \u52404 \u53356 \u47532 \u49828 \u53944  \u49465 \u49496 \
    if (NOTION_DB_IDS.CHECKLIST) \{\
        pageBlocks.push(\{\
            object: 'block',\
            type: 'heading_2',\
            heading_2: \{\
                rich_text: [\{ type: 'text', text: \{ content: '\uc0\u9989  \u44277 \u51221 \u48324  \u52404 \u53356 \u47532 \u49828 \u53944 ' \} \}]\
            \}\
        \});\
        pageBlocks.push(\{\
            object: 'block',\
            type: 'linked_to_page',\
            linked_to_page: \{\
                type: 'database_id',\
                database_id: NOTION_DB_IDS.CHECKLIST\
            \}\
        \});\
    \}\
\
    // 3. \uc0\u55357 \u56615  A/S \u44288 \u47532  \u47532 \u49828 \u53944  \u49465 \u49496 \
    if (NOTION_DB_IDS.AS_LIST) \{\
        pageBlocks.push(\{\
            object: 'block',\
            type: 'heading_2',\
            heading_2: \{\
                rich_text: [\{ type: 'text', text: \{ content: ' A/S \uc0\u44288 \u47532  \u47532 \u49828 \u53944 ' \} \}]\
            \}\
        \});\
\
        // A/S \uc0\u50976 \u51032 \u49324 \u54637  (A/S \u47532 \u49828 \u53944  \u49345 \u45800 \u50640  \u48176 \u52824 )\
        if (data['A/S \uc0\u50976 \u51032 \u49324 \u54637 '] && data['A/S \u50976 \u51032 \u49324 \u54637 '].trim()) \{\
            pageBlocks.push(\{\
                object: 'block',\
                type: 'callout',\
                callout: \{\
                    rich_text: [\{ type: 'text', text: \{ content: '\uc0\u55357 \u56481  A/S(\u49324 \u54980 \u44288 \u47532 ) \u50504 \u45236  \u48143  \u50976 \u51032 \u49324 \u54637 ' \} \}],\
                    icon: \{ emoji: '\uc0\u55357 \u56481 ' \},\
                    color: 'blue_background'\
                \}\
            \});\
\
            const asItems = data['A/S \uc0\u50976 \u51032 \u49324 \u54637 '].split('\\n').filter(item => item.trim());\
            asItems.forEach(item => \{\
                pageBlocks.push(\{\
                    object: 'block',\
                    type: 'bulleted_list_item',\
                    bulleted_list_item: \{\
                        rich_text: [\{ type: 'text', text: \{ content: item.trim() \} \}]\
                    \}\
                \});\
            \});\
        \}\
\
        pageBlocks.push(\{\
            object: 'block',\
            type: 'linked_to_page',\
            linked_to_page: \{\
                type: 'database_id',\
                database_id: NOTION_DB_IDS.AS_LIST\
            \}\
        \});\
    \}\
\
    // 4. \uc0\u55357 \u56538  \u44256 \u44061  \u50504 \u45236 \'b7FAQ \u49465 \u49496 \
    if (NOTION_DB_IDS.FAQ) \{\
        pageBlocks.push(\{\
            object: 'block',\
            type: 'heading_2',\
            heading_2: \{\
                rich_text: [\{ type: 'text', text: \{ content: ' \uc0\u44256 \u44061  \u50504 \u45236 \'b7FAQ' \} \}]\
            \}\
        \});\
        pageBlocks.push(\{\
            object: 'block',\
            type: 'linked_to_page',\
            linked_to_page: \{\
                type: 'database_id',\
                database_id: NOTION_DB_IDS.FAQ\
            \}\
        \});\
    \}\
\
    // 5. \uc0\u44396 \u48516 \u49440  \u52628 \u44032 \
    pageBlocks.push(\{\
        object: 'block',\
        type: 'divider',\
        divider: \{\}\
    \});\
\
    // \uc0\u54168 \u51060 \u51648  \u48376 \u47928 \u50640  \u48660 \u47197  \u52628 \u44032 \
    if (pageBlocks.length > 0) \{\
        try \{\
            callNotionAPI('/blocks/' + pageId + '/children', 'PATCH', \{\
                children: pageBlocks\
            \});\
        \} catch (e) \{\
            console.warn('\uc0\u54168 \u51060 \u51648  \u48376 \u47928  \u52628 \u44032  \u49892 \u54056 :', e.toString());\
        \}\
    \}\
\
    // \uc0\u47564 \u50557  Schedule/Checklist \u45936 \u51060 \u53552 \u44032  \u44057 \u51060  \u45336 \u50612 \u50772 \u45796 \u47732  \u50672 \u44208  \u52376 \u47532  (\u49440 \u53469 \u49324 \u54637 )\
    if (data.scheduleRows && data.scheduleRows.length > 0) \{\
        exportScheduleToNotion(customerId, data);\
    \}\
    if (data.checklist && data.checklist.length > 0) \{\
        exportChecklistToNotion(customerId, data);\
    \}\
\
    return \{ url: notionUrl, pageId: pageId \};\
\}\
\
// 3. \uc0\u49828 \u52992 \u51460  \u45236 \u48372 \u45236 \u44592  (\u44288 \u44228 \u54805  DB \u50672 \u44208  + \u44256 \u44061 ID)\
function exportScheduleToNotion(customerId, data) \{\
    const pageId = findCustomerPageId(customerId);\
    if (!pageId) throw new Error('\uc0\u44256 \u44061  \u54168 \u51060 \u51648 \u47484  \u52286 \u51012  \u49688  \u50630 \u49845 \u45768 \u45796 . \u47676 \u51200  \u44256 \u44061  \u51221 \u48372 \u47484  \u45236 \u48372 \u45236 \u51452 \u49464 \u50836 .');\
\
    const dbId = NOTION_DB_IDS.SCHEDULE;\
    if (!dbId) throw new Error('Notion Schedule Database ID not configured.');\
\
    // 1. \uc0\u44592 \u51316  \u54644 \u45817  \u54532 \u47196 \u51229 \u53944 \u51032  \u49828 \u52992 \u51460  \u54637 \u47785  \u49325 \u51228  (\u44256 \u44061 ID \u44592 \u51456 )\
    deleteExistingRelatedPages(dbId, customerId, pageId);\
\
    const scheduleRows = data.scheduleRows || data.\uc0\u44277 \u51221 \u47785 \u47197  || [];\
    let count = 0;\
\
    scheduleRows.forEach((row, index) => \{\
        const process = row.process || row.\uc0\u44277 \u51221  || row.\u44277 \u51221 \u47749  || '\u44277 \u51221 ';\
        const start = row.startDate || row.\uc0\u49884 \u51089 \u51068  || '';\
        const end = row.endDate || row.\uc0\u51333 \u47308 \u51068  || '';\
        const manager = row.manager || row.\uc0\u45812 \u45817 \u51088  || '';\
        const memo = row.memo || row.\uc0\u48708 \u44256  || '';\
\
        const props = \{\
            '\uc0\u44277 \u51221 \u47749 ': \{ title: [\{ text: \{ content: process \} \}] \},\
            '\uc0\u45812 \u45817 \u51088 ': \{ rich_text: [\{ text: \{ content: manager \} \}] \},\
            '\uc0\u48708 \u44256 ': \{ rich_text: [\{ text: \{ content: memo \} \}] \},\
            '\uc0\u44256 \u44061 ID': \{ rich_text: [\{ text: \{ content: customerId \} \}] \},\
            'NO': \{ number: index + 1 \}, // [\uc0\u52628 \u44032 ] NO \u49549 \u49457 \
            '\uc0\u44256 \u44061 \u51221 \u48372 ': \{ relation: [\{ id: pageId \}] \} // [\u49688 \u51221 ] \u52972 \u47100 \u47749  '\u54532 \u47196 \u51229 \u53944 ' -> '\u44256 \u44061 \u51221 \u48372 '\
        \};\
\
        if (start) \{\
            // \uc0\u51333 \u47308 \u51068 \u51060  \u50630 \u44144 \u45208  \u49884 \u51089 \u51068 \u44284  \u44057 \u51004 \u47732  start\u47564 , \u45796 \u47476 \u47732  end \u54252 \u54632  (\u45800 , \u45432 \u49496 \u51008  end\u44032  start\u48372 \u45796  \u52964 \u50556  \u54632 )\
            const dateObj = \{ start: start \};\
            if (end && end !== start) \{\
                dateObj.end = end;\
            \}\
            props['\uc0\u49884 \u51089 -\u51333 \u47308 '] = \{ date: dateObj \}; // [\u49688 \u51221 ] \u49828 \u53356 \u47536 \u49399  \u44592 \u51456  '\u49884 \u51089 -\u51333 \u47308 '\u47196  \u48320 \u44221 \
        \}\
\
        callNotionAPI('/pages', 'POST', \{\
            parent: \{ database_id: dbId \},\
            properties: props\
        \});\
        count++;\
    \});\
\
    // [\uc0\u49325 \u51228 ] \u44256 \u44061  \u54168 \u51060 \u51648 \u50640  \u44277 \u49324  \u51652 \u54665  \u50504 \u45236  \u48143  \u50976 \u51032 \u49324 \u54637  \u53084 \u50500 \u50883  \u52628 \u44032  (\u49324 \u50857 \u51088  \u50836 \u52397 )\
    /*\
    try \{\
        const guidelines = data.guidelines || data.\uc0\u50976 \u51032 \u49324 \u54637  || [];\
        if (guidelines.length > 0) \{\
            const calloutContent = guidelines.map(g => (\{\
                type: 'paragraph',\
                paragraph: \{\
                    rich_text: [\{ type: 'text', text: \{ content: '\'95 ' + g \} \}]\
                \}\
            \}));\
\
            callNotionAPI('/blocks/' + pageId + '/children', 'PATCH', \{\
                children: [\
                    \{\
                        type: 'callout',\
                        callout: \{\
                            icon: \{ type: 'emoji', emoji: '\uc0\u55357 \u56481 ' \},\
                            color: 'yellow_background',\
                            rich_text: [\{ type: 'text', text: \{ content: '\uc0\u44277 \u49324  \u51652 \u54665  \u50504 \u45236  \u48143  \u50976 \u51032 \u49324 \u54637 ' \} \}],\
                            children: calloutContent\
                        \}\
                    \}\
                ]\
            \});\
        \}\
    \} catch (e) \{\
        console.warn('\uc0\u50976 \u51032 \u49324 \u54637  \u53084 \u50500 \u50883  \u52628 \u44032  \u49892 \u54056 :', e.toString());\
    \}\
    */\
\
    return \{ url: '', count: count \};\
\}\
\
// 4. \uc0\u52404 \u53356 \u47532 \u49828 \u53944  \u45236 \u48372 \u45236 \u44592  (\u44288 \u44228 \u54805  DB \u50672 \u44208  + \u44256 \u44061 ID)\
function exportChecklistToNotion(customerId, data) \{\
    const pageId = findCustomerPageId(customerId);\
    if (!pageId) throw new Error('\uc0\u44256 \u44061  \u54168 \u51060 \u51648 \u47484  \u52286 \u51012  \u49688  \u50630 \u49845 \u45768 \u45796 . \u47676 \u51200  \u44256 \u44061  \u51221 \u48372 \u47484  \u45236 \u48372 \u45236 \u51452 \u49464 \u50836 .');\
\
    const dbId = NOTION_DB_IDS.CHECKLIST;\
    if (!dbId) throw new Error('Notion Checklist Database ID not configured.');\
\
    // 1. \uc0\u44592 \u51316  \u54637 \u47785  \u49325 \u51228  (\u44256 \u44061 \u51221 \u48372  Relation \u44592 \u51456 )\
    deleteExistingRelatedPages(dbId, customerId, pageId);\
\
    // [\uc0\u49688 \u51221 ] \u52404 \u53356 \u47532 \u49828 \u53944  \u49692 \u49436 \
    const checklist = (data.checklist || data.\uc0\u52404 \u53356 \u47532 \u49828 \u53944  || []).slice().reverse();\
    let count = 0;\
\
    checklist.forEach(item => \{\
        const title = item.\uc0\u54637 \u47785  || item.content || '\u52404 \u53356 \u47532 \u49828 \u53944  \u54637 \u47785 ';\
        const category = item.\uc0\u52852 \u53580 \u44256 \u47532  || item.category || item.\u48516 \u47448  || '\u44592 \u53440 ';\
        const detail = item.\uc0\u45236 \u50857  || '';\
        const stage = item.\uc0\u51652 \u54665 \u45800 \u44228  || '';\
        const note = item.\uc0\u48708 \u44256  || '';\
        const isChecked = item.isChecked === true;\
        const no = parseInt(item.\uc0\u48264 \u54840 ) || 0;\
\
        // \uc0\u45432 \u49496  DB \u49549 \u49457 \u50640  \u47582 \u52656  \u49688 \u51221 \
        const props = \{\
            '\uc0\u54637 \u47785 ': \{ title: [\{ text: \{ content: title \} \}] \},\
            '\uc0\u52852 \u53580 \u44256 \u47532 ': \{ rich_text: [\{ text: \{ content: category \} \}] \},\
            '\uc0\u45236 \u50857 ': \{ rich_text: [\{ text: \{ content: detail \} \}] \},\
            '\uc0\u51652 \u54665 \u45800 \u44228 ': \{ rich_text: [\{ text: \{ content: stage \} \}] \},\
            '\uc0\u48708 \u44256 ': \{ rich_text: [\{ text: \{ content: note \} \}] \},\
            '\uc0\u50756 \u47308 ': \{ checkbox: isChecked \}, // [\u49688 \u51221 ] \u45432 \u49496  \u49549 \u49457 \u47749  '\u50756 \u47308 '\
            'NO': \{ number: no \},\
            '\uc0\u44256 \u44061 \u51221 \u48372 ': \{ relation: [\{ id: pageId \}] \}\
        \};\
\
        callNotionAPI('/pages', 'POST', \{\
            parent: \{ database_id: dbId \},\
            properties: props\
        \});\
        count++;\
    \});\
\
    return \{ url: '', count: count \};\
\}\
\
// [\uc0\u54764 \u54140 ] \u44288 \u47144  \u54168 \u51060 \u51648  \u49325 \u51228  (\u44256 \u44061 \u51221 \u48372  Relation \u44592 \u51456  \u54596 \u53552 \u47553  \u48143  \u51204 \u52404  \u49325 \u51228 )\
function deleteExistingRelatedPages(dbId, customerId, pageId) \{\
    try \{\
        const filter = pageId ? \{\
            property: '\uc0\u44256 \u44061 \u51221 \u48372 ',\
            relation: \{ contains: pageId \}\
        \} : \{\
            property: '\uc0\u44256 \u44061 ID', // fallback\
            rich_text: \{ equals: customerId \}\
        \};\
\
        let hasMore = true;\
        let startCursor = undefined;\
\
        while (hasMore) \{\
            const payload = \{\
                filter: filter,\
                page_size: 100\
            \};\
            if (startCursor) \{\
                payload.start_cursor = startCursor;\
            \}\
\
            const response = callNotionAPI('/databases/' + dbId + '/query', 'POST', payload);\
\
            if (response.results && response.results.length > 0) \{\
                // \uc0\u48337 \u47148  \u52376 \u47532 \u45716  \u50504 \u46104 \u51648 \u47564  \u49692 \u52264 \u51201 \u51004 \u47196  \u49325 \u51228 \
                response.results.forEach(page => \{\
                    try \{\
                        callNotionAPI('/blocks/' + page.id, 'DELETE', \{\}); // \uc0\u54168 \u51060 \u51648  \u49325 \u51228 (Archive)\
                    \} catch (delErr) \{\
                        console.warn('\uc0\u54168 \u51060 \u51648  \u49325 \u51228  \u51473  \u50724 \u47448 (\u47924 \u49884 \u54632 ): ' + page.id, delErr);\
                    \}\
                \});\
            \}\
\
            hasMore = response.has_more;\
            startCursor = response.next_cursor;\
        \}\
    \} catch (e) \{\
        console.warn('\uc0\u44592 \u51316  \u54637 \u47785  \u49325 \u51228  \u49892 \u54056  (DB \u49549 \u49457  \u54869 \u51064  \u54596 \u50836 ): ' + e.toString());\
    \}\
\}\
\
// 5. A/S \uc0\u44288 \u47532  \u47532 \u49828 \u53944  \u45236 \u48372 \u45236 \u44592  (\u44288 \u44228 \u54805  DB \u50672 \u44208  + \u44256 \u44061 ID)\
function exportASListToNotion(customerId, data) \{\
    const pageId = findCustomerPageId(customerId);\
    if (!pageId) throw new Error('\uc0\u44256 \u44061  \u54168 \u51060 \u51648 \u47484  \u52286 \u51012  \u49688  \u50630 \u49845 \u45768 \u45796 . \u47676 \u51200  \u44256 \u44061  \u51221 \u48372 \u47484  \u45236 \u48372 \u45236 \u51452 \u49464 \u50836 .');\
\
    const dbId = NOTION_DB_IDS.AS_LIST;\
    if (!dbId) throw new Error('Notion A/S List Database ID not configured.');\
\
    // 1) \uc0\u44256 \u44061  \u51221 \u48372  \u54168 \u51060 \u51648  \u49549 \u49457  \u50629 \u45936 \u51060 \u53944  (\u51092 \u44552 \u51068 , \u48372 \u51613 \u44592 \u44036  \u46321 )\
    // \uc0\u49345 \u45800  A/S \u51221 \u48372  \u53580 \u51060 \u48660 \u51032  \u45936 \u51060 \u53552 \u44032  \u48320 \u44221 \u46104 \u50632 \u51012  \u49688  \u51080 \u51004 \u48064 \u47196  \u50629 \u45936 \u51060 \u53944 \
    const customerProps = \{\};\
    if (data.balanceDate) \{\
        customerProps['\uc0\u51092 \u44552 \u51068 '] = \{ date: \{ start: data.balanceDate \} \};\
    \}\
    if (data.leakWarranty) \{\
        // \uc0\u54868 \u51109 \u49892  \u45572 \u49688  \u48372 \u51613  \u44592 \u44036 \u51012  \u53581 \u49828 \u53944 \u45208  \u45216 \u51676 \u47196  \u51200 \u51109 \
        customerProps['\uc0\u54868 \u51109 \u49892  \u45572 \u49688  \u48372 \u51613  \u44592 \u44036 '] = \{ rich_text: [\{ text: \{ content: data.leakWarranty \} \}] \};\
    \}\
    // A/S \uc0\u44592 \u44036  \u46321 \u46020  \u54596 \u50836 \u54616 \u45796 \u47732  \u50629 \u45936 \u51060 \u53944 \
\
    if (Object.keys(customerProps).length > 0) \{\
        try \{\
            callNotionAPI('/pages/' + pageId, 'PATCH', \{ properties: customerProps \});\
        \} catch (e) \{\
            console.warn('\uc0\u44256 \u44061  \u54168 \u51060 \u51648  \u49549 \u49457  \u50629 \u45936 \u51060 \u53944  \u49892 \u54056 (\u49549 \u49457 \u47749  \u54869 \u51064  \u54596 \u50836 ): ' + e.toString());\
        \}\
    \}\
\
    // 2) \uc0\u44592 \u51316  A/S \u47532 \u49828 \u53944  \u54637 \u47785  \u49325 \u51228  (\u44256 \u44061 ID \u44592 \u51456 )\
    deleteExistingRelatedPages(dbId, customerId, pageId);\
\
    // 3) \uc0\u49352 \u47196 \u50868  A/S \u54637 \u47785  \u52628 \u44032 \
    const asList = data.items || [];\
    let count = 0;\
\
    // \uc0\u45216 \u51676  \u54252 \u47607  \u48320 \u54872  \u54764 \u54140  \u54632 \u49688  (~27.01.08 -> 2027-01-08)\
    function parseWarrantyDate(dateStr) \{\
        if (!dateStr) return null;\
        try \{\
            // \uc0\u49707 \u51088 \u50752  \u51216 (.)\u47564  \u45224 \u44592 \u44256  \u45208 \u47672 \u51648  \u51228 \u44144  (\u50696 : ~27.01.08 -> 27.01.08)\
            const cleanStr = dateStr.replace(/[^0-9.]/g, "");\
            const parts = cleanStr.split('.');\
            if (parts.length === 3) \{\
                let year = parseInt(parts[0], 10);\
                const month = parts[1];\
                const day = parts[2];\
                // 2\uc0\u51088 \u47532  \u50672 \u46020 \u51064  \u44221 \u50864  2000\u45380 \u45824  \u52376 \u47532 \
                if (year < 100) year += 2000;\
                return `$\{year\}-$\{month\}-$\{day\}`;\
            \}\
            // \uc0\u51060 \u48120  YYYY-MM-DD \u54805 \u49885 \u51060 \u47732  \u44536 \u45824 \u47196  \u48152 \u54872 \
            if (dateStr.match(/^\\d\{4\}-\\d\{2\}-\\d\{2\}$/)) return dateStr;\
            return null;\
        \} catch (e) \{\
            return null;\
        \}\
    \}\
\
    asList.forEach((item, index) => \{\
        // A/S \uc0\u54637 \u47785  \u45936 \u51060 \u53552  \u47588 \u54609  (\u45432 \u49496  A/S \u44288 \u47532  \u47532 \u49828 \u53944  DB \u49549 \u49457 \u47749 \u50640  \u47582 \u52644 )\
        // [\uc0\u49688 \u51221 ] \u47784 \u46304  \u53581 \u49828 \u53944 \u54805  \u49549 \u49457 \u51012  \u47749 \u49884 \u51201 \u51004 \u47196  \u47928 \u51088 \u50676 \u47196  \u48320 \u54872 \u54616 \u50668  API \u50724 \u47448  \u48169 \u51648 \
        const category = String(item.category || item.\uc0\u52852 \u53580 \u44256 \u47532  || '');\
        const brand = String(item.brand || item.\uc0\u48652 \u47004 \u46300  || '');\
        const detailItem = String(item.item || item.\uc0\u49464 \u48512 \u54637 \u47785  || '');\
        const modelNum = String(item.modelNum || item.\uc0\u54408 \u48264  || '');\
        const size = String(item.size || item.\uc0\u52824 \u49688  || '');\
        const serviceCenter = String(item.service || item.serviceCenter || item.\uc0\u49436 \u48708 \u49828 \u49468 \u53552  || '');\
        const warranty = String(item.warranty || item.\uc0\u48372 \u51613 \u44592 \u44036  || '');\
        const note = String(item.note || item.\uc0\u48708 \u44256  || '');\
\
        const formattedDate = parseWarrantyDate(warranty);\
\
        const props = \{\
            '\uc0\u52852 \u53580 \u44256 \u47532 ': \{ title: [\{ text: \{ content: category \} \}] \},\
            '\uc0\u48652 \u47004 \u46300 ': \{ rich_text: [\{ text: \{ content: brand \} \}] \},\
            '\uc0\u49464 \u48512 \u54637 \u47785 ': \{ rich_text: [\{ text: \{ content: detailItem \} \}] \},\
            '\uc0\u54408 \u48264 ': \{ rich_text: [\{ text: \{ content: modelNum \} \}] \},\
            '\uc0\u52824 \u49688 ': \{ rich_text: [\{ text: \{ content: size \} \}] \},\
            '\uc0\u49436 \u48708 \u49828 \u49468 \u53552 ': \{ phone_number: serviceCenter || null \},\
            '\uc0\u48372 \u51613 \u44592 \u44036 ': formattedDate ? \{ date: \{ start: formattedDate \} \} : undefined,\
            '\uc0\u48708 \u44256 ': \{ rich_text: [\{ text: \{ content: note \} \}] \},\
            'NO': \{ number: index + 1 \},\
            '\uc0\u44256 \u44061 \u51221 \u48372 ': \{ relation: [\{ id: pageId \}] \}\
        \};\
\
        // undefined \uc0\u49549 \u49457  \u51228 \u44144 \
        Object.keys(props).forEach(key => props[key] === undefined && delete props[key]);\
\
        callNotionAPI('/pages', 'POST', \{\
            parent: \{ database_id: dbId \},\
            properties: props\
        \});\
        count++;\
    \});\
\
    // [\uc0\u49325 \u51228 ] \u44256 \u44061  \u54168 \u51060 \u51648 \u50640  A/S \u50976 \u51032 \u49324 \u54637  \u53084 \u50500 \u50883  \u52628 \u44032  (\u49324 \u50857 \u51088  \u50836 \u52397 )\
    /*\
    try \{\
        const guidelines = data.guidelines || data.\uc0\u50976 \u51032 \u49324 \u54637  || [];\
        if (guidelines.length > 0) \{\
            const calloutContent = guidelines.map(g => (\{\
                type: 'paragraph',\
                paragraph: \{\
                    rich_text: [\{ type: 'text', text: \{ content: '\'95 ' + g \} \}]\
                \}\
            \}));\
\
            callNotionAPI('/blocks/' + pageId + '/children', 'PATCH', \{\
                children: [\
                    \{\
                        type: 'callout',\
                        callout: \{\
                            icon: \{ type: 'emoji', emoji: '\uc0\u9888 \u65039 ' \},\
                            color: 'orange_background',\
                            rich_text: [\{ type: 'text', text: \{ content: 'A/S \uc0\u50504 \u45236  \u48143  \u50976 \u51032 \u49324 \u54637 ' \} \}],\
                            children: calloutContent\
                        \}\
                    \}\
                ]\
            \});\
        \}\
    \} catch (e) \{\
        console.warn('A/S \uc0\u50976 \u51032 \u49324 \u54637  \u53084 \u50500 \u50883  \u52628 \u44032  \u49892 \u54056 :', e.toString());\
    \}\
    */\
\
    return \{ url: '', count: count \};\
\}\
\
\
// [\uc0\u53944 \u47532 \u44144 ] onEdit (\u45800 \u49692  \u53944 \u47532 \u44144 )\
// \uc0\u51452 \u51032 : "\u49444 \u52824 \u54805  \u53944 \u47532 \u44144 "\u47196  processStatusChange\u47484  \u48324 \u46020  \u49444 \u51221 \u54664 \u51004 \u48064 \u47196 ,\
// \uc0\u50500 \u47000  \u45800 \u49692  \u53944 \u47532 \u44144 \u44032  \u54876 \u49457 \u54868 \u46104 \u47732  \u53076 \u46300 \u44032  \u51473 \u48373  \u49892 \u54665 \u46112  \u50948 \u54744 \u51060  \u51080 \u49845 \u45768 \u45796 .\
// \uc0\u46384 \u46972 \u49436  \u50500 \u47000  \u53076 \u46300 \u45716  \u51452 \u49437  \u52376 \u47532 \u54616 \u44144 \u45208  \u49325 \u51228 \u54616 \u45716  \u44163 \u51060  \u50504 \u51204 \u54633 \u45768 \u45796 .\
/*\
function onEdit(e) \{\
    processStatusChange(e);\
\}\
*/\
\
\
// ==========================================\
// 3. \uc0\u49345 \u45812  \u47928 \u51032  \u52376 \u47532  \u47196 \u51649  (Consulting Logic)\
// ==========================================\
\
function handleConsultingInquiry(data) \{\
    // \uc0\u49345 \u45812 \u50857  \u49884 \u53944  \u50676 \u44592 \
    var spreadsheet = SpreadsheetApp.openById(CONSULTING_SHEET_ID);\
    // \uc0\u54876 \u49457  \u49884 \u53944  \u49324 \u50857  (\u47749 \u49884 \u51201 \u51004 \u47196  '\u49345 \u45812 \u44288 \u47532 _\u47560 \u49828 \u53552 ' \u51648 \u51221 )\
    var sheet = spreadsheet.getSheetByName('\uc0\u49345 \u45812 \u44288 \u47532 _\u47560 \u49828 \u53552 ');\
    if (!sheet) \{\
        // \uc0\u49884 \u53944 \u44032  \u50630 \u51004 \u47732  \u49373 \u49457  (\u54841 \u51008  \u50640 \u47084  \u52376 \u47532 )\
        sheet = spreadsheet.insertSheet('\uc0\u49345 \u45812 \u44288 \u47532 _\u47560 \u49828 \u53552 ');\
    \}\
\
    if (sheet.getLastRow() === 0) \{\
        setupConsultingSheet(sheet);\
    \}\
\
    var lastRow = sheet.getLastRow();\
    var nextNum = 1;\
\
    if (lastRow > 1) \{\
        var lastNum = sheet.getRange(lastRow, 1).getValue();\
        if (typeof lastNum === 'number') \{\
            nextNum = lastNum + 1;\
        \} else \{\
            nextNum = lastRow;\
        \}\
    \}\
\
    sheet.appendRow([\
        nextNum,\
        new Date(),\
        data.name || '',\
        data.phone || '',\
        data.email || '',\
        data.location || '',\
        data.message || '',\
        '\uc0\u49345 \u45812 \u47928 \u51032 \u51217 \u49688 ',\
        ''\
    ]);\
\
    // \uc0\u51060 \u47700 \u51068  \u48156 \u49569 \
    if (data.email) \{\
        var emailSent = sendSurveyEmail(data);\
        var newRowIndex = sheet.getLastRow();\
\
        if (emailSent) \{\
            // \uc0\u51060 \u47700 \u51068  \u48156 \u49569  \u49457 \u44277  \u49884  \u49345 \u53468 \u47484  "\u49444 \u47928 \u48156 \u49569 "\u51004 \u47196  \u48320 \u44221  (8\u48264 \u51704  \u50676 )\
            sheet.getRange(newRowIndex, 8).setValue('\uc0\u49444 \u47928 \u48156 \u49569 ');\
        \} else \{\
            sheet.getRange(newRowIndex, 8).setValue('\uc0\u48156 \u49569 \u49892 \u54056 ');\
        \}\
    \}\
\
    return ContentService.createTextOutput(JSON.stringify(\{ result: "success" \}))\
        .setMimeType(ContentService.MimeType.JSON);\
\}\
function handleConsultingGet(e) \{\
    var spreadsheet = SpreadsheetApp.openById(CONSULTING_SHEET_ID);\
    var sheet = spreadsheet.getSheetByName('\uc0\u49345 \u45812 \u44288 \u47532 _\u47560 \u49828 \u53552 ');\
    if (!sheet) return ContentService.createTextOutput(JSON.stringify([])).setMimeType(ContentService.MimeType.JSON);\
    var data = sheet.getDataRange().getValues();\
\
    var rows = data.slice(1); // \uc0\u54756 \u45908  \u51228 \u50808 \
\
    var result = rows.map(function (row, index) \{\
        return \{\
            no: row[0] || index + 1,\
            date: row[1] || '',\
            name: row[2] || '',\
            phone: row[3] || '',\
            email: row[4] || '',\
            location: row[5] || '',\
            message: row[6] || '',\
            status: row[7] || '\uc0\u49888 \u44508 \u47928 \u51032 ',\
            note: row[8] || ''\
        \};\
    \});\
\
    result.reverse(); // \uc0\u52572 \u49888 \u49692 \
\
    return ContentService.createTextOutput(JSON.stringify(result))\
        .setMimeType(ContentService.MimeType.JSON);\
\}\
\
function sendSurveyEmail(data) \{\
    var customerName = data.name || '\uc0\u44256 \u44061 ';\
\
    var params = [\
        'usp=pp_url',\
        'entry.' + ENTRY_IDS.NAME + '=' + encodeURIComponent(customerName),\
        'entry.' + ENTRY_IDS.PHONE + '=' + encodeURIComponent(data.phone || ''),\
        'entry.' + ENTRY_IDS.EMAIL + '=' + encodeURIComponent(data.email || ''),\
        'entry.' + ENTRY_IDS.ADDRESS + '=' + encodeURIComponent(data.location || ''),\
        'entry.' + ENTRY_IDS.MESSAGE + '=' + encodeURIComponent(data.message || '')\
    ];\
\
    var finalSurveyUrl = FORM_BASE_URL + '?' + params.join('&');\
    var subject = '[\uc0\u46356 \u51088 \u51064 \u51648 \u44536 ] \u47582 \u52644  \u49345 \u45812 \u51012  \u50948 \u54644  \u49324 \u51204  \u49444 \u47928  \u51089 \u49457 \u51012  \u48512 \u53441 \u46300 \u47549 \u45768 \u45796 ';\
\
    var htmlBody = `\
<!DOCTYPE html>\
<html>\
<head>\
    <meta charset="UTF-8">\
    <style>\
        body \{ font-family: 'Noto Sans KR', -apple-system, sans-serif; line-height: 1.75; color: #333; letter-spacing: -0.02em; \}\
        .container \{ max-width: 600px; margin: 0 auto; padding: 40px 20px; \}\
        .footer \{ margin-top: 50px; padding-top: 20px; border-top: 1px solid #eee; color: #888; font-size: 12px; line-height: 1.6; \}\
        a \{ color: #1a1a1a; text-decoration: none; border-bottom: 1px solid #1a1a1a; font-weight: bold; transition: opacity 0.2s; \}\
        a:hover \{ opacity: 0.7; \}\
    </style>\
</head>\
<body>\
    <div class="container">\
        <p><strong>DESIGN JIG</strong></p>\
        <br>\
        <p>\uc0\u50504 \u45397 \u54616 \u49464 \u50836 , <strong>$\{customerName\}</strong> \u45784 .<br>\
        \uc0\u46356 \u51088 \u51064 \u51648 \u44536 \u50640  \u47928 \u51032 \u54644  \u51452 \u49492 \u49436  \u44048 \u49324 \u54633 \u45768 \u45796 .</p>\
        <br>\
        <p>\uc0\u46356 \u51088 \u51064 \u51648 \u44536 \u45716 <br>\
        \uc0\u44277 \u44036 \u51012  \u45800 \u49692 \u55176  \u44984 \u48120 \u45716  \u44163 \u51060  \u50500 \u45768 \u46972 ,<br>\
        \uc0\u44536  \u44277 \u44036 \u50640 \u49436  \u49332 \u50500 \u44040  \u48516 \u51032  \u49373 \u54876  \u48169 \u49885 \u44284  \u44592 \u51456 \u51012 <br>\
        \uc0\u47676 \u51200  \u51060 \u54644 \u54616 \u45716  \u44163 \u50640 \u49436  \u49444 \u44228 \u47484  \u49884 \u51089 \u54633 \u45768 \u45796 .</p>\
        <br>\
        <p>\uc0\u48372 \u45796  \u51221 \u54869 \u54620  \u49345 \u45812 \u51012  \u50948 \u54644 <br>\
        \uc0\u44036 \u45800 \u54620  \u49324 \u51204  \u49444 \u47928  \u51089 \u49457 \u51012  \u48512 \u53441 \u46300 \u47549 \u45768 \u45796 .<br>\
        \uc0\u49444 \u47928  \u45236 \u50857 \u51012  \u48148 \u53461 \u51004 \u47196  \u44277 \u44036 \u51032  \u48169 \u54693 \u44284  \u50864 \u49440 \u49692 \u50948 \u47484  \u51221 \u47532 \u54620  \u54980 ,<br>\
        \uc0\u44536 \u50640  \u47582 \u45716  \u49345 \u45812 \u51012  \u51652 \u54665 \u54644  \u46300 \u47532 \u44192 \u49845 \u45768 \u45796 .</p>\
        <br>\
        <p>\uc0\u50500 \u47000  \u47553 \u53356 \u47484  \u53685 \u54644  \u49444 \u47928 \u50640  \u52280 \u50668 \u54616 \u49892  \u49688  \u51080 \u51004 \u47728 ,<br>\
        \uc0\u51089 \u49457 \u50640  \u54596 \u50836 \u54620  \u44592 \u48376  \u51221 \u48372 \u45716  \u48120 \u47532  \u51077 \u47141 \u46104 \u50612  \u51080 \u50612 <br>\
        \uc0\u44036 \u45800 \u54616 \u44172  \u51089 \u49457 \u54616 \u49892  \u49688  \u51080 \u49845 \u45768 \u45796 .</p>\
        <br>\
        <p>\
            <a href="$\{finalSurveyUrl\}">\uc0\u9654  \u49324 \u51204  \u49444 \u47928  \u51089 \u49457 \u54616 \u44592 </a><br>\
            (\uc0\u50557  2~3\u48516  \u49548 \u50836 )\
        </p>\
        <br>\
        <p>\uc0\u49444 \u47928  \u51089 \u49457  \u54980  \u54869 \u51064 \u46104 \u45716  \u45824 \u47196 <br>\
        \uc0\u49692 \u52264 \u51201 \u51004 \u47196  \u50672 \u46973 \u46300 \u47532 \u44192 \u49845 \u45768 \u45796 .</p>\
        <br>\
        <p>\uc0\u44048 \u49324 \u54633 \u45768 \u45796 .</p>\
        <br>\
        <p>\uc0\u46356 \u51088 \u51064 \u51648 \u44536  \u46300 \u47548 </p>\
\
        <div class="footer">\
            <strong style="color: #1a1a1a; font-size: 13px;">DESIGN JIG</strong><br>\
            \uc0\u44592 \u48376 \u51060  \u53444 \u53444 \u54644 \u50556  \u50500 \u47492 \u45796 \u50880 \u46020  \u50724 \u47000 \u44049 \u45768 \u45796 .<br>\
            designjig.com\
        </div>\
    </div>\
</body>\
</html>\
    `;\
\
    var plainTextBody = `\
DESIGN JIG\
\
\uc0\u50504 \u45397 \u54616 \u49464 \u50836 , $\{customerName\} \u45784 .\
\uc0\u46356 \u51088 \u51064 \u51648 \u44536 \u50640  \u47928 \u51032 \u54644  \u51452 \u49492 \u49436  \u44048 \u49324 \u54633 \u45768 \u45796 .\
\
\uc0\u46356 \u51088 \u51064 \u51648 \u44536 \u45716 \
\uc0\u44277 \u44036 \u51012  \u45800 \u49692 \u55176  \u44984 \u48120 \u45716  \u44163 \u51060  \u50500 \u45768 \u46972 ,\
\uc0\u44536  \u44277 \u44036 \u50640 \u49436  \u49332 \u50500 \u44040  \u48516 \u51032  \u49373 \u54876  \u48169 \u49885 \u44284  \u44592 \u51456 \u51012 \
\uc0\u47676 \u51200  \u51060 \u54644 \u54616 \u45716  \u44163 \u50640 \u49436  \u49444 \u44228 \u47484  \u49884 \u51089 \u54633 \u45768 \u45796 .\
\
\uc0\u48372 \u45796  \u51221 \u54869 \u54620  \u49345 \u45812 \u51012  \u50948 \u54644 \
\uc0\u44036 \u45800 \u54620  \u49324 \u51204  \u49444 \u47928  \u51089 \u49457 \u51012  \u48512 \u53441 \u46300 \u47549 \u45768 \u45796 .\
\uc0\u49444 \u47928  \u45236 \u50857 \u51012  \u48148 \u53461 \u51004 \u47196  \u44277 \u44036 \u51032  \u48169 \u54693 \u44284  \u50864 \u49440 \u49692 \u50948 \u47484  \u51221 \u47532 \u54620  \u54980 ,\
\uc0\u44536 \u50640  \u47582 \u45716  \u49345 \u45812 \u51012  \u51652 \u54665 \u54644  \u46300 \u47532 \u44192 \u49845 \u45768 \u45796 .\
\
\uc0\u50500 \u47000  \u47553 \u53356 \u47484  \u53685 \u54644  \u49444 \u47928 \u50640  \u52280 \u50668 \u54616 \u49892  \u49688  \u51080 \u51004 \u47728 ,\
\uc0\u51089 \u49457 \u50640  \u54596 \u50836 \u54620  \u44592 \u48376  \u51221 \u48372 \u45716  \u48120 \u47532  \u51077 \u47141 \u46104 \u50612  \u51080 \u50612 \
\uc0\u44036 \u45800 \u54616 \u44172  \u51089 \u49457 \u54616 \u49892  \u49688  \u51080 \u49845 \u45768 \u45796 .\
\
\uc0\u9654  \u49324 \u51204  \u49444 \u47928  \u51089 \u49457 \u54616 \u44592 \
$\{finalSurveyUrl\}\
(\uc0\u50557  2~3\u48516  \u49548 \u50836 )\
\
\uc0\u49444 \u47928  \u51089 \u49457  \u54980  \u54869 \u51064 \u46104 \u45716  \u45824 \u47196 \
\uc0\u49692 \u52264 \u51201 \u51004 \u47196  \u50672 \u46973 \u46300 \u47532 \u44192 \u49845 \u45768 \u45796 .\
\
\uc0\u44048 \u49324 \u54633 \u45768 \u45796 .\
\
\uc0\u46356 \u51088 \u51064 \u51648 \u44536  \u46300 \u47548 \
\
\uc0\u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \
DESIGN JIG\
\uc0\u44592 \u48376 \u51060  \u53444 \u53444 \u54644 \u50556  \u50500 \u47492 \u45796 \u50880 \u46020  \u50724 \u47000 \u44049 \u45768 \u45796 .\
designjig.com\
    `;\
\
    try \{\
        // 1\uc0\u52264  \u49884 \u46020 : \u51648 \u51221 \u46108  Sender Email(Alias)\u47196  \u48156 \u49569  \u49884 \u46020 \
        GmailApp.sendEmail(data.email, subject, plainTextBody, \{\
            htmlBody: htmlBody,\
            name: SENDER_NAME,\
            from: SENDER_EMAIL\
        \});\
        console.log('\uc0\u51060 \u47700 \u51068  \u48156 \u49569  \u49457 \u44277  (Alias \u49324 \u50857 ): ' + data.email);\
        return true;\
    \} catch (error) \{\
        // \uc0\u49892 \u54056  \u49884  \u47196 \u44536  \u52636 \u47141  \u54980  \u44592 \u48376  \u44228 \u51221 \u51004 \u47196  \u51116 \u49884 \u46020 \
        console.warn('Alias \uc0\u48156 \u49569  \u49892 \u54056 , \u44592 \u48376  \u44228 \u51221 \u51004 \u47196  \u51116 \u49884 \u46020 \u54633 \u45768 \u45796 : ' + error.toString());\
        try \{\
            GmailApp.sendEmail(data.email, subject, plainTextBody, \{\
                htmlBody: htmlBody,\
                name: SENDER_NAME\
                // from \uc0\u50741 \u49496  \u51228 \u44144  (\u54788 \u51116  \u49892 \u54665  \u51473 \u51064  \u44228 \u51221 \u51032  \u44592 \u48376  \u51452 \u49548  \u49324 \u50857 )\
            \});\
            console.log('\uc0\u51060 \u47700 \u51068  \u48156 \u49569  \u49457 \u44277  (\u44592 \u48376  \u44228 \u51221 ): ' + data.email);\
            return true;\
        \} catch (retryError) \{\
            console.error('\uc0\u51060 \u47700 \u51068  \u48156 \u49569  \u52572 \u51333  \u49892 \u54056 : ' + retryError.toString());\
            return false;\
        \}\
    \}\
\}\
\
function setupConsultingSheet(sheet) \{\
    var headers = ['No.', '\uc0\u51217 \u49688 \u51068 \u49884 ', '\u51060 \u47492 ', '\u50672 \u46973 \u52376 ', '\u51060 \u47700 \u51068 ', '\u54788 \u51109 \u51452 \u49548 ', '\u47928 \u51032 \u45236 \u50857 ', '\u49345 \u45812 \u49345 \u53468 ', '\u49345 \u45812  \u50696 \u50557  \u45216 \u51676 '];\
    sheet.appendRow(headers);\
\
    var headerRange = sheet.getRange(1, 1, 1, headers.length);\
    headerRange.setBackground('#4a7c59');\
    headerRange.setFontColor('#ffffff');\
    headerRange.setFontWeight('bold');\
    headerRange.setHorizontalAlignment('center');\
\
    sheet.setColumnWidth(1, 50);\
    sheet.setColumnWidth(2, 150);\
    sheet.setColumnWidth(3, 80);\
    sheet.setColumnWidth(6, 200);\
    sheet.setColumnWidth(7, 250);\
\
    // \uc0\u54596 \u53552  \u49373 \u49457 \
    sheet.getRange(1, 1, 1, headers.length).createFilter();\
\}\
\
\
// ==========================================\
// 4. \uc0\u44256 \u44061  \u44288 \u47532  \u46041 \u44592 \u54868  (Customer Sync Logic)\
// ==========================================\
\
function handleCustomerSync(payload) \{\
    var spreadsheet = SpreadsheetApp.openById(CUSTOMER_SHEET_ID);\
\
    // [Case 1] \uc0\u44288 \u47532 \u51088  \u51200 \u51109 \
    if (payload.action === 'admin') \{\
        var adminData = payload.data;\
        if (!adminData || !adminData.id) throw new Error('Invalid admin data');\
        var result = saveAdmin(spreadsheet, adminData);\
        return ContentService.createTextOutput(JSON.stringify(\{\
            result: 'success',\
            action: result,\
            adminId: adminData.id\
        \})).setMimeType(ContentService.MimeType.JSON);\
    \}\
\
    // [Case 2] \uc0\u44288 \u47532 \u51088  \u49325 \u51228 \
    if (payload.action === 'deleteAdmin') \{\
        var deleted = deleteAdmin(spreadsheet, payload.adminId);\
        return ContentService.createTextOutput(JSON.stringify(\{\
            result: deleted ? 'success' : 'not_found',\
            action: 'deleted'\
        \})).setMimeType(ContentService.MimeType.JSON);\
    \}\
\
    // [Case 3] \uc0\u44256 \u44061  \u45936 \u51060 \u53552  \u46041 \u44592 \u54868 \
    var customerData = payload.data || payload;\
    if (!customerData || !customerData.customerId) \{\
        throw new Error('\uc0\u45936 \u51060 \u53552  \u50724 \u47448 : \u44256 \u44061  ID(customerId)\u44032  \u50630 \u49845 \u45768 \u45796 .');\
    \}\
\
    var customerId = customerData.customerId;\
    var newStatus = customerData.status;\
\
    // \uc0\u49884 \u53944  \u51456 \u48708 \
    var mainSheet = spreadsheet.getSheetByName('\uc0\u44256 \u44061 \u44288 \u47532 _\u44204 \u51201 \u49436 ');\
    var contractedSheet = spreadsheet.getSheetByName('\uc0\u44228 \u50557 \u50756 \u47308 ');\
    var asSheet = spreadsheet.getSheetByName('\uc0\u49324 \u54980 \u44288 \u47532 _A/S');\
\
    if (!mainSheet) \{ mainSheet = spreadsheet.insertSheet('\uc0\u44256 \u44061 \u44288 \u47532 _\u44204 \u51201 \u49436 '); initializeCustomerSheet(mainSheet); \}\
    if (!contractedSheet) \{ contractedSheet = spreadsheet.insertSheet('\uc0\u44228 \u50557 \u50756 \u47308 '); initializeCustomerSheet(contractedSheet); \}\
    if (!asSheet) \{ asSheet = spreadsheet.insertSheet('\uc0\u49324 \u54980 \u44288 \u47532 _A/S'); initializeAsSheet(asSheet); \}\
\
    if (mainSheet.getLastRow() === 0) initializeCustomerSheet(mainSheet);\
    if (contractedSheet.getLastRow() === 0) initializeCustomerSheet(contractedSheet);\
    if (asSheet.getLastRow() === 0) initializeAsSheet(asSheet);\
\
    var rowData = [\
        customerData.customerId,\
        customerData.status || '',\
        customerData.createdAt || new Date().toISOString(),\
        customerData.clientName || '',\
        customerData.clientPhone || '',\
        customerData.clientEmail || '',\
        customerData.clientAddress || '',\
        customerData.projectName || '',\
        customerData.siteAddress || '',\
        customerData.pyeong || '',\
        customerData.inflowPath || '',      // \uc0\u50976 \u51077 \u44221 \u47196 \
        customerData.buildingType || '',    // \uc0\u44148 \u47932 \u50976 \u54805 \
        customerData.contractDate || '',\
        customerData.constructionPeriod || '',\
        customerData.warrantyPeriod || '',\
        customerData.totalAmount || '',\
        customerData.estimateProfitRate || '',\
        customerData.jsonData || JSON.stringify(customerData),\
        formatScheduleToString(customerData.schedules) // \uc0\u44277 \u49324  \u49828 \u52992 \u51460  (\u44032 \u46021 \u49457  \u47928 \u51088 \u50676 )\
    ];\
\
    // \uc0\u44592 \u51316  \u45936 \u51060 \u53552  \u50948 \u52824  \u44160 \u49353  (Main)\
    var mainData = mainSheet.getDataRange().getValues();\
    var mainRowIndex = -1;\
    for (var i = 1; i < mainData.length; i++) \{\
        if (mainData[i][0] === customerId) \{\
            mainRowIndex = i + 1;\
            break;\
        \}\
    \}\
\
    // \uc0\u44592 \u51316  \u45936 \u51060 \u53552  \u50948 \u52824  \u44160 \u49353  (Contracted)\
    var contractedData = contractedSheet.getDataRange().getValues();\
    var contractedRowIndex = -1;\
    for (var j = 1; j < contractedData.length; j++) \{\
        if (contractedData[j][0] === customerId) \{\
            contractedRowIndex = j + 1;\
            break;\
        \}\
    \}\
\
    // \uc0\u44592 \u51316  \u45936 \u51060 \u53552  \u50948 \u52824  \u44160 \u49353  (A/S)\
    var asData = asSheet.getDataRange().getValues();\
    var asRowIndex = -1;\
    for (var k = 1; k < asData.length; k++) \{\
        if (asData[k][0] === customerId) \{\
            asRowIndex = k + 1;\
            break;\
        \}\
    \}\
\
    var action = '';\
\
    // [\uc0\u47196 \u51649 ] \u47700 \u51064  \u49884 \u53944 \u45716  \u54637 \u49345  \u50629 \u45936 \u51060 \u53944 /\u52628 \u44032 \
    if (mainRowIndex > 0) \{\
        mainSheet.getRange(mainRowIndex, 1, 1, rowData.length).setValues([rowData]);\
        action = 'updated';\
    \} else \{\
        mainSheet.appendRow(rowData);\
        action = 'created';\
    \}\
\
    // [\uc0\u47196 \u51649 ] \u49345 \u53468 \u48324  \u48516 \u44592 \
    // 1. **\uc0\u44228 \u50557 \u50756 \u47308 ** (Contracted) - \u44228 \u50557 \u50756 \u47308  \u49884 \u53944  + \u49324 \u54980 \u44288 \u47532 _A/S \u49884 \u53944  \u47784 \u46160  \u52628 \u44032 \
    if (newStatus === 'contracted' || newStatus === '\uc0\u44228 \u50557 \u50756 \u47308 ') \{\
        // \uc0\u44228 \u50557 \u50756 \u47308  \u49884 \u53944 : \u52628 \u44032 /\u50629 \u45936 \u51060 \u53944 \
        if (contractedRowIndex > 0) \{\
            contractedSheet.getRange(contractedRowIndex, 1, 1, rowData.length).setValues([rowData]);\
        \} else \{\
            contractedSheet.appendRow(rowData);\
        \}\
\
        // \uc0\u49324 \u54980 \u44288 \u47532 _A/S \u49884 \u53944 : \u51088 \u46041  \u48373 \u49324  (A/S \u44592 \u44036  \u44228 \u49328 )\
        var asRowData = buildAsRowData(customerData);\
        if (asRowIndex > 0) \{\
            asSheet.getRange(asRowIndex, 1, 1, asRowData.length).setValues([asRowData]);\
        \} else \{\
            asSheet.appendRow(asRowData);\
        \}\
    \}\
    // 2. **A/S** (After Sales)\
    else if (newStatus === 'as_done' || newStatus === 'A/S') \{\
        // \uc0\u44228 \u50557 \u50756 \u47308  \u49884 \u53944 : \u50976 \u51648  (Data Copy) - \u50629 \u45936 \u51060 \u53944 \
        if (contractedRowIndex > 0) \{\
            contractedSheet.getRange(contractedRowIndex, 1, 1, rowData.length).setValues([rowData]);\
        \} else \{\
            contractedSheet.appendRow(rowData);\
        \}\
        // A/S \uc0\u49884 \u53944 : \u52628 \u44032 /\u50629 \u45936 \u51060 \u53944 \
        var asRowData2 = buildAsRowData(customerData);\
        if (asRowIndex > 0) \{\
            asSheet.getRange(asRowIndex, 1, 1, asRowData2.length).setValues([asRowData2]);\
        \} else \{\
            asSheet.appendRow(asRowData2);\
        \}\
    \}\
    // 3. **\uc0\u44592 \u53440 ** (\u49345 \u45812 \u51473  \u46321 )\
    else \{\
        // \uc0\u44228 \u50557 \u50756 \u47308 /AS \u49884 \u53944 \u50640 \u49436  \u51228 \u44144  (\u49345 \u53468 \u44032  \u46028 \u50500 \u44052 \u51012  \u44221 \u50864 )\
        if (contractedRowIndex > 0) contractedSheet.deleteRow(contractedRowIndex);\
        if (asRowIndex > 0) asSheet.deleteRow(asRowIndex);\
    \}\
\
    return ContentService.createTextOutput(JSON.stringify(\{\
        result: 'success',\
        action: action,\
        customerId: customerId\
    \})).setMimeType(ContentService.MimeType.JSON);\
\}\
\
\
function handleCustomerGet(e) \{\
    var spreadsheet = SpreadsheetApp.openById(CUSTOMER_SHEET_ID);\
    var sheetName = e.parameter.sheet || '\uc0\u44256 \u44061 \u44288 \u47532 _\u44204 \u51201 \u49436 ';\
\
    // \uc0\u44288 \u47532 \u51088  \u47785 \u47197  \u51312 \u54924 \
    if (sheetName === '\uc0\u44288 \u47532 \u51088 ') \{\
        var admins = getAdmins(spreadsheet);\
        return ContentService.createTextOutput(JSON.stringify(admins))\
            .setMimeType(ContentService.MimeType.JSON);\
    \}\
\
    var sheet = spreadsheet.getSheetByName(sheetName);\
    if (!sheet || sheet.getLastRow() < 2) \{\
        return ContentService.createTextOutput(JSON.stringify([])).setMimeType(ContentService.MimeType.JSON);\
    \}\
\
    var data = sheet.getDataRange().getValues();\
    var customers = [];\
\
    for (var i = 1; i < data.length; i++) \{\
        var row = data[i];\
        var customerId = row[0]; // \uc0\u52395  \u48264 \u51704  \u50676 \u51060  customerId\
\
        // customerId\uc0\u44032  \u50630 \u51004 \u47732  \u44148 \u45320 \u46832 \u44592  (\u48712  \u54665  \u46608 \u45716  \u51096 \u47803 \u46108  \u45936 \u51060 \u53552 )\
        if (!customerId) continue;\
\
        var jsonData = row[17]; // JSON\uc0\u45936 \u51060 \u53552  \u50676  (18\u48264 \u51704  \u50676  = \u51064 \u45937 \u49828  17)\
\
        if (jsonData) \{\
            try \{\
                var parsedData = JSON.parse(jsonData);\
                // \uc0\u54028 \u49905 \u46108  \u45936 \u51060 \u53552 \u50640  customerId\u44032  \u51080 \u45716 \u51648  \u54869 \u51064 \
                if (parsedData.customerId) \{\
                    customers.push(parsedData);\
                \} else \{\
                    // customerId\uc0\u44032  \u50630 \u51004 \u47732  \u54665  \u45936 \u51060 \u53552 \u50640 \u49436  \u52628 \u44032 \
                    parsedData.customerId = customerId;\
                    customers.push(parsedData);\
                \}\
            \} catch (e) \{\
                // \uc0\u54028 \u49905  \u49892 \u54056  \u49884  \u47196 \u44613  \u48143  \u44592 \u48376  \u44396 \u51312 \u47196  \u49373 \u49457 \
                console.warn('JSON \uc0\u54028 \u49905  \u49892 \u54056  (\u54665  ' + (i + 1) + '): ' + e.toString());\
                customers.push(buildCustomerFromRow(row));\
            \}\
        \} else \{\
            // JSON\uc0\u45936 \u51060 \u53552 \u44032  \u50630 \u51004 \u47732  \u44592 \u48376  \u52972 \u47100 \u50640 \u49436  \u44396 \u49457 \
            customers.push(buildCustomerFromRow(row));\
        \}\
    \}\
    return ContentService.createTextOutput(JSON.stringify(customers)).setMimeType(ContentService.MimeType.JSON);\
\}\
\
// Helper: Build customer object from sheet row\
function buildCustomerFromRow(row) \{\
    // JSON \uc0\u45936 \u51060 \u53552  \u54028 \u49905  \u49884 \u46020  (finalPaymentDate \u52628 \u52636 \u50857 )\
    var jsonStr = row[17] || '\{\}';\
    var jsonData = \{\};\
    try \{ jsonData = JSON.parse(jsonStr); \} catch (e) \{ \}\
\
    return \{\
        customerId: row[0] || '',\
        status: row[1] || '',\
        createdAt: row[2] || '',\
        clientName: row[3] || '',\
        clientPhone: row[4] || '',\
        clientEmail: row[5] || '',\
        clientAddress: row[6] || '',\
        projectName: row[7] || '',\
        siteAddress: row[8] || '',\
        pyeong: row[9] || '',\
        area: row[9] || '',              // UI \uc0\u54840 \u54872 : pyeong -> area \u47588 \u54609 \
        inflowPath: row[10] || '',       // \uc0\u50976 \u51077 \u44221 \u47196 \
        clientSource: row[10] || '',     // UI \uc0\u54840 \u54872 : inflowPath -> clientSource \u47588 \u54609 \
        buildingType: row[11] || '',     // \uc0\u44148 \u47932 \u50976 \u54805 \
        contractDate: row[12] || '',\
        constructionPeriod: row[13] || '',\
        warrantyPeriod: row[14] || '',\
        totalAmount: row[15] || '',\
        estimateProfitRate: row[16] || '',\
        finalPaymentDate: jsonData.finalPaymentDate || '' // JSON\uc0\u50640 \u49436  \u52628 \u52636 \
    \};\
\}\
\
\
// Helper: Build row data for \uc0\u49324 \u54980 \u44288 \u47532 _A/S sheet\
// \uc0\u52972 \u47100 : NO, \u44256 \u44061 \u47749 , \u50672 \u46973 \u52376 , \u51060 \u47700 \u51068 , \u54788 \u51109 \u51452 \u49548 , \u44592 \u48376 A/S\u49345 \u53468 , \u54868 \u51109 \u49892 A/S\u49345 \u53468 , \u44277 \u49324 \u44592 \u44036 , \u51092 \u44552 \u51068 , \u44592 \u48376 A/S\u48372 \u51613 \u51068 (\u44060 \u50900 ), \u44592 \u48376 A/S\u44592 \u44036 , \u54868 \u51109 \u49892 A/S\u48372 \u51613 \u51068 (\u44060 \u50900 ), \u54868 \u51109 \u49892 A/S\u44592 \u44036 , \u45812 \u45817 \u51088 , \u48708 \u44256 \
function buildAsRowData(customerData) \{\
    var asEndDate = '';\
    var bathroomWarrantyDate = '';\
    // \uc0\u44592 \u48376  A/S \u44592 \u44036 : \u54637 \u49345  12\u44060 \u50900  (warrantyPeriod\u44032  \u45216 \u51676  \u47928 \u51088 \u50676 \u51068  \u49688  \u51080 \u51004 \u48064 \u47196  \u44256 \u51221 \u44050  \u49324 \u50857 )\
    var warrantyMonths = 12;\
    var bathroomWarrantyMonths = 30; // \uc0\u54868 \u51109 \u49892  \u45572 \u49688  \u48372 \u51613  \u44592 \u44036  (30\u44060 \u50900 )\
\
\
    var asStatus = '';           // \uc0\u44592 \u48376  A/S \u49345 \u53468 \
    var bathroomAsStatus = '';   // \uc0\u54868 \u51109 \u49892  A/S \u49345 \u53468 \
\
    // \uc0\u51092 \u44552 \u51068  \u44592 \u51456 \u51004 \u47196  \u44228 \u49328 \
    var finalPaymentDate = customerData.finalPaymentDate || customerData.contractDate || '';\
    var today = new Date();\
    today.setHours(0, 0, 0, 0);\
\
    if (finalPaymentDate) \{\
        var baseDate = new Date(finalPaymentDate);\
        if (!isNaN(baseDate.getTime())) \{\
            // A/S \uc0\u50756 \u47308 \u51068  = \u51092 \u44552 \u51068  + A/S \u44592 \u44036 \
            var asDate = new Date(baseDate);\
            asDate.setMonth(asDate.getMonth() + warrantyMonths);\
            asEndDate = asDate.toISOString().split('T')[0];\
\
            // \uc0\u44592 \u48376  A/S \u49345 \u53468  \u51088 \u46041  \u49444 \u51221 \
            if (today <= asDate) \{\
                asStatus = 'A/S \uc0\u44592 \u44036 \u51652 \u54665 ';\
            \} else \{\
                asStatus = 'A/S \uc0\u44592 \u44036 \u50756 \u47308 ';\
            \}\
\
            // \uc0\u54868 \u51109 \u49892  \u45572 \u49688  \u48372 \u51613 \u51068  = \u51092 \u44552 \u51068  + 30\u44060 \u50900 \
            var bathDate = new Date(baseDate);\
            bathDate.setMonth(bathDate.getMonth() + bathroomWarrantyMonths);\
            bathroomWarrantyDate = bathDate.toISOString().split('T')[0];\
\
            // \uc0\u54868 \u51109 \u49892  A/S \u49345 \u53468  \u51088 \u46041  \u49444 \u51221 \
            if (today <= bathDate) \{\
                bathroomAsStatus = 'A/S \uc0\u44592 \u44036 \u51652 \u54665 ';\
            \} else \{\
                bathroomAsStatus = 'A/S \uc0\u44592 \u44036 \u50756 \u47308 ';\
            \}\
        \}\
    \}\
\
    return [\
        customerData.customerId || '',       // NO (\uc0\u44256 \u44061 ID)\
        customerData.clientName || '',        // \uc0\u44256 \u44061 \u47749 \
        customerData.clientPhone || '',       // \uc0\u50672 \u46973 \u52376 \
        customerData.clientEmail || '',       // \uc0\u51060 \u47700 \u51068 \
        customerData.siteAddress || '',       // \uc0\u54788 \u51109 \u51452 \u49548 \
        asStatus,                             // \uc0\u44592 \u48376  A/S \u49345 \u53468 \
        bathroomAsStatus,                     // \uc0\u54868 \u51109 \u49892  A/S \u49345 \u53468 \
        customerData.constructionPeriod || '',// \uc0\u44277 \u49324 \u44592 \u44036 \
        finalPaymentDate,                     // \uc0\u51092 \u44552 \u51068 \
        warrantyMonths,                       // \uc0\u44592 \u48376  A/S \u48372 \u51613 \u51068 (\u44060 \u50900 ) - 12\
        asEndDate,                            // \uc0\u44592 \u48376  A/S \u44592 \u44036  (\u45216 \u51676 )\
        bathroomWarrantyMonths,               // \uc0\u54868 \u51109 \u49892  A/S \u48372 \u51613 \u51068 (\u44060 \u50900 ) - 30\
        bathroomWarrantyDate,                 // \uc0\u54868 \u51109 \u49892  A/S \u44592 \u44036  (\u45216 \u51676 )\
        '',                                   // \uc0\u45812 \u45817 \u51088  (\u49324 \u50857 \u51088 \u44032  \u51649 \u51217  \u51077 \u47141 )\
        ''                                    // \uc0\u48708 \u44256 \
    ];\
\}\
\
// --- Customer Sync Helpers ---\
\
function formatScheduleToString(schedules) \{\
    if (!schedules || !Array.isArray(schedules) || schedules.length === 0) return '';\
    return schedules.map(function (s, idx) \{\
        var start = s.start || '';\
        var end = s.end || '';\
        var dateStr = (start || end) ? ' (' + start + ' ~ ' + end + ')' : '';\
        var managerStr = s.inCharge ? ' - ' + s.inCharge : '';\
        var memoStr = s.memo ? ' [' + s.memo + ']' : '';\
        return (idx + 1) + '. ' + (s.name || '') + dateStr + managerStr + memoStr;\
    \}).join('\\n');\
\}\
\
function initializeCustomerSheet(sheet) \{\
    var headers = [\
        '\uc0\u44256 \u44061 ID', '\u49345 \u53468 ', '\u49373 \u49457 \u51068 ', '\u49457 \u47749 ', '\u50672 \u46973 \u52376 ', '\u51060 \u47700 \u51068 ', '\u51452 \u49548 ', '\u44277 \u49324 \u47749 ', '\u54788 \u51109 \u51452 \u49548 ',\
        '\uc0\u54217 \u49688 ', '\u50976 \u51077 \u44221 \u47196 ', '\u44148 \u47932 \u50976 \u54805 ',\
        '\uc0\u44228 \u50557 \u51068 ', '\u44277 \u49324 \u44592 \u44036 ', 'A/S \u44592 \u44036 ', '\u44228 \u50557 \u44552 \u50529 ', '\u51060 \u50980 \u50984 ', 'JSON\u45936 \u51060 \u53552 ', '\u44277 \u49324  \u49828 \u52992 \u51460 '\
    ];\
    sheet.appendRow(headers);\
    var headerRange = sheet.getRange(1, 1, 1, headers.length);\
    headerRange.setBackground('#B4956F');\
    headerRange.setFontColor('#FFFFFF');\
    headerRange.setFontWeight('bold');\
    sheet.setFrozenRows(1);\
\}\
\
function initializeAdminSheet(sheet) \{\
    var headers = ['\uc0\u50500 \u51060 \u46356 ', '\u48708 \u48128 \u48264 \u54840 ', '\u51060 \u47492 ', '\u49373 \u49457 \u51068 '];\
    sheet.appendRow(headers);\
    var headerRange = sheet.getRange(1, 1, 1, headers.length);\
    headerRange.setBackground('#4A90D9');\
    headerRange.setFontColor('#FFFFFF');\
    headerRange.setFontWeight('bold');\
    sheet.setFrozenRows(1);\
\}\
\
function initializeAsSheet(sheet) \{\
    var headers = [\
        '\uc0\u44256 \u44061 ID', '\u44256 \u44061 \u47749 ', '\u50672 \u46973 \u52376 ', '\u51060 \u47700 \u51068 ', '\u54788 \u51109 \u51452 \u49548 ',\
        '\uc0\u44592 \u48376  A/S \u49345 \u53468 ', '\u54868 \u51109 \u49892  A/S \u49345 \u53468 ',\
        '\uc0\u44277 \u49324 \u44592 \u44036 ', '\u51092 \u44552 \u51068 ',\
        '\uc0\u44592 \u48376  A/S \u48372 \u51613 \u51068 (\u44060 \u50900 )', '\u44592 \u48376  A/S \u44592 \u44036 ',\
        '\uc0\u54868 \u51109 \u49892  A/S \u48372 \u51613 \u51068 (\u44060 \u50900 )', '\u54868 \u51109 \u49892  A/S \u44592 \u44036 ',\
        '\uc0\u45812 \u45817 \u51088 ', '\u48708 \u44256 '\
    ];\
    sheet.appendRow(headers);\
    var headerRange = sheet.getRange(1, 1, 1, headers.length);\
    headerRange.setBackground('#5C6BC0'); // \uc0\u48372 \u46972 \u49353  \u44228 \u50676 \
    headerRange.setFontColor('#FFFFFF');\
    headerRange.setFontWeight('bold');\
    sheet.setFrozenRows(1);\
\}\
\
// [\uc0\u50976 \u54008 \u47532 \u54000 ] \u44592 \u51316  \u49324 \u54980 \u44288 \u47532 _A/S \u49884 \u53944  \u51221 \u47532  - \u46300 \u47213 \u45796 \u50868 /\u52404 \u53356 \u48149 \u49828  \u51228 \u44144 \
// \uc0\u49688 \u46041  \u49892 \u54665 : Apps Script Editor\u50640 \u49436  \u51060  \u54632 \u49688  \u49892 \u54665 \
function cleanupAsSheet() \{\
    var spreadsheet = SpreadsheetApp.openById(CUSTOMER_SHEET_ID);\
    var sheet = spreadsheet.getSheetByName('\uc0\u49324 \u54980 \u44288 \u47532 _A/S');\
\
    if (!sheet) \{\
        SpreadsheetApp.getUi().alert('\uc0\u49324 \u54980 \u44288 \u47532 _A/S \u49884 \u53944 \u47484  \u52286 \u51012  \u49688  \u50630 \u49845 \u45768 \u45796 .');\
        return;\
    \}\
\
    var lastRow = sheet.getLastRow();\
    var lastCol = sheet.getLastColumn();\
\
    if (lastRow < 1 || lastCol < 1) \{\
        SpreadsheetApp.getUi().alert('\uc0\u49884 \u53944 \u50640  \u45936 \u51060 \u53552 \u44032  \u50630 \u49845 \u45768 \u45796 .');\
        return;\
    \}\
\
    // \uc0\u51204 \u52404  \u45936 \u51060 \u53552  \u50689 \u50669 \u51032  \u45936 \u51060 \u53552  \u50976 \u54952 \u49457  \u44160 \u49324  \u51228 \u44144 \
    var dataRange = sheet.getRange(1, 1, lastRow, lastCol);\
    dataRange.clearDataValidations();\
\
    // \uc0\u54756 \u45908  \u51116 \u49444 \u51221 \
    var headers = [\
        '\uc0\u44256 \u44061 ID', '\u44256 \u44061 \u47749 ', '\u50672 \u46973 \u52376 ', '\u51060 \u47700 \u51068 ', '\u54788 \u51109 \u51452 \u49548 ',\
        '\uc0\u44592 \u48376  A/S \u49345 \u53468 ', '\u54868 \u51109 \u49892  A/S \u49345 \u53468 ',\
        '\uc0\u44277 \u49324 \u44592 \u44036 ', '\u51092 \u44552 \u51068 ',\
        '\uc0\u44592 \u48376  A/S \u48372 \u51613 \u51068 (\u44060 \u50900 )', '\u44592 \u48376  A/S \u44592 \u44036 ',\
        '\uc0\u54868 \u51109 \u49892  A/S \u48372 \u51613 \u51068 (\u44060 \u50900 )', '\u54868 \u51109 \u49892  A/S \u44592 \u44036 ',\
        '\uc0\u45812 \u45817 \u51088 ', '\u48708 \u44256 '\
    ];\
\
    // \uc0\u54756 \u45908  \u54665  \u50629 \u45936 \u51060 \u53944 \
    for (var i = 0; i < headers.length; i++) \{\
        sheet.getRange(1, i + 1).setValue(headers[i]);\
    \}\
\
    // \uc0\u54756 \u45908  \u49828 \u53440 \u51068  \u51201 \u50857 \
    var headerRange = sheet.getRange(1, 1, 1, headers.length);\
    headerRange.setBackground('#5C6BC0');\
    headerRange.setFontColor('#FFFFFF');\
    headerRange.setFontWeight('bold');\
    sheet.setFrozenRows(1);\
\
    SpreadsheetApp.getUi().alert('\uc0\u49324 \u54980 \u44288 \u47532 _A/S \u49884 \u53944  \u51221 \u47532  \u50756 \u47308 !\\n\u46300 \u47213 \u45796 \u50868 /\u52404 \u53356 \u48149 \u49828 \u44032  \u51228 \u44144 \u46104 \u50632 \u49845 \u45768 \u45796 .');\
\}\
\
\
function getAdmins(spreadsheet) \{\
    var sheet = spreadsheet.getSheetByName('\uc0\u44288 \u47532 \u51088 ');\
    if (!sheet || sheet.getLastRow() < 2) return [];\
    var data = sheet.getDataRange().getValues();\
    var admins = [];\
    for (var i = 1; i < data.length; i++) \{\
        var row = data[i];\
        if (row[0]) \{\
            admins.push(\{\
                id: row[0],\
                passwordHash: row[1],  // \uc0\u54644 \u49884 \u44050 \u51004 \u47196  \u51200 \u51109 \u46108  \u48708 \u48128 \u48264 \u54840 \
                name: row[2] || row[0],\
                createdAt: row[3]\
            \});\
        \}\
    \}\
    return admins;\
\}\
\
function saveAdmin(spreadsheet, adminData) \{\
    var sheet = spreadsheet.getSheetByName('\uc0\u44288 \u47532 \u51088 ');\
    if (!sheet) \{ sheet = spreadsheet.insertSheet('\uc0\u44288 \u47532 \u51088 '); initializeAdminSheet(sheet); \}\
    if (sheet.getLastRow() === 0) initializeAdminSheet(sheet);\
\
    var data = sheet.getDataRange().getValues();\
    var rowIndex = -1;\
    for (var i = 1; i < data.length; i++) \{\
        if (data[i][0] === adminData.id) \{ rowIndex = i + 1; break; \}\
    \}\
\
    // passwordHash \uc0\u46608 \u45716  password \u46168  \u45796  \u51648 \u50896 \
    var passwordValue = adminData.passwordHash || adminData.password || '';\
\
    var rowData = [\
        adminData.id,\
        passwordValue,  // \uc0\u54644 \u49884 \u44050  \u46608 \u45716  \u48708 \u48128 \u48264 \u54840 \
        adminData.name || adminData.id,\
        adminData.createdAt || new Date().toISOString()\
    ];\
\
    if (rowIndex > 0) \{\
        sheet.getRange(rowIndex, 1, 1, rowData.length).setValues([rowData]);\
        return 'updated';\
    \} else \{\
        sheet.appendRow(rowData);\
        return 'created';\
    \}\
\}\
\
function deleteAdmin(spreadsheet, adminId) \{\
    var sheet = spreadsheet.getSheetByName('\uc0\u44288 \u47532 \u51088 ');\
    if (!sheet) return false;\
    var data = sheet.getDataRange().getValues();\
    for (var i = 1; i < data.length; i++) \{\
        // String()\uc0\u51004 \u47196  \u48320 \u54872 \u54616 \u50668  \u48708 \u44368  (\u45936 \u51060 \u53552  \u53440 \u51077  \u48520 \u51068 \u52824  \u48169 \u51648 )\
        if (String(data[i][0]) === String(adminId)) \{\
            sheet.deleteRow(i + 1);\
            return true;\
        \}\
    \}\
    return false;\
\}\
\
// ==========================================\
// 5. \uc0\u53944 \u47532 \u44144  \u44288 \u47144  \u54632 \u49688  (Triggers)\
// ==========================================\
\
// [\uc0\u53944 \u47532 \u44144 ] onFormSubmit - \u49444 \u47928 \u51648  \u51025 \u45813  \u49884  "\u49345 \u45812 \u49345 \u53468 "\u47484  "\u49444 \u47928 \u51025 \u45813 "\u51004 \u47196  \u51088 \u46041  \u44592 \u51077 \
function onFormSubmit(e) \{\
    if (!e) return;\
\
    var sheet = e.range.getSheet();\
    var sheetName = sheet.getName();\
\
    // \uc0\u49444 \u47928 \u51648  \u51025 \u45813  \u49884 \u53944 \u50640 \u49436 \u47564  \u46041 \u51089 \
    if (sheetName !== '\uc0\u49444 \u47928 \u51648  \u51025 \u45813 ') return;\
\
    var row = e.range.getRow();\
    var statusColumn = 6; // F\uc0\u50676 : \u49345 \u45812 \u49345 \u53468 \
\
    // 1. \uc0\u49444 \u47928 \u51648  \u51025 \u45813  \u49884 \u53944 : \u49345 \u45812 \u49345 \u53468  "\u49444 \u47928 \u51025 \u45813 " \u51088 \u46041  \u44592 \u51077 \
    sheet.getRange(row, statusColumn).setValue('\uc0\u49444 \u47928 \u51025 \u45813 ');\
\
    // 2. \uc0\u49345 \u45812 \u44288 \u47532 _\u47560 \u49828 \u53552  \u49884 \u53944  \u46041 \u44592 \u54868 : \u51060 \u47492 /\u50672 \u46973 \u52376 \u47196  \u47588 \u52845 \u54616 \u50668  \u49345 \u53468  \u50629 \u45936 \u51060 \u53944 \
    try \{\
        updateMasterStatusIfExists(e.values);\
    \} catch (err) \{\
        console.error('Master sync failed: ' + err.toString());\
    \}\
\
    SpreadsheetApp.getActiveSpreadsheet().toast('\uc0\u49352  \u49444 \u47928  \u51025 \u45813 \u51060  \u46321 \u47197 \u46104 \u50632 \u49845 \u45768 \u45796 .', '\u49444 \u47928  \u51217 \u49688 ');\
\}\
\
// Helper: \uc0\u49444 \u47928  \u51025 \u45813  \u51221 \u48372 \u47484  \u48148 \u53461 \u51004 \u47196  \u49345 \u45812 \u44288 \u47532 _\u47560 \u49828 \u53552  \u49345 \u53468  \u50629 \u45936 \u51060 \u53944 \
function updateMasterStatusIfExists(rowValues) \{\
    // \uc0\u49444 \u47928 \u51648  \u51025 \u45813  \u52972 \u47100  \u44396 \u51312  (e.values):\
    // [0] \uc0\u53440 \u51076 \u49828 \u53484 \u54532 , [1] \u49457 \u54632 , [2] \u50672 \u46973 \u52376 , ...\
    if (!rowValues || rowValues.length < 3) return;\
\
    var name = rowValues[1];\
    var phone = rowValues[2];\
\
    var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();\
    var masterSheet = spreadsheet.getSheetByName('\uc0\u49345 \u45812 \u44288 \u47532 _\u47560 \u49828 \u53552 ');\
    if (!masterSheet) return;\
\
    var data = masterSheet.getDataRange().getValues();\
    // \uc0\u49345 \u45812 \u44288 \u47532 _\u47560 \u49828 \u53552 : [0] No, [1] Date, [2] Name, [3] Phone, ..., [7] Status\
\
    // \uc0\u52572 \u49888  \u49692 \u51004 \u47196  \u44160 \u49353  (\u50500 \u47000 \u50640 \u49436  \u50948 \u47196 )\
    for (var i = data.length - 1; i >= 1; i--) \{\
        var rowName = data[i][2];\
        var rowPhone = data[i][3];\
\
        if (rowName == name && rowPhone == phone) \{\
            // "\uc0\u49345 \u45812 \u47928 \u51032 \u51217 \u49688 " \u46608 \u45716  "\u49444 \u47928 \u48156 \u49569 " \u49345 \u53468 \u51068  \u46412 \u47564  "\u49444 \u47928 \u51025 \u45813 "\u51004 \u47196  \u48320 \u44221 \
            // (\uc0\u51060 \u48120  \u49345 \u45812 \u51060  \u51652 \u54665  \u51473 \u51060 \u44144 \u45208  \u44228 \u50557 \u46108  \u44148 \u51008  \u44148 \u46300 \u47532 \u51648  \u50506 \u51020 )\
            var currentStatus = data[i][7];\
            if (currentStatus === '\uc0\u49345 \u45812 \u47928 \u51032 \u51217 \u49688 ' || currentStatus === '\u49444 \u47928 \u48156 \u49569 ' || currentStatus === '') \{\
                masterSheet.getRange(i + 1, 8).setValue('\uc0\u49444 \u47928 \u51025 \u45813 '); // 8\u48264 \u51704  \u50676 (H)\u51060  \u49345 \u53468 \
                console.log('Updated Master Sheet status for: ' + name);\
            \}\
            break; // \uc0\u44032 \u51109  \u52572 \u44540  1\u44148 \u47564  \u50629 \u45936 \u51060 \u53944 \
        \}\
    \}\
\}\
\
// [\uc0\u53944 \u47532 \u44144 ] onEdit (\u49345 \u45812  \u49884 \u53944 \u50857 )\
\
function processStatusChange(e) \{\
    if (!e) return;\
    var range = e.range;\
    var sheet = range.getSheet();\
    var sheetName = sheet.getName();\
\
    // \uc0\u49345 \u45812 \u44288 \u47532 _\u47560 \u49828 \u53552  \u46608 \u45716  \u49444 \u47928 \u51648  \u51025 \u45813  \u49884 \u53944 \u50640 \u49436  \u46041 \u51089 \
    var statusColumn = -1;\
    if (sheetName === '\uc0\u49345 \u45812 \u44288 \u47532 _\u47560 \u49828 \u53552 ') \{\
        statusColumn = 8; // H\uc0\u50676 : \u49345 \u45812 \u49345 \u53468 \
    \} else if (sheetName === '\uc0\u49444 \u47928 \u51648  \u51025 \u45813 ') \{\
        statusColumn = 6; // F\uc0\u50676 : \u49345 \u45812 \u49345 \u53468 \
    \} else \{\
        return;\
    \}\
\
    if (range.getColumn() !== statusColumn) return;\
\
    var newStatus = e.value;\
    var rowNum = range.getRow();\
\
    // \uc0\u44204 \u51201 \u49436  \u8594  \u44256 \u44061 \u44288 \u47532 _\u44204 \u51201 \u49436 \u47196  \u48373 \u49324 \
    if (newStatus === '\uc0\u44204 \u51201 \u49436 ') \{\
        if (sheetName === '\uc0\u49444 \u47928 \u51648  \u51025 \u45813 ') \{\
            copyFromSurveyToCustomer(sheet, rowNum);\
        \} else \{\
            copyToCustomerSheet(sheet, rowNum);\
        \}\
    \}\
    // \uc0\u44228 \u50557 \u50756 \u47308  \u8594  \u49324 \u54980 \u44288 \u47532 _A/S\u47196  \u48373 \u49324 \
    else if (newStatus === '\uc0\u44228 \u50557 \u50756 \u47308 ') \{\
        moveRowToAS(sheet, rowNum);\
    \}\
\}\
\
// [\uc0\u44204 \u51201 \u49436 ] \u49444 \u47928 \u51648  \u51025 \u45813  \u8594  \u44256 \u44061 \u44288 \u47532 _\u44204 \u51201 \u49436  \u48373 \u49324  (\u50976 \u51077 \u44221 \u47196 , \u44148 \u47932 \u50976 \u54805 , \u54217 \u49688  \u54252 \u54632 )\
function copyFromSurveyToCustomer(sourceSheet, rowNum) \{\
    var spreadsheet = sourceSheet.getParent();\
    var targetSheet = spreadsheet.getSheetByName('\uc0\u44256 \u44061 \u44288 \u47532 _\u44204 \u51201 \u49436 ');\
\
    if (!targetSheet) \{\
        targetSheet = spreadsheet.insertSheet('\uc0\u44256 \u44061 \u44288 \u47532 _\u44204 \u51201 \u49436 ');\
        initializeCustomerSheet(targetSheet);\
    \}\
\
    var rowValues = sourceSheet.getRange(rowNum, 1, 1, sourceSheet.getLastColumn()).getValues()[0];\
    // \uc0\u49444 \u47928 \u51648  \u51025 \u45813  \u52972 \u47100 : 0:\u53440 \u51076 \u49828 \u53484 \u54532 , 1:\u49457 \u54632 , 2:\u50672 \u46973 \u52376 , 3:\u51060 \u47700 \u51068 , 4:\u54788 \u51109 \u51452 \u49548 , 5:\u49345 \u45812 \u49345 \u53468 ,\
    //                  6:Q1.\uc0\u50976 \u51077 \u44221 \u47196 , 7:Q2.\u44148 \u47932 \u50976 \u54805 , 8:Q3.\u54217 \u49688 , 9:Q4.\u50696 \u49328 \u48276 \u50948 , ...\
\
    // \uc0\u44256 \u44061 ID \u49373 \u49457  (YYMMDD-NNN \u54805 \u49885 )\
    var today = new Date();\
    var yy = String(today.getFullYear()).slice(-2);\
    var mm = String(today.getMonth() + 1).padStart(2, '0');\
    var dd = String(today.getDate()).padStart(2, '0');\
    var datePrefix = yy + mm + dd;\
\
    // \uc0\u44592 \u51316  \u44256 \u44061  \u49688  \u54869 \u51064 \u54616 \u50668  \u49692 \u48264  \u49373 \u49457  (\u52572 \u45824  \u48264 \u54840  + 1)\
    var existingData = targetSheet.getDataRange().getValues();\
    var maxNum = 0;\
    for (var i = 1; i < existingData.length; i++) \{\
        var existingId = existingData[i][0] || '';\
        if (existingId.toString().startsWith(datePrefix)) \{\
            var numPart = parseInt(existingId.toString().split('-')[1]) || 0;\
            if (numPart > maxNum) maxNum = numPart;\
        \}\
    \}\
    var customerId = datePrefix + '-' + String(maxNum + 1).padStart(3, '0');\
\
\
    // \uc0\u51473 \u48373  \u52404 \u53356  (\u44057 \u51008  \u50672 \u46973 \u52376  + \u51060 \u47492 \u51060  \u51060 \u48120  \u51080 \u45716 \u51648 )\
    var clientPhone = rowValues[2]; // \uc0\u49444 \u47928 \u51648  \u51025 \u45813 \u50640 \u49436  3\u48264 \u51704  \u52972 \u47100 \u51060  \u50672 \u46973 \u52376 \
    var clientName = rowValues[1];  // \uc0\u49444 \u47928 \u51648  \u51025 \u45813 \u50640 \u49436  2\u48264 \u51704  \u52972 \u47100 \u51060  \u49457 \u54632 \
    for (var j = 1; j < existingData.length; j++) \{\
        // \uc0\u44256 \u44061 \u44288 \u47532 _\u44204 \u51201 \u49436 : \u51064 \u45937 \u49828 3=\u49457 \u47749 , \u51064 \u45937 \u49828 4=\u50672 \u46973 \u52376 \
        if (existingData[j][4] === clientPhone && existingData[j][3] === clientName) \{\
            spreadsheet.toast('\uc0\u51060 \u48120  \u46321 \u47197 \u46108  \u44256 \u44061 \u51077 \u45768 \u45796 : ' + clientName, '\u51473 \u48373  \u50508 \u47548 ');\
            return;\
        \}\
    \}\
\
    // \uc0\u44256 \u44061 \u44288 \u47532 _\u44204 \u51201 \u49436  \u52972 \u47100 : \u44256 \u44061 ID, \u49345 \u53468 , \u49373 \u49457 \u51068 , \u49457 \u47749 , \u50672 \u46973 \u52376 , \u51060 \u47700 \u51068 , \u51452 \u49548 , \u44277 \u49324 \u47749 , \u54788 \u51109 \u51452 \u49548 , \u54217 \u54805 , \u50976 \u51077 \u44221 \u47196 , \u44148 \u47932 \u50976 \u54805 , \u44228 \u50557 \u51068 ...\
    var newRowData = [\
        customerId,                     // \uc0\u44256 \u44061 ID\
        '\uc0\u44204 \u51201 \u49436 ',                        // \u49345 \u53468 \
        new Date().toISOString().split('T')[0], // \uc0\u49373 \u49457 \u51068 \
        rowValues[1] || '',             // \uc0\u49457 \u47749  (\u49457 \u54632 )\
        rowValues[2] || '',             // \uc0\u50672 \u46973 \u52376 \
        rowValues[3] || '',             // \uc0\u51060 \u47700 \u51068 \
        '',                             // \uc0\u51452 \u49548  (\u48324 \u46020  \u51077 \u47141 )\
        '',                             // \uc0\u44277 \u49324 \u47749 \
        rowValues[4] || '',             // \uc0\u54788 \u51109 \u51452 \u49548 \
        rowValues[8] || '',             // \uc0\u54217 \u54805  (Q3.\u54217 \u49688 ) - I\u50676 \
        rowValues[6] || '',             // \uc0\u50976 \u51077 \u44221 \u47196  (Q1.\u50976 \u51077 \u44221 \u47196 ) - G\u50676 \
        rowValues[7] || '',             // \uc0\u44148 \u47932 \u50976 \u54805  (Q2.\u44148 \u47932 \u50976 \u54805 ) - H\u50676 \
        '',                             // \uc0\u44228 \u50557 \u51068 \
        '',                             // \uc0\u44277 \u49324 \u44592 \u44036 \
        '',                             // A/S \uc0\u44592 \u44036 \
        '',                             // \uc0\u44228 \u50557 \u44552 \u50529 \
        '',                             // \uc0\u51060 \u50980 \u50984 \
        ''                              // JSON\uc0\u45936 \u51060 \u53552 \
    ];\
\
    targetSheet.appendRow(newRowData);\
    spreadsheet.toast('\uc0\u49444 \u47928  \u44256 \u44061 \u51012  [\u44256 \u44061 \u44288 \u47532 _\u44204 \u51201 \u49436 ] \u49884 \u53944 \u47196  \u48373 \u49324 \u54664 \u49845 \u45768 \u45796 .\\n\u44256 \u44061 ID: ' + customerId, '\u48373 \u49324  \u50756 \u47308 ');\
\}\
\
// [\uc0\u44204 \u51201 \u49436 ] \u49345 \u45812 \u44288 \u47532 _\u47560 \u49828 \u53552  \u8594  \u44256 \u44061 \u44288 \u47532 _\u44204 \u51201 \u49436  \u48373 \u49324 \
function copyToCustomerSheet(sourceSheet, rowNum) \{\
    var spreadsheet = sourceSheet.getParent();\
    var targetSheet = spreadsheet.getSheetByName('\uc0\u44256 \u44061 \u44288 \u47532 _\u44204 \u51201 \u49436 ');\
\
    if (!targetSheet) \{\
        targetSheet = spreadsheet.insertSheet('\uc0\u44256 \u44061 \u44288 \u47532 _\u44204 \u51201 \u49436 ');\
        initializeCustomerSheet(targetSheet);\
    \}\
\
    var rowValues = sourceSheet.getRange(rowNum, 1, 1, sourceSheet.getLastColumn()).getValues()[0];\
    // \uc0\u49345 \u45812 \u44288 \u47532 _\u47560 \u49828 \u53552  \u52972 \u47100 : 0:No, 1:\u51217 \u49688 \u51068 \u49884 , 2:\u44256 \u44061 \u47749 , 3:\u50672 \u46973 \u52376 , 4:\u51060 \u47700 \u51068 , 5:\u54788 \u51109 \u51452 \u49548 , 6:\u47928 \u51032 \u45236 \u50857 , 7:\u49345 \u45812 \u49345 \u53468 \
\
    // \uc0\u44256 \u44061 ID \u49373 \u49457  (YYMMDD-NNN \u54805 \u49885 )\
    var today = new Date();\
    var yy = String(today.getFullYear()).slice(-2);\
    var mm = String(today.getMonth() + 1).padStart(2, '0');\
    var dd = String(today.getDate()).padStart(2, '0');\
    var datePrefix = yy + mm + dd;\
\
    // \uc0\u44592 \u51316  \u44256 \u44061  \u49688  \u54869 \u51064 \u54616 \u50668  \u49692 \u48264  \u49373 \u49457  (\u52572 \u45824  \u48264 \u54840  + 1)\
    var existingData = targetSheet.getDataRange().getValues();\
    var maxNum = 0;\
    for (var i = 1; i < existingData.length; i++) \{\
        var existingId = existingData[i][0] || '';\
        if (existingId.toString().startsWith(datePrefix)) \{\
            var numPart = parseInt(existingId.toString().split('-')[1]) || 0;\
            if (numPart > maxNum) maxNum = numPart;\
        \}\
    \}\
    var customerId = datePrefix + '-' + String(maxNum + 1).padStart(3, '0');\
\
\
    // \uc0\u51473 \u48373  \u52404 \u53356  (\u44057 \u51008  \u50672 \u46973 \u52376  + \u51060 \u47492 \u51060  \u51060 \u48120  \u51080 \u45716 \u51648 )\
    var clientPhone = rowValues[3];\
    var clientName = rowValues[2];\
    for (var j = 1; j < existingData.length; j++) \{\
        if (existingData[j][4] === clientPhone && existingData[j][3] === clientName) \{\
            spreadsheet.toast('\uc0\u51060 \u48120  \u46321 \u47197 \u46108  \u44256 \u44061 \u51077 \u45768 \u45796 : ' + clientName, '\u51473 \u48373  \u50508 \u47548 ');\
            return;\
        \}\
    \}\
\
    // \uc0\u44256 \u44061 \u44288 \u47532 _\u44204 \u51201 \u49436  \u52972 \u47100 : \u44256 \u44061 ID, \u49345 \u53468 , \u49373 \u49457 \u51068 , \u49457 \u47749 , \u50672 \u46973 \u52376 , \u51060 \u47700 \u51068 , \u51452 \u49548 , \u44277 \u49324 \u47749 , \u54788 \u51109 \u51452 \u49548 , \u54217 \u54805 , \u50976 \u51077 \u44221 \u47196 , \u44148 \u47932 \u50976 \u54805 , \u44228 \u50557 \u51068 ...\
    var newRowData = [\
        customerId,                     // \uc0\u44256 \u44061 ID\
        '\uc0\u44204 \u51201 \u49436 ',                        // \u49345 \u53468 \
        new Date().toISOString().split('T')[0], // \uc0\u49373 \u49457 \u51068 \
        rowValues[2] || '',             // \uc0\u49457 \u47749  (\u44256 \u44061 \u47749 )\
        rowValues[3] || '',             // \uc0\u50672 \u46973 \u52376 \
        rowValues[4] || '',             // \uc0\u51060 \u47700 \u51068 \
        '',                             // \uc0\u51452 \u49548  (\u48324 \u46020  \u51077 \u47141 )\
        '',                             // \uc0\u44277 \u49324 \u47749 \
        rowValues[5] || '',             // \uc0\u54788 \u51109 \u51452 \u49548 \
        '',                             // \uc0\u54217 \u54805 \
        '',                             // \uc0\u50976 \u51077 \u44221 \u47196 \
        '',                             // \uc0\u44148 \u47932 \u50976 \u54805 \
        '',                             // \uc0\u44228 \u50557 \u51068 \
        '',                             // \uc0\u44277 \u49324 \u44592 \u44036 \
        '',                             // A/S \uc0\u44592 \u44036 \
        '',                             // \uc0\u44228 \u50557 \u44552 \u50529 \
        '',                             // \uc0\u51060 \u50980 \u50984 \
        ''                              // JSON\uc0\u45936 \u51060 \u53552 \
    ];\
\
    targetSheet.appendRow(newRowData);\
    spreadsheet.toast('\uc0\u44256 \u44061  \u51221 \u48372 \u47484  [\u44256 \u44061 \u44288 \u47532 _\u44204 \u51201 \u49436 ] \u49884 \u53944 \u47196  \u48373 \u49324 \u54664 \u49845 \u45768 \u45796 .\\n\u44256 \u44061 ID: ' + customerId, '\u48373 \u49324  \u50756 \u47308 ');\
\}\
\
// [\uc0\u44228 \u50557 \u50756 \u47308 ] \u49345 \u45812 \u44288 \u47532 _\u47560 \u49828 \u53552  \u8594  \u49324 \u54980 \u44288 \u47532 _A/S \u48373 \u49324 \
function moveRowToAS(sourceSheet, rowNum) \{\
    var targetSheetName = '\uc0\u49324 \u54980 \u44288 \u47532 _A/S';\
    var spreadsheet = sourceSheet.getParent();\
    var targetSheet = spreadsheet.getSheetByName(targetSheetName);\
\
    if (!targetSheet) \{\
        targetSheet = spreadsheet.insertSheet(targetSheetName);\
        initializeAsSheet(targetSheet);\
    \}\
\
    var rowValues = sourceSheet.getRange(rowNum, 1, 1, sourceSheet.getLastColumn()).getValues()[0];\
\
    var newRowData = [\
        rowValues[0],         // No\
        rowValues[2],         // \uc0\u51060 \u47492 \
        rowValues[3],         // \uc0\u50672 \u46973 \u52376 \
        rowValues[4],         // \uc0\u51060 \u47700 \u51068 \
        rowValues[5],         // \uc0\u51452 \u49548 \
        '',                   // \uc0\u44592 \u48376  A/S \u49345 \u53468 \
        '',                   // \uc0\u54868 \u51109 \u49892  A/S \u49345 \u53468 \
        '',                   // \uc0\u44277 \u49324 \u44592 \u44036 \
        '',                   // \uc0\u51092 \u44552 \u51068 \
        12,                   // \uc0\u44592 \u48376  A/S \u48372 \u51613 \u51068 (\u44060 \u50900 )\
        '',                   // \uc0\u44592 \u48376  A/S \u44592 \u44036 \
        30,                   // \uc0\u54868 \u51109 \u49892  A/S \u48372 \u51613 \u51068 (\u44060 \u50900 )\
        '',                   // \uc0\u54868 \u51109 \u49892  A/S \u44592 \u44036 \
        '',                   // \uc0\u45812 \u45817 \u51088 \
        ''                    // \uc0\u48708 \u44256 \
    ];\
\
    targetSheet.appendRow(newRowData);\
    spreadsheet.toast('\uc0\u44256 \u44061  \u51221 \u48372 \u47484  [\u49324 \u54980 \u44288 \u47532 _A/S] \u49884 \u53944 \u47196  \u48373 \u49324 \u54664 \u49845 \u45768 \u45796 .', '\u48373 \u49324  \u50756 \u47308 ');\
\}\
\
// [\uc0\u54840 \u54872 \u49457  \u50976 \u51648 ] \u44592 \u51316  \u53944 \u47532 \u44144 (sendExpirationEmail)\u44032  \u51060  \u54632 \u49688 \u47484  \u54840 \u52636 \u54624  \u49688  \u51080 \u46020 \u47197  \u50672 \u44208 \
function sendExpirationEmail() \{\
    sendWarrantyExpirationEmails();\
\}\
\
// [\uc0\u53944 \u47532 \u44144 ] \u49884 \u44036  \u44592 \u48152  (\u51068  1\u54924 ) - \u44592 \u48376  A/S \u48143  \u54868 \u51109 \u49892  A/S \u50756 \u47308  \u51060 \u47700 \u51068  \u51088 \u46041  \u48156 \u49569 \
// [\uc0\u53944 \u47532 \u44144 ] \u49884 \u44036  \u44592 \u48152  (\u51068  1\u54924 ) - \u44592 \u48376  A/S \u48143  \u54868 \u51109 \u49892  A/S \u50756 \u47308  \u51060 \u47700 \u51068  \u51088 \u46041  \u48156 \u49569 \
function sendWarrantyExpirationEmails() \{\
    var targetSheetName = '\uc0\u49324 \u54980 \u44288 \u47532 _A/S';\
    var spreadsheet = SpreadsheetApp.openById(CONSULTING_SHEET_ID);\
    var sheet = spreadsheet.getSheetByName(targetSheetName);\
\
    if (!sheet) \{\
        console.error('\uc0\u50724 \u47448 : [' + targetSheetName + '] \u49884 \u53944 \u47484  \u52286 \u51012  \u49688  \u50630 \u49845 \u45768 \u45796 . \u49884 \u53944  \u51060 \u47492 \u51012  \u54869 \u51064 \u54644 \u51452 \u49464 \u50836 .');\
        return;\
    \}\
\
    var dataRange = sheet.getDataRange();\
    var values = dataRange.getValues();\
    var notes = dataRange.getNotes(); // [\uc0\u49688 \u51221 ] \u51060 \u47700 \u51068  \u51473 \u48373  \u48156 \u49569  \u48169 \u51648 \u47484  \u50948 \u54620  \u47700 \u47784  \u51069 \u44592 \
\
    if (values.length <= 1) \{\
        console.warn('\uc0\u44221 \u44256 : \u49884 \u53944 \u50640  \u45936 \u51060 \u53552 \u44032  \u50630 \u49845 \u45768 \u45796 .');\
        return;\
    \}\
\
    // \uc0\u54756 \u45908 \u50640 \u49436  \u52972 \u47100  \u51064 \u45937 \u49828  \u52286 \u44592  (\u44277 \u48177  \u51228 \u44144  \u54980  \u48708 \u44368 )\
    var headers = values[0].map(function (h) \{ return String(h).trim(); \});\
    console.log('\uc0\u44048 \u51648 \u46108  \u54756 \u45908 :', headers);\
\
    var IDX_NAME = headers.indexOf('\uc0\u44256 \u44061 \u47749 ');\
    var IDX_EMAIL = headers.indexOf('\uc0\u51060 \u47700 \u51068 ');\
\
    var IDX_STATUS_BASIC = headers.indexOf('\uc0\u44592 \u48376  A/S \u49345 \u53468 ');\
    var IDX_STATUS_BATH = headers.indexOf('\uc0\u54868 \u51109 \u49892  A/S \u49345 \u53468 ');\
\
    // \uc0\u44592 \u44036 (\u50756 \u47308 \u51068 ) \u52972 \u47100  - '\u44592 \u48376  A/S \u44592 \u44036 ' \u46608 \u45716  'A/S \u50756 \u47308 \u51068 '\
    var IDX_END_BASIC = headers.indexOf('\uc0\u44592 \u48376  A/S \u44592 \u44036 ');\
    if (IDX_END_BASIC === -1) IDX_END_BASIC = headers.indexOf('A/S \uc0\u50756 \u47308 \u51068 ');\
\
    var IDX_END_BATH = headers.indexOf('\uc0\u54868 \u51109 \u49892  A/S \u44592 \u44036 ');\
    if (IDX_END_BATH === -1) IDX_END_BATH = headers.indexOf('\uc0\u54868 \u51109 \u49892  \u45572 \u49688  \u48372 \u51613 \u51068 ');\
\
    console.log('\uc0\u51064 \u45937 \u49828  \u54869 \u51064  - \u44592 \u48376 \u49345 \u53468 :', IDX_STATUS_BASIC, ' / \u44592 \u48376 \u44592 \u44036 :', IDX_END_BASIC);\
    console.log('\uc0\u51064 \u45937 \u49828  \u54869 \u51064  - \u54868 \u51109 \u49892 \u49345 \u53468 :', IDX_STATUS_BATH, ' / \u54868 \u51109 \u49892 \u44592 \u44036 :', IDX_END_BATH);\
\
    if (IDX_STATUS_BASIC === -1 || IDX_END_BASIC === -1) \{\
        console.error('\uc0\u50724 \u47448 : \u54596 \u49688  \u52972 \u47100 (\u44592 \u48376  A/S \u49345 \u53468 /\u44592 \u44036 )\u51012  \u52286 \u51012  \u49688  \u50630 \u49845 \u45768 \u45796 .');\
    \}\
\
    var today = new Date();\
    today.setHours(0, 0, 0, 0);\
    console.log('\uc0\u50724 \u45720  \u45216 \u51676 (\u44592 \u51456 ):', today.toDateString());\
\
    var basicSentCount = 0;\
    var bathroomSentCount = 0;\
    var updatedCount = 0;\
\
    for (var i = 1; i < values.length; i++) \{\
        var row = values[i];\
        var rowNum = i + 1;\
\
        // \uc0\u51064 \u45937 \u49828 \u47484  \u47803  \u52286 \u50520 \u51004 \u47732  \u44592 \u48376 \u44050 (1, 3) \u49324 \u50857 \u54616 \u51648 \u47564 , \u50948 \u50640 \u49436  \u52286 \u50520 \u45796 \u44256  \u44032 \u51221 \
        var name = (IDX_NAME > -1) ? row[IDX_NAME] : row[1];\
        var email = (IDX_EMAIL > -1) ? row[IDX_EMAIL] : row[3];\
        var rowUpdated = false;\
\
        // 1. \uc0\u44592 \u48376  A/S \u50756 \u47308 \u51068  \u52404 \u53356 \
        var endDateVal = (IDX_END_BASIC > -1) ? row[IDX_END_BASIC] : '';\
        if (endDateVal) \{\
            // \uc0\u45216 \u51676  \u54028 \u49905  \u49884 \u46020 \
            var basicDate = (endDateVal instanceof Date) ? endDateVal : new Date(endDateVal);\
\
            if (!isNaN(basicDate.getTime())) \{\
                basicDate.setHours(0, 0, 0, 0);\
\
                // [\uc0\u49688 \u51221 ] \u45216 \u51676  \u52264 \u51060  \u44228 \u49328  (\u51068  \u45800 \u50948 )\
                var timeDiff = today.getTime() - basicDate.getTime();\
                var daysDiff = Math.floor(timeDiff / (1000 * 60 * 60 * 24));\
                var note = (notes[i] && IDX_END_BASIC > -1) ? notes[i][IDX_END_BASIC] : '';\
\
                // \uc0\u46356 \u48260 \u44613 : \u52395  3\u44060  \u54665 \u47564  \u49345 \u49464  \u47196 \u44613 \
                if (i <= 3) \{\
                    console.log('Row ' + rowNum + ' [\uc0\u44592 \u48376 ] \u47564 \u47308 \u51068 :', basicDate.toDateString(), '/ \u52264 \u51060 (\u51068 ):', daysDiff);\
                \}\
\
                // 1-1. \uc0\u44592 \u44036  \u47564 \u47308  \u52404 \u53356  (\u50724 \u45720  > \u51333 \u47308 \u51068 ) -> \u49345 \u53468  \u50629 \u45936 \u51060 \u53944 \
                // \uc0\u49345 \u53468  \u50629 \u45936 \u51060 \u53944 \u45716  \u51060 \u47700 \u51068  \u48156 \u49569  \u50668 \u48512 \u50752  \u49345 \u44288 \u50630 \u51060  \u45216 \u51676 \u44032  \u51648 \u45228 \u51004 \u47732  \u49688 \u54665 \
                if (daysDiff > 0) \{\
                    var currentStatus = (IDX_STATUS_BASIC > -1) ? row[IDX_STATUS_BASIC] : '';\
                    if (currentStatus !== 'A/S \uc0\u44592 \u44036 \u50756 \u47308 ' && IDX_STATUS_BASIC > -1) \{\
                        console.log('Update Row ' + rowNum + ' [\uc0\u44592 \u48376 ]: ' + currentStatus + ' -> A/S \u44592 \u44036 \u50756 \u47308 ');\
                        sheet.getRange(rowNum, IDX_STATUS_BASIC + 1).setValue('A/S \uc0\u44592 \u44036 \u50756 \u47308 ')\
                            .setBackground('#e0e0e0');\
                        rowUpdated = true;\
                    \}\
                \}\
\
                // 1-2. \uc0\u47700 \u51068  \u48156 \u49569  (\u50724 \u45720 \u48512 \u53552  7\u51068  \u51648 \u45212  \u49884 \u51216 \u44620 \u51648  \u51116 \u49884 \u46020  \u54728 \u50857 , \u47700 \u47784 \u47196  \u51473 \u48373  \u52404 \u53356 )\
                // daysDiff === 0 (\uc0\u45817 \u51068 ) \u46608 \u45716  1~7 (\u52572 \u44540  1\u51452 \u51068  \u45236  \u47564 \u47308 \u46108  \u44148  \u51473  \u45572 \u46973 \u46108  \u44163 )\
                if (daysDiff >= 0 && daysDiff <= 7) \{\
                    if (email && !note.includes('\uc0\u44592 \u48376 A/S\u47700 \u51068 \u48156 \u49569 \u50756 \u47308 ')) \{\
                        console.log('Email Row ' + rowNum + ' [\uc0\u44592 \u48376 ]: \u50508 \u47548  \u48156 \u49569  (Delay: ' + daysDiff + '\u51068 )');\
                        sendBasicAsExpirationEmail(email, name);\
\
                        // \uc0\u47700 \u47784  \u50629 \u45936 \u51060 \u53944  (\u48156 \u49569  \u44592 \u47197 )\
                        var newNote = note ? note + '\\n' : '';\
                        newNote += '\uc0\u44592 \u48376 A/S\u47700 \u51068 \u48156 \u49569 \u50756 \u47308 : ' + new Date().toLocaleDateString('ko-KR');\
                        sheet.getRange(rowNum, IDX_END_BASIC + 1).setNote(newNote);\
\
                        basicSentCount++;\
                    \} else if (daysDiff >= 0 && daysDiff <= 7 && note.includes('\uc0\u44592 \u48376 A/S\u47700 \u51068 \u48156 \u49569 \u50756 \u47308 ')) \{\
                        if (i <= 3) console.log('Row ' + rowNum + ' [\uc0\u44592 \u48376 ]: \u51060 \u48120  \u48156 \u49569 \u46120 ');\
                    \}\
                \}\
            \} else \{\
                if (i <= 3) console.warn('Row ' + rowNum + ' [\uc0\u44592 \u48376 ] \u45216 \u51676  \u54805 \u49885  \u50724 \u47448 :', endDateVal);\
            \}\
        \}\
\
        // 2. \uc0\u54868 \u51109 \u49892  \u45572 \u49688  \u48372 \u51613 \u51068  \u52404 \u53356 \
        var bathDateVal = (IDX_END_BATH > -1) ? row[IDX_END_BATH] : '';\
        if (bathDateVal) \{\
            var bathDate = (bathDateVal instanceof Date) ? bathDateVal : new Date(bathDateVal);\
            if (!isNaN(bathDate.getTime())) \{\
                bathDate.setHours(0, 0, 0, 0);\
\
                var timeDiff = today.getTime() - bathDate.getTime();\
                var daysDiff = Math.floor(timeDiff / (1000 * 60 * 60 * 24));\
                var note = (notes[i] && IDX_END_BATH > -1) ? notes[i][IDX_END_BATH] : '';\
\
                // 2-1. \uc0\u44592 \u44036  \u47564 \u47308  \u52404 \u53356 \
                if (daysDiff > 0) \{\
                    var currentStatus = (IDX_STATUS_BATH > -1) ? row[IDX_STATUS_BATH] : '';\
                    if (currentStatus !== 'A/S \uc0\u44592 \u44036 \u50756 \u47308 ' && IDX_STATUS_BATH > -1) \{\
                        console.log('Update Row ' + rowNum + ' [\uc0\u54868 \u51109 \u49892 ]: ' + currentStatus + ' -> A/S \u44592 \u44036 \u50756 \u47308 ');\
                        sheet.getRange(rowNum, IDX_STATUS_BATH + 1).setValue('A/S \uc0\u44592 \u44036 \u50756 \u47308 ')\
                            .setBackground('#e0e0e0');\
                        rowUpdated = true;\
                    \}\
                \}\
\
                // 2-2. \uc0\u47700 \u51068  \u48156 \u49569 \
                if (daysDiff >= 0 && daysDiff <= 7) \{\
                    if (email && !note.includes('\uc0\u54868 \u51109 \u49892 A/S\u47700 \u51068 \u48156 \u49569 \u50756 \u47308 ')) \{\
                        console.log('Email Row ' + rowNum + ' [\uc0\u54868 \u51109 \u49892 ]: \u50508 \u47548  \u48156 \u49569  (Delay: ' + daysDiff + '\u51068 )');\
                        sendBathroomAsExpirationEmail(email, name);\
\
                        var newNote = note ? note + '\\n' : '';\
                        newNote += '\uc0\u54868 \u51109 \u49892 A/S\u47700 \u51068 \u48156 \u49569 \u50756 \u47308 : ' + new Date().toLocaleDateString('ko-KR');\
                        sheet.getRange(rowNum, IDX_END_BATH + 1).setNote(newNote);\
\
                        bathroomSentCount++;\
                    \}\
                \}\
            \}\
        \}\
\
        if (rowUpdated) updatedCount++;\
    \}\
    console.log('\uc0\u50756 \u47308 : \u44592 \u48376 \u47700 \u51068 (' + basicSentCount + '), \u54868 \u51109 \u49892 \u47700 \u51068 (' + bathroomSentCount + '), \u49345 \u53468 \u48320 \u44221 (' + updatedCount + ')');\
\}\
\
// \uc0\u44592 \u48376  A/S \u48372 \u51613  \u44592 \u44036  \u50756 \u47308  \u51060 \u47700 \u51068 \
function sendBasicAsExpirationEmail(email, name) \{\
    var customerName = name || '\uc0\u44256 \u44061 ';\
    var subject = '[\uc0\u46356 \u51088 \u51064 \u51648 \u44536 ] ' + customerName + ' \u44256 \u44061 \u45784  A/S \u48372 \u51613 \u44592 \u44036  \u44221 \u44284  \u50504 \u45236 ';\
\
    var body = '\uc0\u50504 \u45397 \u54616 \u49464 \u50836 , ' + customerName + ' \u44256 \u44061 \u45784 .\\n' +\
        '\uc0\u46356 \u51088 \u51064 \u51648 \u44536 \u51077 \u45768 \u45796 .\\n\\n' +\
        '\uc0\u44256 \u44061 \u45784  \u44277 \u44036  \u49884 \u44277  \u54980  1\u45380 \u51060  \u51648 \u45228 \u49845 \u45768 \u45796 .\\n' +\
        'A/S \uc0\u48372 \u51613  \u44592 \u44036 \u51060  \u44221 \u44284 \u54616 \u50668  \\n' +\
        '\uc0\u54620  \u48264  \u45908  \u50504 \u48512  \u50668 \u52057 \u44256 \u51088  \u50672 \u46973 \u46300 \u47160 \u49845 \u45768 \u45796 .\\n\\n' +\
        '\uc0\u44536 \u46041 \u50504  \u49324 \u50857 \u54616 \u49884 \u47732 \u49436  \u48520 \u54200 \u54616 \u49888  \u51216 \u51008  \u50630 \u51004 \u49512 \u45716 \u51648 ,\\n' +\
        '\uc0\u54841 \u49884  \u54869 \u51064 \u51060  \u54596 \u50836 \u54620  \u48512 \u48516 \u51008  \u50630 \u51004 \u49888 \u51648  \u44417 \u44552 \u54633 \u45768 \u45796 .\\n\\n' +\
        '\uc0\u48372 \u51613  \u44592 \u44036 \u51060  \u51648 \u45208 \u45908 \u46972 \u46020 \\n' +\
        '\uc0\u46356 \u51088 \u51064 \u51648 \u44536 \u44032  \u49884 \u44277 \u54620  \u44277 \u44036 \u50640  \u45824 \u54620  \u44288 \u47532 \u50752  \u49345 \u45812 \u51008  \u44228 \u49549 \u46121 \u45768 \u45796 .\\n\\n' +\
        '\uc0\u49324 \u50857  \u51473  \u44417 \u44552 \u54616 \u49888  \u51216 \u51060 \u45208  \u51216 \u44160 \u51060  \u54596 \u50836 \u54616 \u49888  \u48512 \u48516 \u51060  \u51080 \u51004 \u49884 \u47732 \\n' +\
        '\uc0\u50616 \u51228 \u46304 \u51648  \u54200 \u54616 \u44172  \u50672 \u46973  \u51452 \u49884 \u44592  \u48148 \u46989 \u45768 \u45796 .\\n\\n' +\
        '\uc0\u44048 \u49324 \u54633 \u45768 \u45796 .\\n\\n' +\
        '\uc0\u46356 \u51088 \u51064 \u51648 \u44536  \u46300 \u47548 \\n\\n' +\
        '\uc0\u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \\n' +\
        'DESIGN JIG\\n' +\
        '\uc0\u44592 \u48376 \u51060  \u53444 \u53444 \u54644 \u50556  \u50500 \u47492 \u45796 \u50880 \u46020  \u50724 \u47000 \u44049 \u45768 \u45796 .\\n' +\
        'designjig.com';\
\
    try \{\
        GmailApp.sendEmail(email, subject, body, \{\
            name: SENDER_NAME,\
            from: SENDER_EMAIL\
        \});\
        console.log('\uc0\u44592 \u48376  A/S \u50756 \u47308  \u47700 \u51068  \u48156 \u49569 : ' + email);\
    \} catch (e) \{\
        console.log('\uc0\u47700 \u51068  \u48156 \u49569  \u50640 \u47084  (' + email + '): ' + e.toString());\
    \}\
\}\
\
// \uc0\u54868 \u51109 \u49892  \u45572 \u49688  \u48372 \u51613  \u44592 \u44036  \u50756 \u47308  \u51060 \u47700 \u51068 \
function sendBathroomAsExpirationEmail(email, name) \{\
    var customerName = name || '\uc0\u44256 \u44061 ';\
    var subject = '[\uc0\u46356 \u51088 \u51064 \u51648 \u44536 ] ' + customerName + ' \u44256 \u44061 \u45784  \u54868 \u51109 \u49892  \u45572 \u49688  \u48372 \u51613 \u44592 \u44036  \u44221 \u44284  \u50504 \u45236 ';\
\
    var body = '\uc0\u50504 \u45397 \u54616 \u49464 \u50836 , ' + customerName + ' \u44256 \u44061 \u45784 .\\n' +\
        '\uc0\u46356 \u51088 \u51064 \u51648 \u44536 \u51077 \u45768 \u45796 .\\n\\n' +\
        '\uc0\u44256 \u44061 \u45784  \u44277 \u44036  \u49884 \u44277  \u54980  2\u45380  6\u44060 \u50900 (30\u44060 \u50900 )\u51060  \u51648 \u45228 \u49845 \u45768 \u45796 .\\n' +\
        '\uc0\u54868 \u51109 \u49892  \u45572 \u49688  \u48372 \u51613  \u44592 \u44036 \u51060  \u44221 \u44284 \u54616 \u50668  \\n' +\
        '\uc0\u54620  \u48264  \u45908  \u50504 \u48512  \u50668 \u52057 \u44256 \u51088  \u50672 \u46973 \u46300 \u47160 \u49845 \u45768 \u45796 .\\n\\n' +\
        '\uc0\u44536 \u46041 \u50504  \u54868 \u51109 \u49892  \u49324 \u50857 \u50640  \u48520 \u54200 \u54632 \u51008  \u50630 \u51004 \u49512 \u45716 \u51648 ,\\n' +\
        '\uc0\u54841 \u49884  \u45572 \u49688  \u44288 \u47144  \u47928 \u51228 \u45716  \u50630 \u51004 \u49512 \u45716 \u51648  \u44417 \u44552 \u54633 \u45768 \u45796 .\\n\\n' +\
        '\uc0\u48372 \u51613  \u44592 \u44036 \u51060  \u51648 \u45208 \u45908 \u46972 \u46020 \\n' +\
        '\uc0\u46356 \u51088 \u51064 \u51648 \u44536 \u44032  \u49884 \u44277 \u54620  \u44277 \u44036 \u50640  \u45824 \u54620  \u44288 \u47532 \u50752  \u49345 \u45812 \u51008  \u44228 \u49549 \u46121 \u45768 \u45796 .\\n\\n' +\
        '\uc0\u49324 \u50857  \u51473  \u44417 \u44552 \u54616 \u49888  \u51216 \u51060 \u45208  \u51216 \u44160 \u51060  \u54596 \u50836 \u54616 \u49888  \u48512 \u48516 \u51060  \u51080 \u51004 \u49884 \u47732 \\n' +\
        '\uc0\u50500 \u47000  \u50672 \u46973 \u52376 \u47196  \u50616 \u51228 \u46304 \u51648  \u54200 \u54616 \u44172  \u50672 \u46973  \u51452 \u49884 \u44592  \u48148 \u46989 \u45768 \u45796 .\\n\\n' +\
        '\uc0\u44048 \u49324 \u54633 \u45768 \u45796 .\\n\\n' +\
        '\uc0\u46356 \u51088 \u51064 \u51648 \u44536  \u46300 \u47548 \\n\\n' +\
        '\uc0\u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \\n' +\
        'DESIGN JIG\\n' +\
        '\uc0\u44592 \u48376 \u51060  \u53444 \u53444 \u54644 \u50556  \u50500 \u47492 \u45796 \u50880 \u46020  \u50724 \u47000 \u44049 \u45768 \u45796 .\\n' +\
        'designjig.com';\
\
    try \{\
        GmailApp.sendEmail(email, subject, body, \{\
            name: SENDER_NAME,\
            from: SENDER_EMAIL\
        \});\
        console.log('\uc0\u54868 \u51109 \u49892  A/S \u50756 \u47308  \u47700 \u51068  \u48156 \u49569 : ' + email);\
    \} catch (e) \{\
        console.log('\uc0\u47700 \u51068  \u48156 \u49569  \u50640 \u47084  (' + email + '): ' + e.toString());\
    \}\
\}\
\
\
// ==========================================\
// 9. \uc0\u50896 \u44032 \u44288 \u47532 \u54364  \u45936 \u51060 \u53552  \u52376 \u47532  (Cost Management)\
// ==========================================\
\
/**\
 * A/S \uc0\u44288 \u47532  \u47532 \u49828 \u53944  \u45936 \u51060 \u53552  \u51312 \u54924  (GET)\
 * 'AS \uc0\u44288 \u47532  \u47532 \u49828 \u53944 ' \u49884 \u53944 \u50640 \u49436  \u45936 \u51060 \u53552 \u47484  \u51069 \u50612 \u50752  \u48152 \u54872 \
 */\
function handleASListGet(e) \{\
    try \{\
        var spreadsheet = SpreadsheetApp.openById(CUSTOMER_SHEET_ID);\
        // \uc0\u49884 \u53944  \u51060 \u47492  \u54869 \u51064  (\u46916 \u50612 \u50416 \u44592  \u50976 \u47924  \u46321  \u50976 \u50672 \u54616 \u44172  \u52376 \u47532 )\
        var sheet = spreadsheet.getSheetByName('AS \uc0\u44288 \u47532  \u47532 \u49828 \u53944 ');\
        if (!sheet) \{\
            sheet = spreadsheet.getSheetByName('AS\uc0\u44288 \u47532 \u47532 \u49828 \u53944 ');\
        \}\
        if (!sheet) \{\
            sheet = spreadsheet.getSheetByName('as_list');\
        \}\
\
        if (!sheet) \{\
            return ContentService.createTextOutput(JSON.stringify(\{\
                result: 'error',\
                message: "'AS \uc0\u44288 \u47532  \u47532 \u49828 \u53944 ' \u49884 \u53944 \u47484  \u52286 \u51012  \u49688  \u50630 \u49845 \u45768 \u45796 ."\
            \})).setMimeType(ContentService.MimeType.JSON);\
        \}\
\
        var rows = sheet.getDataRange().getValues();\
        var items = [];\
        var notices = [];\
\
        // 1\uc0\u54665 \u51008  \u54756 \u45908 \u51068  \u44032 \u45733 \u49457 \u51060  \u45458 \u51004 \u48064 \u47196  2\u54665 \u48512 \u53552  \u51069 \u51020 \
        // \uc0\u54756 \u45908 : \u52852 \u53580 \u44256 \u47532  | \u49464 \u48512 \u54637 \u47785  | \u48652 \u47004 \u46300  | \u49436 \u48708 \u49828 \u49468 \u53552  | \u48372 \u51613 \u44592 \u44036  | \u48708 \u44256 \
        for (var i = 1; i < rows.length; i++) \{\
            var row = rows[i];\
            // \uc0\u48712  \u54665  \u44148 \u45320 \u46832 \u44592 \
            if (!row[0] && !row[1] && !row[2]) continue;\
\
            // \uc0\u50976 \u51032 \u49324 \u54637  \u54665  \u52404 \u53356  (\u49828 \u52992 \u51460 \u54364 \u50752  \u46041 \u51068 \u54620  \u48169 \u49885  "AS \u44288 \u47532  \u50976 \u51032 \u49324 \u54637 " \u54841 \u51008  "\u50504 \u45236 \u49324 \u54637 ")\
            if (row[0] && (row[0].toString().indexOf('\uc0\u50976 \u51032 \u49324 \u54637 ') !== -1 || row[0].toString().indexOf('\u50504 \u45236 \u49324 \u54637 ') !== -1 || row[0].toString().indexOf('A/S') !== -1)) \{\
                var noticeText = row[1];\
                if (noticeText) notices.push(noticeText);\
            \} else \{\
                items.push(\{\
                    category: row[0] || '',\
                    brand: row[1] || '',\
                    item: row[2] || '',\
                    modelNum: row[3] || '',\
                    rank: row[4] || '',\
                    size: row[5] || '',\
                    price: row[6] || '',\
                    website: row[7] || '',\
                    service: row[8] || '',\
                    warranty: row[9] || '',\
                    note: row[10] || ''\
                \});\
            \}\
        \}\
\
        return ContentService.createTextOutput(JSON.stringify(\{\
            result: 'success',\
            items: items,\
            notices: notices\
        \})).setMimeType(ContentService.MimeType.JSON);\
\
    \} catch (err) \{\
        return ContentService.createTextOutput(JSON.stringify(\{\
            result: 'error',\
            error: err.toString()\
        \})).setMimeType(ContentService.MimeType.JSON);\
    \}\
\}\
\
/**\
 * \uc0\u50896 \u44032 \u44288 \u47532 \u54364  \u45936 \u51060 \u53552  \u51312 \u54924  (GET)\
 * Google Sheets\uc0\u50640 \u49436  \u50896 \u44032 \u44288 \u47532 \u54364  \u45936 \u51060 \u53552 \u47484  \u51069 \u50612 \u50741 \u45768 \u45796 .\
 */\
function handleCostGet(e) \{\
    try \{\
        var spreadsheet = SpreadsheetApp.openById(COST_SHEET_ID);\
\
        // '\uc0\u50896 \u44032 \u44288 \u47532 \u54364 \u45936 \u51060 \u53552 \u48288 \u51060 \u49828 ' \u49884 \u53944 \u47564  \u51069 \u44592 \
        var sheet = spreadsheet.getSheetByName('\uc0\u50896 \u44032 \u44288 \u47532 \u54364 \u45936 \u51060 \u53552 \u48288 \u51060 \u49828 ');\
        if (!sheet) \{\
            sheet = spreadsheet.getSheetByName('\uc0\u50896 \u44032 \u44288 \u47532 \u54364 '); // \u54841 \u49884  \u47784 \u47484  \u51687 \u51008  \u51060 \u47492 \u46020  \u52404 \u53356 \
        \}\
        if (!sheet) \{\
            return ContentService.createTextOutput(JSON.stringify(\{\
                error: '\uc0\u50896 \u44032 \u44288 \u47532 \u54364 \u45936 \u51060 \u53552 \u48288 \u51060 \u49828  \u49884 \u53944 \u47484  \u52286 \u51012  \u49688  \u50630 \u49845 \u45768 \u45796 .'\
            \})).setMimeType(ContentService.MimeType.JSON);\
        \}\
\
        var data = sheet.getDataRange().getValues();\
        var costData = [];\
        var memoData = \{\};  // \uc0\u52852 \u53580 \u44256 \u47532 \u48324  \u47700 \u47784  \u51200 \u51109 \
\
        // 2\uc0\u54665 (\u51064 \u45937 \u49828  1)\u51060  \u54756 \u45908 , 3\u54665 (\u51064 \u45937 \u49828  2)\u48512 \u53552  \u45936 \u51060 \u53552 \
        // 1\uc0\u54665 : \u51228 \u47785 , 2\u54665 : \u52972 \u47100  \u54756 \u45908  (\u52852 \u53580 \u44256 \u47532 , NO, \u44396 \u48516 , \u54408 \u47749 ...), 3\u54665 ~: \u45936 \u51060 \u53552 \
        var startRow = 2;\
\
        for (var i = startRow; i < data.length; i++) \{\
            var row = data[i];\
\
            // \uc0\u48712  \u54665  \u44148 \u45320 \u46832 \u44592 \
            if (!row[0] && !row[1] && !row[2]) continue;\
\
            // A\uc0\u50676 : \u52852 \u53580 \u44256 \u47532 , B\u50676 : NO \u46608 \u45716  MEMO, C\u50676 : \u44396 \u48516 /\u47700 \u47784 \u48264 \u54840 , D\u50676 : \u54408 \u47749 /\u47700 \u47784 \u45236 \u50857 \
            var category = row[0] ? row[0].toString().trim() : '';\
            var noOrMemo = row[1] ? row[1].toString().trim() : '';\
            var div = row[2] ? row[2].toString().trim() : '';\
            var name = row[3] ? row[3].toString().trim() : '';\
\
            // \uc0\u54756 \u45908  \u54665  \u44148 \u45320 \u46832 \u44592 \
            if (category === '\uc0\u52852 \u53580 \u44256 \u47532 ' || noOrMemo === 'NO' || div === '\u44396 \u48516 ') continue;\
\
            // MEMO \uc0\u54665  \u52376 \u47532 \
            if (noOrMemo === 'MEMO' || noOrMemo === '\uc0\u47700 \u47784 ') \{\
                if (!memoData[category]) \{\
                    memoData[category] = [];\
                \}\
                memoData[category].push(\{\
                    no: div,  // \uc0\u47700 \u47784  \u48264 \u54840  (1, 2, 3...)\
                    content: name  // \uc0\u47700 \u47784  \u45236 \u50857  (D\u50676 )\
                \});\
                continue;\
            \}\
\
            // \uc0\u52852 \u53580 \u44256 \u47532 \u44032  \u50630 \u51004 \u47732  \u45936 \u51060 \u53552  \u50500 \u45784 \
            if (!category) continue;\
\
            // \uc0\u51068 \u48152  \u45936 \u51060 \u53552  \u54665 \
            costData.push(\{\
                no: noOrMemo || '',\
                category: category,\
                div: div,\
                name: name,\
                spec: row[4] || '',\
                unit: row[5] || '',\
                qty: row[6] || '',\
                price: row[7] || '',\
                total: row[8] || ''\
            \});\
        \}\
\
        return ContentService.createTextOutput(JSON.stringify(\{\
            success: true,\
            data: costData,\
            memos: memoData,\
            lastUpdated: new Date().toISOString()\
        \})).setMimeType(ContentService.MimeType.JSON);\
\
    \} catch (err) \{\
        return ContentService.createTextOutput(JSON.stringify(\{\
            error: err.toString()\
        \})).setMimeType(ContentService.MimeType.JSON);\
    \}\
\}\
\
\
/**\
 * [DISABLED] \uc0\u50896 \u44032 \u44288 \u47532 \u54364  \u45936 \u51060 \u53552 \u48288 \u51060 \u49828  \u50629 \u45936 \u51060 \u53944  (POST)\
 * \uc0\u47560 \u49828 \u53552  \u45936 \u51060 \u53552  \u51221 \u54633 \u49457 \u51012  \u50948 \u54644  API\u47484  \u53685 \u54620  \u50416 \u44592  \u44428 \u54620 \u51060  \u51228 \u44144 \u46104 \u50632 \u49845 \u45768 \u45796 .\
 */\
function handleCostUpdate(payload) \{\
    return ContentService.createTextOutput(JSON.stringify(\{\
        success: false,\
        error: 'Master DB (Cost) is read-only via API.'\
    \})).setMimeType(ContentService.MimeType.JSON);\
\}\
\
// \uc0\u50896 \u48376  \u47196 \u51649  \u48372 \u51316  (\u54596 \u50836 \u49884  \u48177 \u50629  \u52280 \u44256 )\
/*\
function handleCostUpdate_ORIGINAL(payload) \{\
    try \{\
        var costData = payload.data || [];\
        var memoData = payload.memos || \{\};\
\
        var spreadsheet = SpreadsheetApp.openById(COST_SHEET_ID);\
        var sheet = spreadsheet.getSheetByName('\uc0\u50896 \u44032 \u44288 \u47532 \u54364 \u45936 \u51060 \u53552 \u48288 \u51060 \u49828 ');\
        if (!sheet) \{\
            sheet = spreadsheet.getSheetByName('\uc0\u50896 \u44032 \u44288 \u47532 \u54364 ');\
        \}\
\
        if (!sheet) \{\
            return ContentService.createTextOutput(JSON.stringify(\{\
                error: '\uc0\u50896 \u44032 \u44288 \u47532 \u54364 \u45936 \u51060 \u53552 \u48288 \u51060 \u49828  \u49884 \u53944 \u47484  \u52286 \u51012  \u49688  \u50630 \u49845 \u45768 \u45796 .'\
            \})).setMimeType(ContentService.MimeType.JSON);\
        \}\
\
        // \uc0\u44592 \u51316  \u45936 \u51060 \u53552  \u50689 \u50669  \u54869 \u51064  (3\u54665 \u48512 \u53552  \u49884 \u51089  - 1\u54665  \u51228 \u47785 , 2\u54665  \u54756 \u45908 )\
        var lastRow = sheet.getLastRow();\
\
        // \uc0\u54756 \u45908  \u50976 \u51648 \u54616 \u44256  \u45936 \u51060 \u53552  \u50689 \u50669 \u47564  \u49325 \u51228  (3\u54665  \u51060 \u54980 )\
        if (lastRow > 2) \{\
            sheet.getRange(3, 1, lastRow - 2, 9).clearContent();\
        \}\
\
        // \uc0\u52852 \u53580 \u44256 \u47532 \u48324 \u47196  \u45936 \u51060 \u53552  \u51221 \u47148 \
        var categoryOrder = ['\uc0\u44032 \u49444 \u44277 \u49324 ', '\u52384 \u44144 \u44277 \u49324 ', '\u49444 \u48708 /\u48169 \u49688 \u44277 \u49324 ', '\u54869 \u51109 /\u45800 \u50676 \u44277 \u49324 ', '\u52285 \u54840 \u44277 \u49324 ',\
            '\uc0\u51204 \u44592 /\u51312 \u47749 \u44277 \u49324 ', '\u50640 \u50612 \u52968  \u44277 \u49324 ', '\u47785 \u44277 /\u46020 \u50612 \u44277 \u49324 ', '\u54596 \u47492 \u44277 \u49324 ', '\u53440 \u51068 \u44277 \u49324 ',\
            '\uc0\u50837 \u49892 \u44277 \u49324 ', '\u46020 \u51109 \u44277 \u49324 ', '\u46020 \u48176 \u44277 \u49324 ', '\u48148 \u45797 \u51116 ', '\u44032 \u44396 \u44277 \u49324 ', '\u47560 \u44048 \u44277 \u49324 ', '\u44592 \u53440 \u44277 \u49324 '];\
\
        // \uc0\u49352  \u45936 \u51060 \u53552  \u50416 \u44592 \
        var rows = [];\
        var isFirstCategory = true;\
\
        // \uc0\u52852 \u53580 \u44256 \u47532  \u49692 \u49436 \u45824 \u47196  \u45936 \u51060 \u53552  \u51221 \u47148 \
        categoryOrder.forEach(function (category) \{\
            var categoryRows = [];\
\
            // \uc0\u54644 \u45817  \u52852 \u53580 \u44256 \u47532 \u51032  \u51068 \u48152  \u45936 \u51060 \u53552 \
            var categoryData = costData.filter(function (item) \{\
                return item.category === category;\
            \});\
\
            categoryData.forEach(function (item) \{\
                categoryRows.push([\
                    category,\
                    item.no || '',\
                    item.div || '',\
                    item.name || '',\
                    item.spec || '',\
                    item.unit || '',\
                    item.qty || '',\
                    item.price || '',\
                    item.total || ''\
                ]);\
            \});\
\
            // \uc0\u54644 \u45817  \u52852 \u53580 \u44256 \u47532 \u51032  \u47700 \u47784  \u45936 \u51060 \u53552 \
            if (memoData[category] && memoData[category].length > 0) \{\
                memoData[category].forEach(function (memo) \{\
                    categoryRows.push([\
                        category,\
                        'MEMO',\
                        memo.no || '',\
                        memo.content || '',\
                        '', '', '', '', ''\
                    ]);\
                \});\
            \}\
\
            // [\uc0\u52628 \u44032  \u50836 \u52397 ] \u44277 \u51221 \u51060  \u45149 \u45208 \u47732  5\u54665  \u50668 \u50976 \u44277 \u44036  \u52628 \u44032 \
            if (categoryRows.length > 0) \{\
                // \uc0\u52395  \u48264 \u51704  \u52852 \u53580 \u44256 \u47532 \u44032  \u50500 \u45768 \u44256 , \u45936 \u51060 \u53552 \u44032  \u51080 \u45796 \u47732  \u50948 \u50640  5\u51460  \u44277 \u48177  \u52628 \u44032 \
                if (!isFirstCategory) \{\
                    for (var k = 0; k < 5; k++) \{\
                        rows.push(['', '', '', '', '', '', '', '', '']);\
                    \}\
                \}\
\
                // \uc0\u45936 \u51060 \u53552  \u52628 \u44032 \
                rows = rows.concat(categoryRows);\
                isFirstCategory = false; // \uc0\u51060 \u51228  \u52395  \u48264 \u51704 \u44032  \u50500 \u45784 \
            \}\
        \});\
\
        // \uc0\u45936 \u51060 \u53552 \u44032  \u51080 \u51004 \u47732  \u54620  \u48264 \u50640  \u50416 \u44592 \
        if (rows.length > 0) \{\
            sheet.getRange(3, 1, rows.length, 9).setValues(rows);\
        \}\
\
        return ContentService.createTextOutput(JSON.stringify(\{\
            success: true,\
            message: '\uc0\u50896 \u44032 \u44288 \u47532 \u54364 \u44032  \u51200 \u51109 \u46104 \u50632 \u49845 \u45768 \u45796 .',\
            rowsUpdated: rows.length\
        \})).setMimeType(ContentService.MimeType.JSON);\
\
    \} catch (err) \{\
        // ...\
    \}\
\}\
*/\
\
// ==========================================\
// 10. \uc0\u49368 \u54540  \u44204 \u51201 \u49436  \u44592 \u45733 \
// ==========================================\
\
const SAMPLE_ESTIMATE_SHEET_NAME = '\uc0\u49368 \u54540 \u44204 \u51201 \u49884 \u53944 ';\
\
/**\
 * \uc0\u49368 \u54540  \u44204 \u51201 \u49436  \u51200 \u51109 \
 */\
function handleSaveSampleEstimate(payload) \{\
    try \{\
        var spreadsheet = SpreadsheetApp.openById(CUSTOMER_SHEET_ID);\
        var sheet = spreadsheet.getSheetByName(SAMPLE_ESTIMATE_SHEET_NAME);\
\
        if (!sheet) \{\
            // \uc0\u49884 \u53944 \u44032  \u50630 \u51004 \u47732  \u49373 \u49457 \
            sheet = spreadsheet.insertSheet(SAMPLE_ESTIMATE_SHEET_NAME);\
            sheet.appendRow(['ID', '\uc0\u51228 \u47785 ', '\u44204 \u51201 \u45936 \u51060 \u53552 ', '\u51060 \u50980 \u50984 ', '\u47700 \u47784 ', '\u51089 \u49457 \u51088 ', '\u51089 \u49457 \u51068 ']);\
        \}\
\
        var sampleId = 'SAMPLE_' + new Date().getTime();\
        var createdAt = new Date().toLocaleDateString('ko-KR');\
\
        sheet.appendRow([\
            sampleId,\
            payload.title || '\uc0\u51228 \u47785  \u50630 \u51020 ',\
            JSON.stringify(payload.estimateData || \{\}),\
            payload.estimateProfitRate || 15,\
            JSON.stringify(payload.estimateMemos || \{\}),\
            payload.createdBy || 'unknown',\
            createdAt\
        ]);\
\
        return ContentService.createTextOutput(JSON.stringify(\{\
            success: true,\
            id: sampleId,\
            message: '\uc0\u49368 \u54540 \u51060  \u51200 \u51109 \u46104 \u50632 \u49845 \u45768 \u45796 '\
        \})).setMimeType(ContentService.MimeType.JSON);\
\
    \} catch (err) \{\
        return ContentService.createTextOutput(JSON.stringify(\{\
            success: false,\
            error: err.toString()\
        \})).setMimeType(ContentService.MimeType.JSON);\
    \}\
\}\
\
/**\
 * \uc0\u49368 \u54540  \u44204 \u51201 \u49436  \u47785 \u47197  \u51312 \u54924 \
 */\
function handleGetSampleEstimates() \{\
    try \{\
        var spreadsheet = SpreadsheetApp.openById(CUSTOMER_SHEET_ID);\
        var sheet = spreadsheet.getSheetByName(SAMPLE_ESTIMATE_SHEET_NAME);\
\
        if (!sheet || sheet.getLastRow() < 2) \{\
            return ContentService.createTextOutput(JSON.stringify(\{\
                success: true,\
                samples: []\
            \})).setMimeType(ContentService.MimeType.JSON);\
        \}\
\
        var data = sheet.getDataRange().getValues();\
        var samples = [];\
\
        for (var i = 1; i < data.length; i++) \{\
            samples.push(\{\
                id: data[i][0],\
                title: data[i][1],\
                createdBy: data[i][5],\
                createdAt: data[i][6]\
            \});\
        \}\
\
        // \uc0\u52572 \u49888 \u49692  \u51221 \u47148 \
        samples.reverse();\
\
        return ContentService.createTextOutput(JSON.stringify(\{\
            success: true,\
            samples: samples\
        \})).setMimeType(ContentService.MimeType.JSON);\
\
    \} catch (err) \{\
        return ContentService.createTextOutput(JSON.stringify(\{\
            success: false,\
            error: err.toString()\
        \})).setMimeType(ContentService.MimeType.JSON);\
    \}\
\}\
\
/**\
 * \uc0\u49368 \u54540  \u44204 \u51201 \u49436  \u49345 \u49464  \u51312 \u54924 \
 */\
function handleGetSampleEstimate(sampleId) \{\
    try \{\
        var spreadsheet = SpreadsheetApp.openById(CUSTOMER_SHEET_ID);\
        var sheet = spreadsheet.getSheetByName(SAMPLE_ESTIMATE_SHEET_NAME);\
\
        if (!sheet) \{\
            return ContentService.createTextOutput(JSON.stringify(\{\
                success: false,\
                error: '\uc0\u49368 \u54540  \u49884 \u53944 \u44032  \u50630 \u49845 \u45768 \u45796 '\
            \})).setMimeType(ContentService.MimeType.JSON);\
        \}\
\
        var data = sheet.getDataRange().getValues();\
\
        for (var i = 1; i < data.length; i++) \{\
            if (data[i][0] === sampleId) \{\
                var sample = \{\
                    id: data[i][0],\
                    title: data[i][1],\
                    estimateData: JSON.parse(data[i][2] || '\{\}'),\
                    estimateProfitRate: data[i][3],\
                    estimateMemos: JSON.parse(data[i][4] || '\{\}'),\
                    createdBy: data[i][5],\
                    createdAt: data[i][6]\
                \};\
\
                return ContentService.createTextOutput(JSON.stringify(\{\
                    success: true,\
                    sample: sample\
                \})).setMimeType(ContentService.MimeType.JSON);\
            \}\
        \}\
\
        return ContentService.createTextOutput(JSON.stringify(\{\
            success: false,\
            error: '\uc0\u49368 \u54540 \u51012  \u52286 \u51012  \u49688  \u50630 \u49845 \u45768 \u45796 '\
        \})).setMimeType(ContentService.MimeType.JSON);\
\
    \} catch (err) \{\
        return ContentService.createTextOutput(JSON.stringify(\{\
            success: false,\
            error: err.toString()\
        \})).setMimeType(ContentService.MimeType.JSON);\
    \}\
\}\
\
/**\
 * \uc0\u49368 \u54540  \u44204 \u51201 \u49436  \u49325 \u51228 \
 */\
function handleDeleteSampleEstimate(payload) \{\
    try \{\
        var spreadsheet = SpreadsheetApp.openById(CUSTOMER_SHEET_ID);\
        var sheet = spreadsheet.getSheetByName(SAMPLE_ESTIMATE_SHEET_NAME);\
\
        if (!sheet) \{\
            return ContentService.createTextOutput(JSON.stringify(\{\
                success: false,\
                error: '\uc0\u49368 \u54540  \u49884 \u53944 \u44032  \u50630 \u49845 \u45768 \u45796 '\
            \})).setMimeType(ContentService.MimeType.JSON);\
        \}\
\
        var data = sheet.getDataRange().getValues();\
\
        for (var i = 1; i < data.length; i++) \{\
            if (data[i][0] === payload.id) \{\
                sheet.deleteRow(i + 1);\
\
                return ContentService.createTextOutput(JSON.stringify(\{\
                    success: true,\
                    message: '\uc0\u49368 \u54540 \u51060  \u49325 \u51228 \u46104 \u50632 \u49845 \u45768 \u45796 '\
                \})).setMimeType(ContentService.MimeType.JSON);\
            \}\
        \}\
\
        return ContentService.createTextOutput(JSON.stringify(\{\
            success: false,\
            error: '\uc0\u49368 \u54540 \u51012  \u52286 \u51012  \u49688  \u50630 \u49845 \u45768 \u45796 '\
        \})).setMimeType(ContentService.MimeType.JSON);\
\
    \} catch (err) \{\
        return ContentService.createTextOutput(JSON.stringify(\{\
            success: false,\
            error: err.toString()\
        \})).setMimeType(ContentService.MimeType.JSON);\
    \}\
\}\
\
/**\
 * \uc0\u50896 \u44032 \u44288 \u47532 \u54364  \u45936 \u51060 \u53552 \u48288 \u51060 \u49828  \u48373 \u44396  (\u51204 \u52404  \u45934 \u50612 \u50416 \u44592 )\
 */\
function handleRestoreCostDatabase(payload) \{\
    try \{\
        var spreadsheet = SpreadsheetApp.openById(COST_SHEET_ID);\
        var sheetName = '\uc0\u50896 \u44032 \u44288 \u47532 \u54364 \u45936 \u51060 \u53552 \u48288 \u51060 \u49828 ';\
        var sheet = spreadsheet.getSheetByName(sheetName);\
\
        if (!sheet) \{\
            sheet = spreadsheet.insertSheet(sheetName);\
        \}\
\
        var rows = payload.data; // [[\uc0\u45824 \u48516 \u47448 , No, \u44396 \u48516 , \u54408 \u47749 , ...], ...]\
\
        if (!rows || !Array.isArray(rows)) \{\
            return ContentService.createTextOutput(JSON.stringify(\{\
                success: false,\
                message: "\uc0\u45936 \u51060 \u53552  \u54805 \u49885 \u51060  \u50732 \u48148 \u47476 \u51648  \u50506 \u49845 \u45768 \u45796 ."\
            \})).setMimeType(ContentService.MimeType.JSON);\
        \}\
\
        // 1. \uc0\u45936 \u51060 \u53552  \u50976 \u49892  \u48169 \u51648 : \u47784 \u46304  \u54665  \u51473  \u44032 \u51109  \u44596  \u44600 \u51060 \u47484  \u44592 \u51456 \u51004 \u47196  \u53685 \u51068 \
        var maxCols = 0;\
        for (var i = 0; i < rows.length; i++) \{\
            if (rows[i].length > maxCols) maxCols = rows[i].length;\
        \}\
\
        // \uc0\u52572 \u49548  9\u50676  \u54869 \u48372 \
        if (maxCols < 9) maxCols = 9;\
\
        // 2. \uc0\u47784 \u46304  \u54665 \u51032  \u44600 \u51060 \u47484  maxCols\u47196  \u47582 \u52644  (\u48712  \u44050  \u52292 \u50864 \u44592 )\
        var normalizedRows = rows.map(function (row) \{\
            while (row.length < maxCols) \{\
                row.push('');\
            \}\
            return row;\
        \});\
\
        // 3. [\uc0\u52628 \u44032  \u50836 \u52397 ] \u44277 \u51221 (\u52852 \u53580 \u44256 \u47532 ) \u44036  5\u51460  \u46916 \u50864 \u44592 \
        var finalRows = [];\
        var lastCategory = '';\
        var emptyRow = new Array(maxCols).fill('');\
\
        for (var i = 0; i < normalizedRows.length; i++) \{\
            var row = normalizedRows[i];\
            var currentCategory = String(row[0] || '').trim();\
\
            // \uc0\u51060 \u51204  \u52852 \u53580 \u44256 \u47532 \u44032  \u51080 \u44256 , \u54788 \u51116  \u52852 \u53580 \u44256 \u47532 \u50752  \u45796 \u47476 \u47732  5\u51460  \u46916 \u50864 \u44592 \
            if (lastCategory && currentCategory && currentCategory !== lastCategory) \{\
                for (var k = 0; k < 5; k++) \{\
                    finalRows.push([...emptyRow]);\
                \}\
            \}\
\
            finalRows.push(row);\
\
            // \uc0\u52852 \u53580 \u44256 \u47532  \u44081 \u49888  (\u48712  \u44050 \u51060  \u50500 \u45776  \u46412 \u47564 )\
            if (currentCategory) lastCategory = currentCategory;\
        \}\
\
        // \uc0\u51204 \u52404  \u52488 \u44592 \u54868  \u54980  \u45796 \u49884  \u50416 \u44592 \
        sheet.clear();\
\
        // \uc0\u54756 \u45908  \u51089 \u49457  (9\u44060  \u52972 \u47100  \u54364 \u51456 )\
        sheet.appendRow(['\uc0\u45824 \u48516 \u47448 ', 'No', '\u44396 \u48516 ', '\u54408 \u47749 ', '\u44508 \u44201 ', '\u45800 \u50948 ', '\u49688 \u47049 ', '\u45800 \u44032 ', '\u54633 \u44228 ']);\
\
        // \uc0\u45936 \u51060 \u53552  \u50416 \u44592 \
        if (finalRows.length > 0) \{\
            // \uc0\u54665  \u44060 \u49688 \u47564 \u53372  \u50416 \u44592 \
            sheet.getRange(2, 1, finalRows.length, maxCols).setValues(finalRows);\
        \}\
\
        return ContentService.createTextOutput(JSON.stringify(\{\
            success: true,\
            message: finalRows.length + "\uc0\u44060  \u54637 \u47785 (\u44277 \u48177  \u54252 \u54632 ) \u51200 \u51109  \u50756 \u47308 "\
        \})).setMimeType(ContentService.MimeType.JSON);\
\
    \} catch (err) \{\
        return ContentService.createTextOutput(JSON.stringify(\{\
            success: false,\
            message: "\uc0\u49436 \u48260  \u50724 \u47448 : " + err.toString()\
        \})).setMimeType(ContentService.MimeType.JSON);\
    \}\
\}\
\
// Helper to safely get spreadsheet\
function getTargetSpreadsheet(id) \{\
    try \{\
        var active = SpreadsheetApp.getActiveSpreadsheet();\
        if (active) return active;\
    \} catch (e) \{\
        // standalone script or no active sheet\
    \}\
    return SpreadsheetApp.openById(id);\
\}\
\
// -------------------------------------------------------------\
// [\uc0\u52628 \u44032 ] \u44277 \u51221 \u48324  \u52404 \u53356 \u47532 \u49828 \u53944  \u45936 \u51060 \u53552  \u48520 \u47084 \u50724 \u44592 \
// -------------------------------------------------------------\
function handleChecklistGet(e) \{\
    try \{\
        var spreadsheet = getTargetSpreadsheet(CUSTOMER_SHEET_ID);\
\
        // 1. [\uc0\u47700 \u51064 ] \u50976 \u51200 \u44032  \u51648 \u51221 \u54620  \u51060 \u47492 : '\u44277 \u51221  \u52404 \u53356 \u47532 \u49828 \u53944 '\
        var sheet = spreadsheet.getSheetByName('\uc0\u44277 \u51221  \u52404 \u53356 \u47532 \u49828 \u53944 ');\
\
        // 2. [Fallback] \uc0\u46916 \u50612 \u50416 \u44592  \u50630 \u51020 \
        if (!sheet) sheet = spreadsheet.getSheetByName('\uc0\u44277 \u51221 \u52404 \u53356 \u47532 \u49828 \u53944 ');\
\
        // 3. [Fallback] \uc0\u44592 \u51316 /\u50689 \u47928  \u51060 \u47492 \
        if (!sheet) sheet = spreadsheet.getSheetByName('\uc0\u44277 \u51221 \u48324  \u52404 \u53356 \u47532 \u49828 \u53944 ');\
        if (!sheet) sheet = spreadsheet.getSheetByName('checklist');\
\
        if (!sheet) \{\
            // [\uc0\u46356 \u48260 \u44613 ] \u54788 \u51116  \u49884 \u53944  \u47785 \u47197  \u47196 \u44613 \
            var allSheets = spreadsheet.getSheets().map(function (s) \{ return s.getName(); \});\
            return ContentService.createTextOutput(JSON.stringify(\{\
                success: false,\
                message: '\uc0\u44277 \u51221  \u52404 \u53356 \u47532 \u49828 \u53944  \u49884 \u53944 \u47484  \u52286 \u51012  \u49688  \u50630 \u49845 \u45768 \u45796 . (\u44160 \u49353 \u46108  \u49884 \u53944 : ' + allSheets.join(', ') + ')'\
            \})).setMimeType(ContentService.MimeType.JSON);\
        \}\
\
        var data = sheet.getDataRange().getValues();\
        if (data.length < 2) \{\
            return ContentService.createTextOutput(JSON.stringify(\{\
                success: true,\
                data: [],\
                count: 0\
            \})).setMimeType(ContentService.MimeType.JSON);\
        \}\
\
        var headers = data[0];\
        var rows = data.slice(1);\
\
        var checklistItems = rows.map(function (row) \{\
            var item = \{\};\
            headers.forEach(function (header, index) \{\
                // \uc0\u49884 \u53944  \u54756 \u45908  \u51060 \u47492 \u51012  \u44536 \u45824 \u47196  \u53412 \u44050 \u51004 \u47196  \u49324 \u50857  ('\u48264 \u54840 ', '\u54637 \u47785 ', '\u45236 \u50857 ', '\u51652 \u54665 \u45800 \u44228 ', '\u48516 \u47448 ', '\u48708 \u44256 ')\
                item[header] = row[index] || '';\
            \});\
            return item;\
        \}).filter(function (item) \{\
            // \uc0\u48264 \u54840 \u44032  \u51080 \u45716  \u54665 \u47564  \u50976 \u54952 \u54620  \u44163 \u51004 \u47196  \u44036 \u51452 \
            return item['\uc0\u48264 \u54840 '];\
        \});\
\
        return ContentService.createTextOutput(JSON.stringify(\{\
            success: true,\
            data: checklistItems,\
            count: checklistItems.length\
        \})).setMimeType(ContentService.MimeType.JSON);\
\
    \} catch (error) \{\
        return ContentService.createTextOutput(JSON.stringify(\{\
            success: false,\
            message: '\uc0\u52404 \u53356 \u47532 \u49828 \u53944  \u45936 \u51060 \u53552  \u47196 \u46300  \u49892 \u54056 : ' + error.toString()\
        \})).setMimeType(ContentService.MimeType.JSON);\
    \}\
\}\
\
\
// ==========================================\
// 12. \uc0\u51221 \u49328  \u44288 \u47532  \u45824 \u51109  (Settlement Management)\
// ==========================================\
\
// [\uc0\u52628 \u44032 ] \u51221 \u49328  \u44288 \u47532  \u45824 \u51109  \u50741 \u49496  \u47560 \u49828 \u53552  \u51312 \u54924 \
function handleGetSettlementOptions(e) \{\
    try \{\
        var spreadsheet = SpreadsheetApp.openById(CUSTOMER_SHEET_ID);\
        // [\uc0\u49688 \u51221 ] \u49892 \u51228  \u49884 \u53944  \u51060 \u47492 : "\u51221 \u49328  \u44288 \u47532  \u45824 \u51109 "\
        var sheet = spreadsheet.getSheetByName('\uc0\u51221 \u49328  \u44288 \u47532  \u45824 \u51109 ');\
\
        // Fallback: \uc0\u45796 \u47480  \u44032 \u45733 \u54620  \u51060 \u47492 \u46308  \u49884 \u46020 \
        if (!sheet) sheet = spreadsheet.getSheetByName('\uc0\u51221 \u49328 \u44288 \u47532 \u45824 \u51109 ');\
        if (!sheet) sheet = spreadsheet.getSheetByName('\uc0\u51221 \u49328 \u50741 \u49496 \u47560 \u49828 \u53552 ');\
\
        if (!sheet) \{\
            // \uc0\u49884 \u53944 \u44032  \u50630 \u51004 \u47732  \u48712  \u48176 \u50676  \u48152 \u54872 \
            return ContentService.createTextOutput(JSON.stringify(\{\
                result: 'success',\
                options: [],\
                message: '\uc0\u51221 \u49328  \u44288 \u47532  \u45824 \u51109  \u49884 \u53944 \u47484  \u52286 \u51012  \u49688  \u50630 \u49845 \u45768 \u45796 .'\
            \})).setMimeType(ContentService.MimeType.JSON);\
        \}\
\
        var data = sheet.getDataRange().getValues();\
        if (data.length < 2) \{\
            return ContentService.createTextOutput(JSON.stringify(\{\
                result: 'success',\
                options: []\
            \})).setMimeType(ContentService.MimeType.JSON);\
        \}\
\
        // \uc0\u54756 \u45908  \u44592 \u48152  \u51064 \u45937 \u49828  \u52286 \u44592 \
        var headers = data[0];\
        // [\uc0\u49688 \u51221 ] \u49892 \u51228  \u44396 \u44544  \u49884 \u53944  \u54756 \u45908  \u48152 \u50689 : \u52852 \u53580 \u44256 \u47532 , \u44277 \u51221 \u48516 \u47448 , \u44144 \u47000 \u52376 /\u51089 \u50629 \u51088 , \u48708 \u50857 \u44396 \u48516 , \u45824 \u44552 \u48169 \u49885 , \u49324 \u50629 \u51088 /\u51452 \u48124 \u48264 \u54840 , \u51008 \u54665 \u47749 /\u50696 \u44552 \u51452 /\u44228 \u51340 \u48264 \u54840 , \u48708 \u44256 \
        var idx = \{\
            category: Math.max(headers.indexOf('\uc0\u52852 \u53580 \u44256 \u47532 '), headers.indexOf('\u48516 \u47448 ')),\
            process: Math.max(headers.indexOf('\uc0\u44277 \u51221 \u48516 \u47448 '), headers.indexOf('\u44277 \u51221 '), headers.indexOf('\u44277 \u51221 \u47749 ')),\
            client: Math.max(headers.indexOf('\uc0\u44144 \u47000 \u52376 /\u51089 \u50629 \u51088 '), headers.indexOf('\u44144 \u47000 \u52376 ')),\
            costType: headers.indexOf('\uc0\u48708 \u50857 \u44396 \u48516 '),\
            payType: headers.indexOf('\uc0\u45824 \u44552 \u48169 \u49885 '),\
            bizId: Math.max(headers.indexOf('\uc0\u49324 \u50629 \u51088 /\u51452 \u48124 \u48264 \u54840 '), headers.indexOf('\u49324 \u50629 \u51088 \u48264 \u54840 ')),\
            bankInfo: Math.max(headers.indexOf('\uc0\u51008 \u54665 \u47749 /\u50696 \u44552 \u51452 /\u44228 \u51340 \u48264 \u54840 '), headers.indexOf('\u44228 \u51340 \u51221 \u48372 ')),\
            note: headers.indexOf('\uc0\u48708 \u44256 ')\
        \};\
\
        // \uc0\u51064 \u45937 \u49828  \u44208 \u51221  (\u47803  \u52286 \u51004 \u47732  \u44592 \u48376 \u44050 )\
        // \uc0\u51064 \u45937 \u49828  \u44208 \u51221 \
        var iCat = idx.category;\
        var iProc = idx.process;\
        var iClient = idx.client;\
        var iCost = idx.costType;\
        var iPay = idx.payType;\
        var iBiz = idx.bizId;\
        var iBank = idx.bankInfo;\
        var iNote = idx.note;\
\
        // \uc0\u54596 \u49688  \u44050  fallback\
        if (iCat === -1) iCat = 0;\
\
        var options = [];\
        for (var i = 1; i < data.length; i++) \{\
            var row = data[i];\
            if (row[iCat]) \{ // \uc0\u52852 \u53580 \u44256 \u47532 \u44032  \u51080 \u45716  \u44221 \u50864 \u47564 \
                options.push(\{\
                    category: row[iCat] || '',\
                    process: row[iProc] || '',\
                    client: row[iClient] || '',\
                    costType: (iCost > -1 ? row[iCost] : '') || '',\
                    payType: (iPay > -1 ? row[iPay] : '') || '',\
                    bizId: (iBiz > -1 ? row[iBiz] : '') || '',\
                    bankInfo: (iBank > -1 ? row[iBank] : '') || '',\
                    note: (iNote > -1 ? row[iNote] : '') || ''\
                \});\
            \}\
        \}\
\
        return ContentService.createTextOutput(JSON.stringify(\{\
            result: 'success',\
            options: options\
        \})).setMimeType(ContentService.MimeType.JSON);\
\
    \} catch (err) \{\
        return ContentService.createTextOutput(JSON.stringify(\{\
            result: 'error',\
            error: err.toString()\
        \})).setMimeType(ContentService.MimeType.JSON);\
    \}\
\}\
\
function handleSettlementGet(e) \{\
    try \{\
        var customerId = e.parameter.customerId;\
        if (!customerId) \{\
            throw new Error('\uc0\u44256 \u44061  ID\u44032  \u54596 \u50836 \u54633 \u45768 \u45796 .');\
        \}\
\
        var spreadsheet = SpreadsheetApp.openById(CUSTOMER_SHEET_ID);\
        var sheet = spreadsheet.getSheetByName(SETTLEMENT_SHEET_NAME);\
\
        if (!sheet) \{\
            return ContentService.createTextOutput(JSON.stringify(\{\
                result: 'success',\
                rows: []\
            \})).setMimeType(ContentService.MimeType.JSON);\
        \}\
\
        var data = sheet.getDataRange().getValues();\
        if (data.length < 2) \{\
            return ContentService.createTextOutput(JSON.stringify(\{\
                result: 'success',\
                rows: []\
            \})).setMimeType(ContentService.MimeType.JSON);\
        \}\
\
        var rows = [];\
        // \uc0\u54756 \u45908  \u44592 \u48152  \u51064 \u45937 \u49828  \u52286 \u44592 \
        var headers = data[0];\
        // \uc0\u50696 \u49345  \u54756 \u45908 : \u44256 \u44061 ID, \u44256 \u44061 \u47749 , \u48516 \u47448 , \u44277 \u51221 , \u44144 \u47000 \u52376 , \u48708 \u50857 \u44396 \u48516 , \u51648 \u52636 \u51613 \u48729 (or \u45824 \u44552 \u48169 \u49885 ), \u49324 \u50629 \u51088 \u48264 \u54840 , \u44228 \u51340 \u51221 \u48372 , \u44208 \u51228 \u44552 \u50529 , \u44208 \u51228 \u51068 , \u44208 \u51228 \u49345 \u53468 , \u48708 \u44256 \
        var idx = \{\
            id: headers.indexOf('\uc0\u44256 \u44061 ID'),\
            category: headers.indexOf('\uc0\u48516 \u47448 '),\
            process: headers.indexOf('\uc0\u44277 \u51221 '),\
            client: headers.indexOf('\uc0\u44144 \u47000 \u52376 '),\
            costType: headers.indexOf('\uc0\u48708 \u50857 \u44396 \u48516 '),\
            payType: headers.indexOf('\uc0\u51648 \u52636 \u51613 \u48729 '), // \u44396 \u44544 \u49884 \u53944  \u54756 \u45908 \u47749  '\u51648 \u52636 \u51613 \u48729 '\
            payType2: headers.indexOf('\uc0\u45824 \u44552 \u48169 \u49885 '), // \u54840 \u54872 \u49457 \
            bizId: headers.indexOf('\uc0\u49324 \u50629 \u51088 \u48264 \u54840 '),\
            bankInfo: headers.indexOf('\uc0\u44228 \u51340 \u51221 \u48372 '),\
            payAmount: headers.indexOf('\uc0\u44208 \u51228 \u44552 \u50529 '),\
            payDate: headers.indexOf('\uc0\u44208 \u51228 \u51068 '),\
            payStatus: headers.indexOf('\uc0\u44208 \u51228 \u49345 \u53468 '),\
            note: headers.indexOf('\uc0\u48708 \u44256 ')\
        \};\
\
        var iId = idx.id > -1 ? idx.id : 0;\
        var iCat = idx.category > -1 ? idx.category : 2;\
        var iProc = idx.process > -1 ? idx.process : 3;\
        var iClient = idx.client > -1 ? idx.client : 4;\
        var iCost = idx.costType > -1 ? idx.costType : 5;\
        var iPayType = idx.payType > -1 ? idx.payType : (idx.payType2 > -1 ? idx.payType2 : 6);\
        var iBiz = idx.bizId > -1 ? idx.bizId : 7;\
        var iBank = idx.bankInfo > -1 ? idx.bankInfo : 8;\
        var iAmount = idx.payAmount > -1 ? idx.payAmount : 9;\
        var iDate = idx.payDate > -1 ? idx.payDate : 10;\
        var iStatus = idx.payStatus > -1 ? idx.payStatus : 11;\
        var iNote = idx.note > -1 ? idx.note : 12;\
\
        for (var i = 1; i < data.length; i++) \{\
            var row = data[i];\
            if (row[iId].toString() === customerId.toString()) \{\
                rows.push(\{\
                    category: row[iCat],\
                    process: row[iProc],\
                    client: row[iClient],\
                    costType: row[iCost],\
                    payType: row[iPayType],\
                    bizId: row[iBiz],\
                    bankInfo: row[iBank],\
                    payAmount: row[iAmount],\
                    payDate: row[iDate] ? formatDate(row[iDate]) : '',\
                    payStatus: row[iStatus],\
                    note: row[iNote]\
                \});\
            \}\
        \}\
\
        return ContentService.createTextOutput(JSON.stringify(\{\
            result: 'success',\
            rows: rows\
        \})).setMimeType(ContentService.MimeType.JSON);\
\
    \} catch (err) \{\
        return ContentService.createTextOutput(JSON.stringify(\{\
            result: 'error',\
            error: err.toString()\
        \})).setMimeType(ContentService.MimeType.JSON);\
    \}\
\}\
\
function handleSettlementUpdate(payload) \{\
    try \{\
        var customerId = payload.customerId;\
        var customerName = payload.customerName || '';\
        var rowsData = payload.rows || [];\
\
        if (!customerId) throw new Error('\uc0\u44256 \u44061  ID\u44032  \u45572 \u46973 \u46104 \u50632 \u49845 \u45768 \u45796 .');\
\
        var spreadsheet = SpreadsheetApp.openById(CUSTOMER_SHEET_ID);\
        var sheet = spreadsheet.getSheetByName(SETTLEMENT_SHEET_NAME);\
\
        if (!sheet) \{\
            sheet = spreadsheet.insertSheet(SETTLEMENT_SHEET_NAME);\
            sheet.appendRow([\
                '\uc0\u44256 \u44061 ID', '\u44256 \u44061 \u47749 ', '\u48516 \u47448 ', '\u44277 \u51221 ', '\u44144 \u47000 \u52376 ', '\u48708 \u50857 \u44396 \u48516 ',\
                '\uc0\u51648 \u52636 \u51613 \u48729 ', '\u49324 \u50629 \u51088 \u48264 \u54840 ', '\u44228 \u51340 \u51221 \u48372 ', '\u44208 \u51228 \u44552 \u50529 ', '\u44208 \u51228 \u51068 ', '\u44208 \u51228 \u49345 \u53468 ', '\u48708 \u44256 ', '\u49688 \u51221 \u51068 '\
            ]);\
        \}\
\
        // \uc0\u44592 \u51316  \u45936 \u51060 \u53552  \u49325 \u51228  (\u54644 \u45817  \u44256 \u44061 ID)\
        var data = sheet.getDataRange().getValues();\
        /*\
          \uc0\u54665  \u49325 \u51228  \u49884  \u50500 \u47000 \u50640 \u49436  \u50948 \u47196  \u49325 \u51228 \u54644 \u50556  \u51064 \u45937 \u49828 \u44032  \u44844 \u51060 \u51648  \u50506 \u51020 .\
          \uc0\u47784 \u46304  \u45936 \u51060 \u53552 \u47484  \u51069 \u50612 \u49436  \u47700 \u47784 \u47532 \u50640 \u49436  \u54596 \u53552 \u47553  \u54980  \u45796 \u49884  \u50416 \u45716  \u48169 \u49885 \u46020  \u51080 \u51648 \u47564 ,\
          \uc0\u45936 \u51060 \u53552 \u44032  \u47566 \u50500 \u51648 \u47732  \u47700 \u47784 \u47532  \u51060 \u49800 \u44032  \u51080 \u51012  \u49688  \u51080 \u51020 .\
          \uc0\u50668 \u44592 \u49436 \u45716  \u44536 \u45285  \u47336 \u54532  \u46028 \u47732 \u49436  \u49325 \u51228 .\
        */\
        for (var i = data.length - 1; i >= 1; i--) \{\
            if (data[i][0].toString() === customerId.toString()) \{\
                sheet.deleteRow(i + 1);\
            \}\
        \}\
\
        // \uc0\u49352  \u45936 \u51060 \u53552  \u52628 \u44032 \
        var newRows = [];\
        var now = new Date().toLocaleString('ko-KR');\
\
        rowsData.forEach(function (item) \{\
            newRows.push([\
                customerId,\
                customerName,\
                item.category || '',\
                item.process || '',\
                item.client || '',\
                item.costType || '',\
                item.payType || '',\
                item.bizId || '',\
                item.bankInfo || '',\
                item.payAmount || 0,\
                item.payDate || '',\
                item.payStatus || '\uc0\u48120 \u51648 \u44553 ',\
                item.note || '',\
                now\
            ]);\
        \});\
\
        if (newRows.length > 0) \{\
            // \uc0\u54620  \u48264 \u50640  \u50416 \u44592  (appendRow \u48152 \u48373 \u48372 \u45796  \u48736 \u47492 )\
            sheet.getRange(sheet.getLastRow() + 1, 1, newRows.length, newRows[0].length).setValues(newRows);\
        \}\
\
        return ContentService.createTextOutput(JSON.stringify(\{\
            result: 'success',\
            count: newRows.length\
        \})).setMimeType(ContentService.MimeType.JSON);\
\
    \} catch (err) \{\
        return ContentService.createTextOutput(JSON.stringify(\{\
            result: 'error',\
            error: err.toString()\
        \})).setMimeType(ContentService.MimeType.JSON);\
    \}\
\}\
\
// \uc0\u45216 \u51676  \u54252 \u47607  \u54764 \u54140  (YYYY-MM-DD)\
function formatDate(date) \{\
    if (!date) return '';\
    if (typeof date === 'string') return date.substring(0, 10);\
    try \{\
        var d = new Date(date);\
        var year = d.getFullYear();\
        var month = ('0' + (d.getMonth() + 1)).slice(-2);\
        var day = ('0' + d.getDate()).slice(-2);\
        return year + '-' + month + '-' + day;\
    \} catch (e) \{\
        return date;\
    \}\
\}\
\
// ==========================================\
// 12. \uc0\u50868 \u50689 \u48708  \u44288 \u47532  \u45824 \u51109  (Expenses Management)\
// ==========================================\
\
/**\
 * \uc0\u50868 \u50689 \u48708  \u44288 \u47532  \u45824 \u51109  \u51312 \u54924  (GET)\
 * - \uc0\u49884 \u53944  \u51060 \u47492 : "\u50868 \u50689 \u48708  \u44288 \u47532  \u45824 \u51109 " \u46608 \u45716  "\u50868 \u50689 \u48708 \u44288 \u47532 "\
 * - \uc0\u44256 \u51221 \u51648 \u52636  \u49444 \u51221 \u46020  \u54632 \u44760  \u48152 \u54872 \
 */\
function handleExpensesGet(e) \{\
    try \{\
        var spreadsheet = SpreadsheetApp.openById(CUSTOMER_SHEET_ID);\
        var sheet = spreadsheet.getSheetByName('\uc0\u50868 \u50689 \u48708  \u44288 \u47532  \u45824 \u51109 ');\
        if (!sheet) sheet = spreadsheet.getSheetByName('\uc0\u50868 \u50689 \u48708 \u44288 \u47532 ');\
        if (!sheet) sheet = spreadsheet.getSheetByName('\uc0\u50868 \u50689 \u48708  \u44288 \u47532 ');\
\
        if (!sheet) \{\
            // \uc0\u49884 \u53944 \u44032  \u50630 \u51004 \u47732  \u49373 \u49457 \
            sheet = spreadsheet.insertSheet('\uc0\u50868 \u50689 \u48708  \u44288 \u47532  \u45824 \u51109 ');\
            var headers = ['No', '\uc0\u45216 \u51676 ', '\u45824 \u48516 \u47448 ', '\u49345 \u49464 \u45236 \u50669 ', '\u44552 \u50529 ', '\u44208 \u51228 \u49688 \u45800 ', '\u51613 \u48729 \u51088 \u47308 ', '\u48708 \u44256 '];\
            sheet.appendRow(headers);\
            var headerRange = sheet.getRange(1, 1, 1, headers.length);\
            headerRange.setBackground('#4CAF50');\
            headerRange.setFontColor('#ffffff');\
            headerRange.setFontWeight('bold');\
            sheet.setFrozenRows(1);\
        \}\
\
        var lastRow = sheet.getLastRow();\
        var expenses = [];\
\
        if (lastRow >= 2) \{\
            var data = sheet.getRange(2, 1, lastRow - 1, 8).getValues();\
            for (var i = 0; i < data.length; i++) \{\
                var row = data[i];\
                if (row[1] || row[2] || row[3]) \{ // \uc0\u45216 \u51676 , \u45824 \u48516 \u47448 , \u49345 \u49464 \u45236 \u50669  \u51473  \u54616 \u45208 \u46972 \u46020  \u51080 \u51004 \u47732 \
                    expenses.push(\{\
                        no: row[0] || (i + 1),\
                        date: formatDate(row[1]),\
                        category: row[2] || '',\
                        detail: row[3] || '',\
                        amount: row[4] || 0,\
                        payMethod: row[5] || '',\
                        receipt: row[6] || '',\
                        memo: row[7] || ''\
                    \});\
                \}\
            \}\
        \}\
\
        // \uc0\u44256 \u51221 \u51648 \u52636  \u49444 \u51221  \u51312 \u54924  (\u48324 \u46020  \u49884 \u53944  \u46608 \u45716  \u49444 \u51221  \u50689 \u50669 )\
        var fixedExpenses = [];\
        var fixedSheet = spreadsheet.getSheetByName('\uc0\u44256 \u51221 \u51648 \u52636  \u49444 \u51221 ');\
        if (fixedSheet && fixedSheet.getLastRow() >= 2) \{\
            // [\uc0\u49688 \u51221 ] 6\u44060  \u52972 \u47100  \u51069 \u44592  (\u45824 \u48516 \u47448 , \u49345 \u49464 \u45236 \u50669 , \u44552 \u50529 , \u44208 \u51228 \u49688 \u45800 , \u51613 \u48729 \u51088 \u47308 , \u54876 \u49457 \u54868 )\
            var fixedData = fixedSheet.getRange(2, 1, fixedSheet.getLastRow() - 1, 6).getValues();\
            for (var j = 0; j < fixedData.length; j++) \{\
                var fRow = fixedData[j];\
                // \uc0\u45824 \u48516 \u47448 \u45208  \u49345 \u49464 \u45236 \u50669 \u51060  \u51080 \u51004 \u47732  \u50976 \u54952 \u54620  \u45936 \u51060 \u53552 \u47196  \u44036 \u51452 \
                if (fRow[0] || fRow[1]) \{\
                    fixedExpenses.push(\{\
                        category: fRow[0] || '',\
                        detail: fRow[1] || '',\
                        amount: fRow[2] || 0,\
                        payMethod: fRow[3] || '',\
                        receipt: fRow[4] || '',\
                        active: fRow[5] !== 'N' // \uc0\u44592 \u48376  \u54876 \u49457 \u54868  ('N'\u51068  \u46412 \u47564  false)\
                    \});\
                \}\
            \}\
        \}\
\
        return ContentService.createTextOutput(JSON.stringify(\{\
            result: 'success',\
            expenses: expenses,\
            fixedExpenses: fixedExpenses\
        \})).setMimeType(ContentService.MimeType.JSON);\
\
    \} catch (err) \{\
        return ContentService.createTextOutput(JSON.stringify(\{\
            result: 'error',\
            error: err.toString()\
        \})).setMimeType(ContentService.MimeType.JSON);\
    \}\
\}\
\
/**\
 * \uc0\u50868 \u50689 \u48708  \u44288 \u47532  \u45824 \u51109  \u51200 \u51109  (POST)\
 * - payload.expenses: \uc0\u50868 \u50689 \u48708  \u45936 \u51060 \u53552  \u48176 \u50676 \
 * - payload.fixedExpenses: \uc0\u44256 \u51221 \u51648 \u52636  \u49444 \u51221  \u48176 \u50676  (\u49440 \u53469 \u49324 \u54637 )\
 */\
function handleExpensesUpdate(payload) \{\
    try \{\
        var spreadsheet = SpreadsheetApp.openById(CUSTOMER_SHEET_ID);\
\
        // 1. \uc0\u50868 \u50689 \u48708  \u51200 \u51109 \
        var sheet = spreadsheet.getSheetByName('\uc0\u50868 \u50689 \u48708  \u44288 \u47532  \u45824 \u51109 ');\
        if (!sheet) sheet = spreadsheet.getSheetByName('\uc0\u50868 \u50689 \u48708 \u44288 \u47532 ');\
        if (!sheet) \{\
            sheet = spreadsheet.insertSheet('\uc0\u50868 \u50689 \u48708  \u44288 \u47532  \u45824 \u51109 ');\
            var headers = ['No', '\uc0\u45216 \u51676 ', '\u45824 \u48516 \u47448 ', '\u49345 \u49464 \u45236 \u50669 ', '\u44552 \u50529 ', '\u44208 \u51228 \u49688 \u45800 ', '\u51613 \u48729 \u51088 \u47308 ', '\u48708 \u44256 '];\
            sheet.appendRow(headers);\
            var headerRange = sheet.getRange(1, 1, 1, headers.length);\
            headerRange.setBackground('#4CAF50');\
            headerRange.setFontColor('#ffffff');\
            headerRange.setFontWeight('bold');\
            sheet.setFrozenRows(1);\
        \}\
\
        var expenses = payload.expenses || [];\
\
        // \uc0\u44592 \u51316  \u45936 \u51060 \u53552  \u49325 \u51228  (\u54756 \u45908  \u51228 \u50808 )\
        var lastRow = sheet.getLastRow();\
        if (lastRow > 1) \{\
            sheet.getRange(2, 1, lastRow - 1, 8).clearContent();\
        \}\
\
        // \uc0\u49352  \u45936 \u51060 \u53552  \u51077 \u47141 \
        if (expenses.length > 0) \{\
            var newData = expenses.map(function (exp, idx) \{\
                return [\
                    idx + 1,\
                    exp.date || '',\
                    exp.category || '',\
                    exp.detail || '',\
                    exp.amount || 0,\
                    exp.payMethod || '',\
                    exp.receipt || '',\
                    exp.memo || ''\
                ];\
            \});\
            sheet.getRange(2, 1, newData.length, 8).setValues(newData);\
        \}\
\
        // 2. \uc0\u44256 \u51221 \u51648 \u52636  \u49444 \u51221  \u51200 \u51109  (\u51080 \u45716  \u44221 \u50864 )\
        if (payload.fixedExpenses && payload.fixedExpenses.length > 0) \{\
            var fixedSheet = spreadsheet.getSheetByName('\uc0\u44256 \u51221 \u51648 \u52636  \u49444 \u51221 ');\
            if (!fixedSheet) \{\
                fixedSheet = spreadsheet.insertSheet('\uc0\u44256 \u51221 \u51648 \u52636  \u49444 \u51221 ');\
                // [\uc0\u49688 \u51221 ] \u45824 \u48516 \u47448 , \u49345 \u49464 \u45236 \u50669 , \u50900  \u44256 \u51221 \u44552 \u50529 , \u44208 \u51228 \u49688 \u45800 , \u51613 \u48729 \u51088 \u47308 , \u54876 \u49457 \u54868 \
                var fixedHeaders = ['\uc0\u45824 \u48516 \u47448 ', '\u49345 \u49464 \u45236 \u50669 ', '\u50900  \u44256 \u51221 \u44552 \u50529 ', '\u44208 \u51228 \u49688 \u45800 ', '\u51613 \u48729 \u51088 \u47308 ', '\u54876 \u49457 \u54868 '];\
                fixedSheet.appendRow(fixedHeaders);\
                var fHeaderRange = fixedSheet.getRange(1, 1, 1, fixedHeaders.length);\
                fHeaderRange.setBackground('#FF9800');\
                fHeaderRange.setFontColor('#ffffff');\
                fHeaderRange.setFontWeight('bold');\
                fixedSheet.setFrozenRows(1);\
            \}\
\
            // \uc0\u44592 \u51316  \u44256 \u51221 \u51648 \u52636  \u49325 \u51228 \
            var fLastRow = fixedSheet.getLastRow();\
            if (fLastRow > 1) \{\
                fixedSheet.getRange(2, 1, fLastRow - 1, 6).clearContent();\
            \}\
\
            // \uc0\u49352  \u44256 \u51221 \u51648 \u52636  \u51077 \u47141 \
            var fixedData = payload.fixedExpenses.map(function (f) \{\
                return [\
                    f.category || '',\
                    f.detail || f.itemName || '', // itemName -> detail\uc0\u47196  \u47749 \u52845  \u48320 \u44221  \u45824 \u51025 \
                    f.amount || 0,\
                    f.payMethod || '',\
                    f.receipt || '', // \uc0\u51613 \u48729 \u51088 \u47308  \u52628 \u44032 \
                    f.active !== false ? 'Y' : 'N'\
                ];\
            \});\
            fixedSheet.getRange(2, 1, fixedData.length, 6).setValues(fixedData);\
        \}\
\
        return ContentService.createTextOutput(JSON.stringify(\{\
            result: 'success',\
            message: '\uc0\u50868 \u50689 \u48708 \u44032  \u51200 \u51109 \u46104 \u50632 \u49845 \u45768 \u45796 .',\
            count: expenses.length\
        \})).setMimeType(ContentService.MimeType.JSON);\
\
    \} catch (err) \{\
        return ContentService.createTextOutput(JSON.stringify(\{\
            result: 'error',\
            error: err.toString()\
        \})).setMimeType(ContentService.MimeType.JSON);\
    \}\
\}\
\
// ==========================================\
// 7. \uc0\u44256 \u44061  \u49345 \u53468  \u51088 \u46041  \u44081 \u49888  (\u44277 \u49324 \u44592 \u44036 /A/S \u44592 \u44036  \u44592 \u48152 )\
// ==========================================\
\
/**\
 * \uc0\u49345 \u53468  \u51088 \u46041  \u44081 \u49888  \u44508 \u52825 :\
 * - \uc0\u50724 \u45720  < \u44277 \u49324 \u49884 \u51089 \u51068  \u8594  \u49345 \u53468  \u50976 \u51648  (\u46608 \u45716  "\u44277 \u49324 \u50696 \u51221 ")\
 * - \uc0\u44277 \u49324 \u49884 \u51089 \u51068  \u8804  \u50724 \u45720  \u8804  \u44277 \u49324 \u51333 \u47308 \u51068  \u8594  \u49345 \u53468  = "\u44277 \u49324 \u51473 "\
 * - \uc0\u44277 \u49324 \u51333 \u47308 \u51068  < \u50724 \u45720  \u8804  A/S\u51333 \u47308 \u51068  \u8594  \u49345 \u53468  = "A/S\u44592 \u44036 "\
 * - \uc0\u50724 \u45720  > A/S\u51333 \u47308 \u51068  \u8594  \u49345 \u53468  = "A/S \u47564 \u47308 "\
 */\
function updateCustomerStatusByDate() \{\
    try \{\
        var spreadsheet = SpreadsheetApp.openById(CUSTOMER_SHEET_ID);\
        var sheet = spreadsheet.getSheetByName('\uc0\u44228 \u50557 \u50756 \u47308 ');\
        if (!sheet) \{\
            console.log('[\uc0\u49345 \u53468 \u44081 \u49888 ] \u44228 \u50557 \u50756 \u47308  \u49884 \u53944 \u44032  \u50630 \u49845 \u45768 \u45796 .');\
            return \{ updated: 0, checked: 0, error: null \};\
        \}\
\
        var lastRow = sheet.getLastRow();\
        if (lastRow < 2) \{\
            console.log('[\uc0\u49345 \u53468 \u44081 \u49888 ] \u45936 \u51060 \u53552 \u44032  \u50630 \u49845 \u45768 \u45796 .');\
            return \{ updated: 0, checked: 0, error: null \};\
        \}\
\
        // \uc0\u54756 \u45908  \u51069 \u44592 \
        var headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];\
        var headerMap = \{\};\
        headers.forEach(function (h, i) \{\
            headerMap[String(h).trim()] = i;\
        \});\
\
        // \uc0\u54596 \u49688  \u52972 \u47100  \u51064 \u45937 \u49828 \
        var IDX_STATUS = headerMap['\uc0\u49345 \u53468 '];\
        var IDX_CONSTRUCTION = headerMap['\uc0\u44277 \u49324 \u44592 \u44036 '];\
        var IDX_AS = headerMap['A/S \uc0\u44592 \u44036 '];\
\
        if (IDX_STATUS === undefined || IDX_CONSTRUCTION === undefined) \{\
            console.log('[\uc0\u49345 \u53468 \u44081 \u49888 ] \u54596 \u49688  \u52972 \u47100 \u51060  \u50630 \u49845 \u45768 \u45796 . \u49345 \u53468 :', IDX_STATUS, '\u44277 \u49324 \u44592 \u44036 :', IDX_CONSTRUCTION);\
            return \{ updated: 0, checked: 0, error: '\uc0\u54596 \u49688  \u52972 \u47100  \u50630 \u51020 ' \};\
        \}\
\
        var data = sheet.getRange(2, 1, lastRow - 1, headers.length).getValues();\
        var today = new Date();\
        today.setHours(0, 0, 0, 0);\
\
        var updatedCount = 0;\
        var checkedCount = 0;\
\
        for (var i = 0; i < data.length; i++) \{\
            var row = data[i];\
            var currentStatus = String(row[IDX_STATUS] || '').trim();\
            var constructionPeriod = String(row[IDX_CONSTRUCTION] || '');\
            var asEndDateStr = String(row[IDX_AS] || '');\
\
            // \uc0\u44277 \u49324 \u44592 \u44036  \u54028 \u49905  (\u54805 \u49885 : "YYYY.MM.DD ~ YYYY.MM.DD" \u46608 \u45716  "YYYY-MM-DD ~ YYYY-MM-DD")\
            var startDate = null;\
            var endDate = null;\
\
            if (constructionPeriod) \{\
                var cleanPeriod = constructionPeriod.replace(/\\s+/g, '');\
                var parts = cleanPeriod.split('~');\
                if (parts.length >= 1 && parts[0]) \{\
                    startDate = parseFlexDate(parts[0]);\
                \}\
                if (parts.length >= 2 && parts[1]) \{\
                    endDate = parseFlexDate(parts[1]);\
                \}\
            \}\
\
            // A/S \uc0\u51333 \u47308 \u51068  \u54028 \u49905 \
            var asEndDate = null;\
            if (asEndDateStr) \{\
                asEndDate = parseFlexDate(asEndDateStr);\
            \}\
\
            // \uc0\u54596 \u49688  \u45216 \u51676  \u50630 \u51004 \u47732  \u49828 \u53429  (\u49345 \u53468  \u50976 \u51648 )\
            if (!startDate || !endDate) \{\
                continue;\
            \}\
\
            checkedCount++;\
            var newStatus = '';\
\
            // \uc0\u49345 \u53468  \u44208 \u51221  \u47196 \u51649 \
            if (today < startDate) \{\
                // \uc0\u44277 \u49324  \u49884 \u51089  \u51204  \u8594  \u49345 \u53468  \u50976 \u51648  (\u44592 \u51316  \u49345 \u53468  \u44536 \u45824 \u47196 )\
                continue;\
            \} else if (today >= startDate && today <= endDate) \{\
                // \uc0\u44277 \u49324 \u51473 \
                newStatus = '\uc0\u44277 \u49324 \u51473 ';\
            \} else if (today > endDate) \{\
                // \uc0\u44277 \u49324  \u50756 \u47308  \u54980 \
                if (asEndDate && today <= asEndDate) \{\
                    // A/S \uc0\u44592 \u44036  \u51473 \
                    newStatus = 'A/S\uc0\u44592 \u44036 ';\
                \} else if (asEndDate && today > asEndDate) \{\
                    // A/S \uc0\u44592 \u44036  \u47564 \u47308 \
                    newStatus = 'A/S \uc0\u47564 \u47308 ';\
                \} else \{\
                    // A/S \uc0\u51333 \u47308 \u51068  \u51221 \u48372  \u50630 \u51004 \u47732  \u44277 \u49324 \u50756 \u47308  \u52376 \u47532 \
                    newStatus = '\uc0\u44277 \u49324 \u50756 \u47308 ';\
                \}\
            \}\
\
            // \uc0\u49345 \u53468 \u44032  \u48320 \u44221 \u46104 \u50612 \u50556  \u54616 \u44256  \u54788 \u51116  \u49345 \u53468 \u50752  \u45796 \u47484  \u46412 \u47564  \u50629 \u45936 \u51060 \u53944 \
            if (newStatus && newStatus !== currentStatus) \{\
                // \uc0\u49884 \u53944 \u50640  \u50629 \u45936 \u51060 \u53944  (\u54665  \u48264 \u54840  = i + 2)\
                sheet.getRange(i + 2, IDX_STATUS + 1).setValue(newStatus);\
                updatedCount++;\
                console.log('[\uc0\u49345 \u53468 \u44081 \u49888 ] \u54665  ' + (i + 2) + ': "' + currentStatus + '" \u8594  "' + newStatus + '"');\
            \}\
        \}\
\
        console.log('[\uc0\u49345 \u53468 \u44081 \u49888 ] \u50756 \u47308  - \u54869 \u51064 : ' + checkedCount + '\u44148 , \u50629 \u45936 \u51060 \u53944 : ' + updatedCount + '\u44148 ');\
        return \{ updated: updatedCount, checked: checkedCount, error: null \};\
\
    \} catch (err) \{\
        console.error('[\uc0\u49345 \u53468 \u44081 \u49888 ] \u50724 \u47448 :', err);\
        return \{ updated: 0, checked: 0, error: err.toString() \};\
    \}\
\}\
\
/**\
 * \uc0\u45796 \u50577 \u54620  \u45216 \u51676  \u54805 \u49885  \u54028 \u49905  (YYYY.MM.DD, YYYY-MM-DD, YYYY/MM/DD)\
 */\
function parseFlexDate(str) \{\
    if (!str) return null;\
\
    var cleaned = String(str).trim();\
\
    // Date \uc0\u44061 \u52404 \u44032  \u51060 \u48120  \u46308 \u50612 \u50728  \u44221 \u50864 \
    if (str instanceof Date) \{\
        return str;\
    \}\
\
    // \uc0\u49707 \u51088 (\u53440 \u51076 \u49828 \u53484 \u54532 )\u51064  \u44221 \u50864 \
    if (!isNaN(str) && str > 10000000) \{\
        return new Date(str);\
    \}\
\
    // \uc0\u47928 \u51088 \u50676  \u54805 \u49885  \u54028 \u49905 \
    // \uc0\u51216 , \u45824 \u49884 , \u49836 \u47000 \u49884  \u47784 \u46160  \u51648 \u50896 \
    var normalized = cleaned.replace(/\\./g, '-').replace(/\\//g, '-');\
\
    // YYYY-MM-DD \uc0\u54805 \u49885  \u52404 \u53356 \
    var match = normalized.match(/^(\\d\{4\})-(\\d\{1,2\})-(\\d\{1,2\})/);\
    if (match) \{\
        var d = new Date(parseInt(match[1]), parseInt(match[2]) - 1, parseInt(match[3]));\
        d.setHours(0, 0, 0, 0);\
        return d;\
    \}\
\
    // \uc0\u44536 \u45285  Date \u54028 \u49905  \u49884 \u46020 \
    var parsed = new Date(cleaned);\
    if (!isNaN(parsed.getTime())) \{\
        parsed.setHours(0, 0, 0, 0);\
        return parsed;\
    \}\
\
    return null;\
\}\
\
/**\
 * \uc0\u47588 \u51068  \u51088 \u46041  \u49892 \u54665  \u53944 \u47532 \u44144  \u49444 \u51221  (00:10 KST)\
 * \uc0\u51060  \u54632 \u49688 \u47484  \u54620  \u48264  \u49688 \u46041  \u49892 \u54665 \u54616 \u47732  \u53944 \u47532 \u44144 \u44032  \u49444 \u52824 \u46121 \u45768 \u45796 .\
 */\
function setupDailyStatusTrigger() \{\
    // \uc0\u44592 \u51316  \u53944 \u47532 \u44144  \u51228 \u44144 \
    removeDailyStatusTrigger();\
\
    // \uc0\u49352  \u53944 \u47532 \u44144  \u49444 \u51221  (\u47588 \u51068  00:00~01:00 \u49324 \u51060  \u49892 \u54665 )\
    ScriptApp.newTrigger('updateCustomerStatusByDate')\
        .timeBased()\
        .atHour(0)      // 00\uc0\u49884 \
        .nearMinute(10) // \uc0\u50557  10\u48516 \
        .everyDays(1)   // \uc0\u47588 \u51068 \
        .inTimezone('Asia/Seoul')\
        .create();\
\
    console.log('\uc0\u9989  \u49345 \u53468  \u51088 \u46041  \u44081 \u49888  \u53944 \u47532 \u44144 \u44032  \u49444 \u52824 \u46104 \u50632 \u49845 \u45768 \u45796 . (\u47588 \u51068  00:10 KST)');\
    return '\uc0\u53944 \u47532 \u44144  \u49444 \u52824  \u50756 \u47308 ';\
\}\
\
/**\
 * \uc0\u49345 \u53468  \u51088 \u46041  \u44081 \u49888  \u53944 \u47532 \u44144  \u51228 \u44144 \
 */\
function removeDailyStatusTrigger() \{\
    var triggers = ScriptApp.getProjectTriggers();\
    var removed = 0;\
\
    triggers.forEach(function (trigger) \{\
        if (trigger.getHandlerFunction() === 'updateCustomerStatusByDate') \{\
            ScriptApp.deleteTrigger(trigger);\
            removed++;\
        \}\
    \});\
\
    if (removed > 0) \{\
        console.log('\uc0\u55357 \u56785 \u65039  \u44592 \u51316  \u53944 \u47532 \u44144  ' + removed + '\u44060  \u51228 \u44144 \u46120 ');\
    \}\
    return removed + '\uc0\u44060  \u51228 \u44144 \u46120 ';\
\}\
\
/**\
 * \uc0\u49688 \u46041  \u53580 \u49828 \u53944 \u50857  \u54632 \u49688  - \u49345 \u53468  \u44081 \u49888  \u44208 \u44284  \u54869 \u51064 \
 */\
function testStatusUpdate() \{\
    var result = updateCustomerStatusByDate();\
    console.log('\uc0\u53580 \u49828 \u53944  \u44208 \u44284 :', JSON.stringify(result));\
\
    if (result.error) \{\
        SpreadsheetApp.getUi().alert('\uc0\u50724 \u47448  \u48156 \u49373 : ' + result.error);\
    \} else \{\
        SpreadsheetApp.getUi().alert(\
            '\uc0\u49345 \u53468  \u51088 \u46041  \u44081 \u49888  \u50756 \u47308 !\\n' +\
            '- \uc0\u54869 \u51064 : ' + result.checked + '\u44148 \\n' +\
            '- \uc0\u50629 \u45936 \u51060 \u53944 : ' + result.updated + '\u44148 '\
        );\
    \}\
    return result;\
\}\
\
// ==========================================\
// \uc0\u51089 \u50629  \u44592 \u47197  (Action Log) \u44288 \u47532 \
// ==========================================\
\
/**\
 * \uc0\u51089 \u50629  \u44592 \u47197  \u51200 \u51109  (POST)\
 */\
function handleLogUserAction(payload) \{\
    var lock = LockService.getScriptLock();\
    // \uc0\u47196 \u44613 \u51008  \u51473 \u50836 \u54616 \u51648 \u47564  \u47700 \u51064  \u54532 \u47196 \u49464 \u49828 \u47484  \u47561 \u51004 \u47732  \u50504  \u46104 \u48064 \u47196  \u51687 \u44172  \u45824 \u44592 \
    try \{\
        if (!lock.tryLock(3000)) \{\
            // \uc0\u46973  \u54925 \u46301  \u49892 \u54056  \u49884  \u50640 \u47084 \u48372 \u45796 \u45716  \u44536 \u45285  \u54056 \u49828 \u54616 \u44144 \u45208  \u50640 \u47084  \u47196 \u44536 \
            console.error('Lock failed for logging');\
            return ContentService.createTextOutput(JSON.stringify(\{ result: "error", error: "Lock failed" \})).setMimeType(ContentService.MimeType.JSON);\
        \}\
\
        var sheet = getOrCreateLogSheet();\
\
        var timestamp = Utilities.formatDate(new Date(), "GMT+9", "yyyy-MM-dd HH:mm");\
        var adminId = payload.adminId || 'Unknown';\
        var actionType = payload.actionType || 'Unknown';\
        var detail = payload.detail || '';\
\
        // \uc0\u45936 \u51060 \u53552  \u52628 \u44032 : [\u51068 \u49884 , \u51089 \u50629 \u51088 ID, \u44396 \u48516 , \u49345 \u49464 \u45236 \u50857 ]\
        sheet.appendRow([timestamp, adminId, actionType, detail]);\
\
        return ContentService.createTextOutput(JSON.stringify(\{ result: "success" \})).setMimeType(ContentService.MimeType.JSON);\
\
    \} catch (e) \{\
        return ContentService.createTextOutput(JSON.stringify(\{ result: "error", error: e.toString() \})).setMimeType(ContentService.MimeType.JSON);\
    \} finally \{\
        lock.releaseLock();\
    \}\
\}\
\
/**\
 * \uc0\u51089 \u50629  \u44592 \u47197  \u51312 \u54924  (GET)\
 * \uc0\u52572 \u44540  50\u44148  \u48152 \u54872  (\u50669 \u49692 )\
 */\
function handleGetActionLogs(e) \{\
    try \{\
        var sheet = getOrCreateLogSheet();\
        var lastRow = sheet.getLastRow();\
\
        if (lastRow < 2) \{\
            return ContentService.createTextOutput(JSON.stringify(\{ success: true, logs: [] \})).setMimeType(ContentService.MimeType.JSON);\
        \}\
\
        // \uc0\u52572 \u44540  50\u44148 \u47564  \u44032 \u51256 \u50724 \u44592 \
        var limit = 50;\
        var startRow = Math.max(2, lastRow - limit + 1);\
        var numRows = lastRow - startRow + 1;\
\
        if (numRows <= 0) \{\
            return ContentService.createTextOutput(JSON.stringify(\{ success: true, logs: [] \})).setMimeType(ContentService.MimeType.JSON);\
        \}\
\
        var data = sheet.getRange(startRow, 1, numRows, 4).getValues();\
\
        // \uc0\u50669 \u49692  \u51221 \u47148  (\u52572 \u49888 \u49692 )\
        data.reverse();\
\
        // \uc0\u44061 \u52404  \u48176 \u50676 \u47196  \u48320 \u54872 \
        var logs = data.map(function (row) \{\
            const date = new Date(row[0]);\
            // \uc0\u45216 \u51676  \u44061 \u52404 \u51064  \u44221 \u50864  \u54252 \u47607 \u54021 \
            const ts = (row[0] instanceof Date)\
                ? Utilities.formatDate(row[0], "GMT+9", "yyyy-MM-dd HH:mm")\
                : row[0];\
\
            return \{\
                timestamp: ts,\
                adminId: row[1],\
                actionType: row[2],\
                detail: row[3]\
            \};\
        \});\
\
        return ContentService.createTextOutput(JSON.stringify(\{ success: true, logs: logs \})).setMimeType(ContentService.MimeType.JSON);\
\
    \} catch (e) \{\
        return ContentService.createTextOutput(JSON.stringify(\{ success: false, error: e.toString() \})).setMimeType(ContentService.MimeType.JSON);\
    \}\
\}\
\
/**\
 * \uc0\u51089 \u50629 \u44592 \u47197  \u49884 \u53944  \u44032 \u51256 \u50724 \u44592  \u46608 \u45716  \u49373 \u49457 \
 */\
function getOrCreateLogSheet() \{\
    var ss = SpreadsheetApp.openById(CUSTOMER_SHEET_ID);\
    var sheet = ss.getSheetByName(LOG_SHEET_NAME);\
\
    if (!sheet) \{\
        sheet = ss.insertSheet(LOG_SHEET_NAME);\
        // \uc0\u54756 \u45908  \u49444 \u51221 \
        sheet.getRange(1, 1, 1, 4).setValues([['\uc0\u51068 \u49884 ', '\u51089 \u50629 \u51088 ', '\u44396 \u48516 ', '\u49345 \u49464 \u45236 \u50857 ']]);\
        sheet.getRange(1, 1, 1, 4).setFontWeight('bold').setBackground('#f3f3f3');\
        sheet.setColumnWidth(1, 150); // \uc0\u51068 \u49884 \
        sheet.setColumnWidth(2, 100); // \uc0\u51089 \u50629 \u51088 \
        sheet.setColumnWidth(3, 120); // \uc0\u44396 \u48516 \
        sheet.setColumnWidth(4, 400); // \uc0\u49345 \u49464 \u45236 \u50857 \
        sheet.setFrozenRows(1);\
    \}\
\
    return sheet;\
\}\
\
/**\
 * [DISABLED] \uc0\u44277 \u51221 \u48324  \u52404 \u53356 \u47532 \u49828 \u53944  \u47560 \u49828 \u53552  \u45936 \u51060 \u53552  \u50629 \u45936 \u51060 \u53944 \
 * \uc0\u47560 \u49828 \u53552  \u45936 \u51060 \u53552  \u51221 \u54633 \u49457 \u51012  \u50948 \u54644  API\u47484  \u53685 \u54620  \u50416 \u44592  \u44428 \u54620 \u51060  \u51228 \u44144 \u46104 \u50632 \u49845 \u45768 \u45796 .\
 */\
function handleChecklistUpdate(payload) \{\
    return ContentService.createTextOutput(JSON.stringify(\{\
        success: false,\
        error: 'Master DB (Checklist) is read-only via API.'\
    \})).setMimeType(ContentService.MimeType.JSON);\
\}\
\
// \uc0\u50896 \u48376  \u47196 \u51649  \u48372 \u51316 \
/*\
function handleChecklistUpdate_ORIGINAL(payload) \{\
    try \{\
        Logger.log('[Checklist Update] Started');\
        Logger.log('Admin ID: ' + (payload.adminId || 'unknown'));\
\
        var newData = payload.data;\
        if (!newData || !Array.isArray(newData)) \{\
            throw new Error('\uc0\u50976 \u54952 \u54620  \u45936 \u51060 \u53552 \u44032  \u50500 \u45785 \u45768 \u45796 .');\
        \}\
\
        var ss = SpreadsheetApp.openById(CUSTOMER_SHEET_ID);\
        var sheet = ss.getSheetByName('\uc0\u44277 \u51221 \u48324 \u52404 \u53356 \u47532 \u49828 \u53944 ');\
\
        // \uc0\u49884 \u53944 \u44032  \u50630 \u51004 \u47732  \u49373 \u49457  (\u54756 \u45908  \u54252 \u54632 )\
        if (!sheet) \{\
            sheet = ss.insertSheet('\uc0\u44277 \u51221 \u48324 \u52404 \u53356 \u47532 \u49828 \u53944 ');\
        \}\
\
        // \uc0\u54756 \u45908  \u51221 \u51032 \
        var headers = ['\uc0\u48264 \u54840 ', '\u54637 \u47785 ', '\u45236 \u50857 ', '\u51652 \u54665 \u45800 \u44228 ', '\u48516 \u47448 ', '\u48708 \u44256 '];\
\
        // \uc0\u44592 \u51316  \u45936 \u51060 \u53552  \u53364 \u47532 \u50612  (\u54756 \u45908  \u51228 \u50808 \u54616 \u44256  \u45936 \u51060 \u53552 \u47564  \u44368 \u52404 \u54616 \u44144 \u45208 , \u51204 \u52404  \u44368 \u52404 )\
        // \uc0\u50504 \u51204 \u54616 \u44172  \u51204 \u52404  \u53364 \u47532 \u50612  \u54980  \u45796 \u49884  \u50416 \u44592 \
        sheet.clear();\
\
        // 2D \uc0\u48176 \u50676 \u47196  \u48320 \u54872 \
        var values = [headers];\
        newData.forEach(function (item) \{\
            var row = [\
                item.\uc0\u48264 \u54840  || item.no || '',\
                item.\uc0\u54637 \u47785  || item.title || '',\
                item.\uc0\u45236 \u50857  || item.content || '',\
                item.\uc0\u51652 \u54665 \u45800 \u44228  || item.stage || '',\
                item.\uc0\u48516 \u47448  || item.category || '',\
                item.\uc0\u48708 \u44256  || item.note || ''\
            ];\
            values.push(row);\
        \});\
\
        // \uc0\u45936 \u51060 \u53552  \u50416 \u44592 \
        if (values.length > 0) \{\
            sheet.getRange(1, 1, values.length, values[0].length).setValues(values);\
        \}\
\
        // \uc0\u49436 \u49885  \u51201 \u50857  (\u50741 \u49496 )\
        sheet.getRange(1, 1, 1, headers.length).setFontWeight('bold').setBackground('#efefef');\
        sheet.setFrozenRows(1);\
\
        Logger.log('[Checklist Update] Saved ' + (values.length - 1) + ' rows.');\
\
        return ContentService.createTextOutput(JSON.stringify(\{\
            success: true,\
            result: 'success',\
            count: values.length - 1,\
            sheetName: '\uc0\u44277 \u51221 \u48324 \u52404 \u53356 \u47532 \u49828 \u53944 ',\
            updatedAt: new Date().toISOString()\
        \})).setMimeType(ContentService.MimeType.JSON);\
\
    \} catch (e) \{\
        // ...\
    \}\
\}\
*/\
\
// ==========================================\
// 15. Excel Export (Read-Only Report)\
// ==========================================\
\
/**\
 * Excel \uc0\u45936 \u51060 \u53552  \u45236 \u48372 \u45236 \u44592  \u54648 \u46308 \u47084 \
 * Google Sheets \uc0\u45936 \u51060 \u53552 \u47484  \u51069 \u50612  Excel \u54805 \u49885 \u51004 \u47196  \u48152 \u54872 \
 * @param \{Object\} e - \uc0\u50836 \u52397  \u54028 \u46972 \u48120 \u53552 \
 */\
function handleExcelExport(e) \{\
    try \{\
        var customerId = e.parameter.customerId; // \uc0\u53945 \u51221  \u44256 \u44061  \u46608 \u45716  'all'\
        var spreadsheet = SpreadsheetApp.openById(CUSTOMER_SHEET_ID);\
        var customerSheet = spreadsheet.getSheetByName('\uc0\u44256 \u44061 \u44288 \u47532 _\u44204 \u51201 \u49436 ');\
\
        if (!customerSheet || customerSheet.getLastRow() < 2) \{\
            return ContentService.createTextOutput(JSON.stringify(\{\
                success: false,\
                error: '\uc0\u44256 \u44061  \u45936 \u51060 \u53552 \u44032  \u50630 \u49845 \u45768 \u45796 .'\
            \})).setMimeType(ContentService.MimeType.JSON);\
        \}\
\
        // \uc0\u44256 \u44061  \u45936 \u51060 \u53552  \u47196 \u46300 \
        var customerData = customerSheet.getDataRange().getValues();\
        var customers = [];\
\
        for (var i = 1; i < customerData.length; i++) \{\
            var row = customerData[i];\
            if (!row[0]) continue;\
\
            var customer = buildCustomerFromRow(row);\
\
            // JSON \uc0\u45936 \u51060 \u53552 \u44032  \u51080 \u51004 \u47732  \u54028 \u49905 \
            if (row[17]) \{\
                try \{\
                    var jsonData = JSON.parse(row[17]);\
                    customer = Object.assign(customer, jsonData);\
                \} catch (err) \{ \}\
            \}\
\
            // \uc0\u53945 \u51221  \u44256 \u44061 \u47564  \u54596 \u53552 \u47553 \
            if (customerId && customerId !== 'all' && customer.customerId !== customerId) \{\
                continue;\
            \}\
\
            customers.push(customer);\
        \}\
\
        if (customers.length === 0) \{\
            return ContentService.createTextOutput(JSON.stringify(\{\
                success: false,\
                error: '\uc0\u54644 \u45817  \u44256 \u44061 \u51012  \u52286 \u51012  \u49688  \u50630 \u49845 \u45768 \u45796 .'\
            \})).setMimeType(ContentService.MimeType.JSON);\
        \}\
\
        // \uc0\u51076 \u49884  \u49828 \u54532 \u47112 \u46300 \u49884 \u53944  \u49373 \u49457 \
        var today = Utilities.formatDate(new Date(), 'GMT+9', 'yyyyMMdd');\
        var tempSpreadsheet = SpreadsheetApp.create('\uc0\u46356 \u51088 \u51064 \u51648 \u44536 _\u44256 \u44061 \u45936 \u51060 \u53552 _' + today);\
        var tempFile = DriveApp.getFileById(tempSpreadsheet.getId());\
\
        try \{\
            // \uc0\u44592 \u48376  \u49884 \u53944  \u49325 \u51228  (\u45208 \u51473 \u50640  \u49892 \u51228  \u49884 \u53944  \u52628 \u44032  \u54980 )\
            var sheets = tempSpreadsheet.getSheets();\
\
            // \uc0\u44033  \u44256 \u44061 \u48324  \u49884 \u53944  \u49373 \u49457 \
            customers.forEach(function (cust, idx) \{\
                // \uc0\u49884 \u53944  \u51060 \u47492  \u49373 \u49457 : \u46356 \u51088 \u51064 \u51648 \u44536 _\u44256 \u44061 \u47749 _\u54788 \u51109 \u47749 _\u44228 \u50557 \u51068 \
                var contractDateStr = '';\
                if (cust.contractDate) \{\
                    try \{\
                        var d = new Date(cust.contractDate);\
                        if (!isNaN(d.getTime())) \{\
                            contractDateStr = Utilities.formatDate(d, 'GMT+9', 'yyyyMMdd');\
                        \}\
                    \} catch (e) \{ \}\
                \}\
                var sheetName = ('\uc0\u46356 \u51088 \u51064 \u51648 \u44536 _' + (cust.clientName || '\u44256 \u44061 ') + '_' + (cust.projectName || '') + (contractDateStr ? '_' + contractDateStr : ''))\
                    .replace(/[\\\\/:*?\\[\\]]/g, '')\
                    .substring(0, 31) || ('\uc0\u44256 \u44061 ' + (idx + 1));\
\
                var sheet = tempSpreadsheet.insertSheet(sheetName);\
                var rowNum = 1;\
\
                // ========== 1. \uc0\u44256 \u44061  \u44592 \u48376  \u51221 \u48372  ==========\
                sheet.getRange(rowNum, 1).setValue('\uc0\u12304  \u44256 \u44061  \u44592 \u48376  \u51221 \u48372  \u12305 ').setFontWeight('bold').setBackground('#e8f0fe');\
                rowNum++;\
                var basicInfo = [\
                    ['\uc0\u44256 \u44061 ID', cust.customerId || '-'],\
                    ['\uc0\u44256 \u44061 \u47749 ', cust.clientName || '-'],\
                    ['\uc0\u50672 \u46973 \u52376 ', cust.clientPhone || '-'],\
                    ['\uc0\u51060 \u47700 \u51068 ', cust.clientEmail || '-'],\
                    ['\uc0\u54788 \u51109 \u47749 ', cust.projectName || '-'],\
                    ['\uc0\u54788 \u51109 \u51452 \u49548 ', cust.siteAddress || cust.clientAddress || '-'],\
                    ['\uc0\u44228 \u50557 \u51068 ', cust.contractDate || '-'],\
                    ['\uc0\u44277 \u49324 \u44592 \u44036 ', cust.constructionPeriod || '-'],\
                    ['\uc0\u49345 \u53468 ', cust.status || '-'],\
                    ['\uc0\u45812 \u45817 \u51088 ', cust.manager || '-']\
                ];\
                sheet.getRange(rowNum, 1, basicInfo.length, 2).setValues(basicInfo);\
                // \uc0\u52395  \u48264 \u51704  \u50676  (\u46972 \u48296 ) \u49828 \u53440 \u51068 \u47553 \
                sheet.getRange(rowNum, 1, basicInfo.length, 1).setFontWeight('bold').setBackground('#f8f9fa');\
                rowNum += basicInfo.length + 1;\
\
                // ========== 2. \uc0\u44277 \u51221 \u48324  \u52404 \u53356 \u47532 \u49828 \u53944  (\u54596 \u49688 ) ==========\
                sheet.getRange(rowNum, 1).setValue('\uc0\u12304  \u44277 \u51221 \u48324  \u52404 \u53356 \u47532 \u49828 \u53944  \u12305 ').setFontWeight('bold').setBackground('#e8f0fe');\
                rowNum++;\
                var checklistHeaders = ['\uc0\u44277 \u51221 \u47749 ', '\u52404 \u53356 \u50668 \u48512 ', '\u47700 \u47784 ', '\u50756 \u47308 \u51068 '];\
                sheet.getRange(rowNum, 1, 1, checklistHeaders.length).setValues([checklistHeaders]).setFontWeight('bold').setBackground('#f8f9fa');\
                rowNum++;\
\
                var checklist = cust.checklist || cust.checklistItems || [];\
                if (checklist.length > 0) \{\
                    checklist.forEach(function (item) \{\
                        var checkStatus = item.checked === true || item.checked === 'true' || item.status === 'completed' ? 'O' : 'X';\
                        sheet.getRange(rowNum, 1, 1, 4).setValues([[\
                            item.name || item.stepName || item.process || '-',\
                            checkStatus,\
                            item.memo || item.note || item.remarks || '-',\
                            item.completedDate || item.endDate || item.date || '-'\
                        ]]);\
                        rowNum++;\
                    \});\
                \} else \{\
                    // \uc0\u45936 \u51060 \u53552  \u50630 \u51020  \u54364 \u49884 \
                    sheet.getRange(rowNum, 1, 1, 4).setValues([['(\uc0\u45936 \u51060 \u53552  \u50630 \u51020 )', '-', '-', '-']]).setFontColor('#999999');\
                    rowNum++;\
                \}\
                rowNum++;\
\
                // ========== 3. \uc0\u44277 \u49324  \u49828 \u52992 \u51460  ==========\
                sheet.getRange(rowNum, 1).setValue('\uc0\u12304  \u44277 \u49324  \u49828 \u52992 \u51460  \u12305 ').setFontWeight('bold').setBackground('#e8f0fe');\
                rowNum++;\
                var scheduleHeaders = ['\uc0\u44277 \u51221 ', '\u49464 \u48512 \u44277 \u51221 ', '\u49884 \u51089 \u51068 ', '\u51333 \u47308 \u51068 ', '\u49345 \u53468 '];\
                sheet.getRange(rowNum, 1, 1, scheduleHeaders.length).setValues([scheduleHeaders]).setFontWeight('bold').setBackground('#f8f9fa');\
                rowNum++;\
\
                var schedules = cust.schedules || cust.schedule || [];\
                if (schedules.length > 0) \{\
                    schedules.forEach(function (s) \{\
                        sheet.getRange(rowNum, 1, 1, 5).setValues([[\
                            s.category || s.process || '-',\
                            s.name || s.stepName || s.detail || '-',\
                            s.start || s.startDate || '-',\
                            s.end || s.endDate || '-',\
                            s.status || '-'\
                        ]]);\
                        rowNum++;\
                    \});\
                \} else \{\
                    sheet.getRange(rowNum, 1, 1, 5).setValues([['(\uc0\u45936 \u51060 \u53552  \u50630 \u51020 )', '-', '-', '-', '-']]).setFontColor('#999999');\
                    rowNum++;\
                \}\
                rowNum++;\
\
                // ========== 4. A/S \uc0\u44288 \u47532  \u44592 \u47197  ==========\
                sheet.getRange(rowNum, 1).setValue('\uc0\u12304  A/S \u44288 \u47532  \u44592 \u47197  \u12305 ').setFontWeight('bold').setBackground('#e8f0fe');\
                rowNum++;\
                var asHeaders = ['\uc0\u52852 \u53580 \u44256 \u47532 ', '\u48652 \u47004 \u46300 ', '\u54408 \u47785 ', '\u48372 \u51613 \u44592 \u44036 ', '\u48708 \u44256 '];\
                sheet.getRange(rowNum, 1, 1, asHeaders.length).setValues([asHeaders]).setFontWeight('bold').setBackground('#f8f9fa');\
                rowNum++;\
\
                var asList = cust.as_list || cust.asList || cust.asItems || [];\
                if (asList.length > 0) \{\
                    asList.forEach(function (a) \{\
                        sheet.getRange(rowNum, 1, 1, 5).setValues([[\
                            a.category || '-',\
                            a.brand || '-',\
                            a.item || a.itemName || '-',\
                            a.warranty || a.warrantyPeriod || '-',\
                            a.note || a.remarks || '-'\
                        ]]);\
                        rowNum++;\
                    \});\
                \} else \{\
                    sheet.getRange(rowNum, 1, 1, 5).setValues([['(\uc0\u45936 \u51060 \u53552  \u50630 \u51020 )', '-', '-', '-', '-']]).setFontColor('#999999');\
                    rowNum++;\
                \}\
\
                // \uc0\u52972 \u47100  \u45320 \u48708  \u51088 \u46041  \u51312 \u51221 \
                sheet.autoResizeColumns(1, 5);\
            \});\
\
            // \uc0\u44592 \u48376  \u48712  \u49884 \u53944  \u49325 \u51228 \
            var allSheets = tempSpreadsheet.getSheets();\
            if (allSheets.length > 1 && allSheets[0].getName() === 'Sheet1') \{\
                tempSpreadsheet.deleteSheet(allSheets[0]);\
            \}\
\
            // xlsx\uc0\u47196  \u48320 \u54872  (export URL \u49324 \u50857 )\
            var exportUrl = 'https://docs.google.com/spreadsheets/d/' + tempSpreadsheet.getId() + '/export?format=xlsx';\
\
            // \uc0\u45796 \u50868 \u47196 \u46300  URL \u48152 \u54872  (\u51649 \u51217  \u45796 \u50868 \u47196 \u46300 \u50857 )\
            // \uc0\u46608 \u45716  base64\u47196  \u48152 \u54872 \
            var xlsxBlob = UrlFetchApp.fetch(exportUrl, \{\
                headers: \{ 'Authorization': 'Bearer ' + ScriptApp.getOAuthToken() \}\
            \}).getBlob();\
\
            var base64Data = Utilities.base64Encode(xlsxBlob.getBytes());\
            var fileName = 'designjig_\uc0\u44256 \u44061 \u45936 \u51060 \u53552 _' + today + '.xlsx';\
\
            // \uc0\u51076 \u49884  \u54028 \u51068  \u49325 \u51228 \
            tempFile.setTrashed(true);\
\
            return ContentService.createTextOutput(JSON.stringify(\{\
                result: 'success', // User request strict key\
                success: true,     // Backward compatibility\
                fileName: fileName,\
                customerCount: customers.length,\
                mimeType: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',\
                data: base64Data\
            \})).setMimeType(ContentService.MimeType.JSON);\
\
        \} catch (innerErr) \{\
            // \uc0\u50640 \u47084  \u49884  \u51076 \u49884  \u54028 \u51068  \u51221 \u47532 \
            try \{ tempFile.setTrashed(true); \} catch (e) \{ \}\
            throw innerErr;\
        \}\
\
    \} catch (err) \{\
        return ContentService.createTextOutput(JSON.stringify(\{\
            success: false,\
            error: err.toString(),\
            stack: err.stack\
        \})).setMimeType(ContentService.MimeType.JSON);\
    \}\
\}\
\
\
\
/**\
 * [\uc0\u52628 \u44032 ] \u44277 \u51221 \u48324  \u52404 \u53356 \u47532 \u49828 \u53944  \u47560 \u49828 \u53552  \u45936 \u51060 \u53552  \u50629 \u45936 \u51060 \u53944  (\u49692 \u49436  \u51200 \u51109 )\
 */\
function handleChecklistMasterUpdate(payload) \{\
    var lock = LockService.getScriptLock();\
    if (!lock.tryLock(10000)) \{\
        return ContentService.createTextOutput(JSON.stringify(\{\
            success: false,\
            message: 'Server busy'\
        \})).setMimeType(ContentService.MimeType.JSON);\
    \}\
\
    try \{\
        var items = payload.data; // [\{\uc0\u48264 \u54840 :1, \u54637 \u47785 :..., \u45236 \u50857 :..., \u51652 \u54665 \u45800 \u44228 :..., category:...\}, ...]\
        if (!items || !Array.isArray(items)) \{\
            return ContentService.createTextOutput(JSON.stringify(\{\
                success: false,\
                message: 'Invalid data format'\
            \})).setMimeType(ContentService.MimeType.JSON);\
        \}\
\
        var spreadsheet = getTargetSpreadsheet(CUSTOMER_SHEET_ID);\
\
        // 1. [\uc0\u47700 \u51064 ] \u50976 \u51200 \u44032  \u51648 \u51221 \u54620  \u51060 \u47492 : '\u44277 \u51221  \u52404 \u53356 \u47532 \u49828 \u53944 '\
        var sheet = spreadsheet.getSheetByName('\uc0\u44277 \u51221  \u52404 \u53356 \u47532 \u49828 \u53944 ');\
        // Fallbacks\
        if (!sheet) sheet = spreadsheet.getSheetByName('\uc0\u44277 \u51221 \u52404 \u53356 \u47532 \u49828 \u53944 ');\
        if (!sheet) sheet = spreadsheet.getSheetByName('\uc0\u44277 \u51221 \u48324  \u52404 \u53356 \u47532 \u49828 \u53944 ');\
        if (!sheet) sheet = spreadsheet.getSheetByName('checklist');\
\
        if (!sheet) \{\
            return ContentService.createTextOutput(JSON.stringify(\{\
                success: false,\
                message: '\uc0\u44277 \u51221  \u52404 \u53356 \u47532 \u49828 \u53944  \u49884 \u53944 \u47484  \u52286 \u51012  \u49688  \u50630 \u49845 \u45768 \u45796 .'\
            \})).setMimeType(ContentService.MimeType.JSON);\
        \}\
\
        // 2. \uc0\u44592 \u51316  \u45936 \u51060 \u53552  \u53364 \u47532 \u50612  (\u54756 \u45908  \u51228 \u50808 )\
        var lastRow = sheet.getLastRow();\
        if (lastRow > 1) \{\
            sheet.getRange(2, 1, lastRow - 1, sheet.getLastColumn()).clearContent();\
        \}\
\
        // 3. \uc0\u49352  \u45936 \u51060 \u53552  \u51456 \u48708 \
        // \uc0\u54756 \u45908  \u49692 \u49436 : \u48264 \u54840 , \u54637 \u47785 , \u45236 \u50857 , \u51652 \u54665 \u45800 \u44228 , \u48516 \u47448 , \u48708 \u44256  (\u49884 \u53944  \u54756 \u45908 \u50752  \u51068 \u52824 \u54644 \u50556  \u54632 )\
        // [\uc0\u51452 \u51032 ] 'category' \u54596 \u46300 \u45716  '\u48516 \u47448 ' \u52972 \u47100 \u50640  \u47588 \u54609 \u46120  (\u46608 \u45716  \u54756 \u45908 \u44032  'category'\u46972 \u47732  \u44536 \u45824 \u47196  \u49324 \u50857 )\
\
        // \uc0\u54756 \u45908  \u54869 \u51064 \
        var headerValues = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];\
\
        var newRows = items.map(function (item) \{\
            var rowData = [];\
            headerValues.forEach(function (header) \{\
                var key = header;\
                var val = item[key] || '';\
\
                // key mapping fallback\
                if (!val) \{\
                    if ((header === '\uc0\u48516 \u47448 ' || header === '\u52852 \u53580 \u44256 \u47532 ') && item['category']) val = item['category'];\
                \}\
\
                rowData.push(val);\
            \});\
            return rowData;\
        \});\
\
        // 4. \uc0\u45936 \u51060 \u53552  \u50416 \u44592 \
        if (newRows.length > 0) \{\
            sheet.getRange(2, 1, newRows.length, newRows[0].length).setValues(newRows);\
        \}\
\
        return ContentService.createTextOutput(JSON.stringify(\{\
            success: true,\
            message: '\uc0\u52404 \u53356 \u47532 \u49828 \u53944  \u49692 \u49436 \u44032  \u51200 \u51109 \u46104 \u50632 \u49845 \u45768 \u45796 .',\
            count: newRows.length\
        \})).setMimeType(ContentService.MimeType.JSON);\
\
    \} catch (error) \{\
        return ContentService.createTextOutput(JSON.stringify(\{\
            success: false,\
            message: '\uc0\u51200 \u51109  \u49892 \u54056 : ' + error.toString()\
        \})).setMimeType(ContentService.MimeType.JSON);\
    \} finally \{\
        lock.releaseLock();\
    \}\
\}\
}