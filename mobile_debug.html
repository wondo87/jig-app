<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëª¨ë°”ì¼ ë™ê¸°í™” ë””ë²„ê·¸</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            font-size: 20px;
            margin-bottom: 20px;
        }
        button {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        #log {
            background: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 12px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 70vh;
            overflow-y: auto;
        }
        .log-entry {
            padding: 8px;
            margin: 5px 0;
            border-radius: 5px;
        }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
        .info { background: #d1ecf1; }
    </style>
</head>
<body>
    <h1>ğŸ” ëª¨ë°”ì¼ ë™ê¸°í™” ë””ë²„ê·¸</h1>

    <button onclick="testSync()">ë™ê¸°í™” í…ŒìŠ¤íŠ¸ ì‹œì‘</button>
    <button onclick="clearLog()">ë¡œê·¸ ì§€ìš°ê¸°</button>

    <div id="log"></div>

    <script src="admin_config.js"></script>
    <script>
        const logDiv = document.getElementById('log');

        function addLog(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            logDiv.innerHTML = '';
        }

        async function testSync() {
            clearLog();

            addLog('=== ë™ê¸°í™” í…ŒìŠ¤íŠ¸ ì‹œì‘ ===', 'info');

            // 1. ì„¤ì • í™•ì¸
            if (typeof CUSTOMER_SYNC_URL === 'undefined') {
                addLog('âŒ CUSTOMER_SYNC_URLì´ ì •ì˜ë˜ì§€ ì•ŠìŒ', 'error');
                return;
            }
            addLog(`âœ… CUSTOMER_SYNC_URL: ${CUSTOMER_SYNC_URL}`, 'success');

            // 2. ë„¤íŠ¸ì›Œí¬ í™•ì¸
            if (!navigator.onLine) {
                addLog('âŒ ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì—†ìŒ', 'error');
                return;
            }
            addLog('âœ… ë„¤íŠ¸ì›Œí¬ ì—°ê²°ë¨', 'success');

            // 3. ìš”ì²­ ì¤€ë¹„
            const params = new URLSearchParams({
                sheet: 'ê³ ê°ê´€ë¦¬_ê²¬ì ì„œ',
                t: Date.now()
            });
            const url = `${CUSTOMER_SYNC_URL}?${params}`;

            addLog(`ğŸ“¡ ìš”ì²­ URL ì¤€ë¹„`, 'info');
            addLog(`URL ê¸¸ì´: ${url.length}ì`, 'info');

            try {
                // 4. Fetch ìš”ì²­
                addLog('â³ ë°ì´í„° ìš”ì²­ ì¤‘...', 'info');

                const response = await fetch(url, {
                    method: 'GET',
                    mode: 'cors',
                    redirect: 'follow',
                    cache: 'no-store',
                    credentials: 'omit',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                addLog(`ğŸ“Š ì‘ë‹µ ìƒíƒœ: ${response.status} ${response.statusText}`, 'info');
                addLog(`ğŸ“Š ìµœì¢… URL: ${response.url.substring(0, 80)}...`, 'info');

                if (!response.ok) {
                    addLog(`âŒ HTTP ì˜¤ë¥˜: ${response.status}`, 'error');
                    const text = await response.text();
                    addLog(`ì‘ë‹µ ë‚´ìš©: ${text.substring(0, 200)}`, 'error');
                    return;
                }

                // 5. JSON íŒŒì‹±
                addLog('ğŸ“¦ ì‘ë‹µ ë°ì´í„° íŒŒì‹± ì¤‘...', 'info');
                const text = await response.text();
                addLog(`ì‘ë‹µ ê¸¸ì´: ${text.length}ì`, 'info');
                addLog(`ì‘ë‹µ ë¯¸ë¦¬ë³´ê¸°: ${text.substring(0, 100)}...`, 'info');

                let data;
                try {
                    data = JSON.parse(text);
                } catch (err) {
                    addLog(`âŒ JSON íŒŒì‹± ì‹¤íŒ¨: ${err.message}`, 'error');
                    return;
                }

                // 6. ë°ì´í„° í™•ì¸
                if (!Array.isArray(data)) {
                    addLog(`âŒ ë°ì´í„°ê°€ ë°°ì—´ì´ ì•„ë‹˜: ${typeof data}`, 'error');
                    return;
                }

                addLog(`âœ… ë™ê¸°í™” ì„±ê³µ!`, 'success');
                addLog(`âœ… ê³ ê° ìˆ˜: ${data.length}ëª…`, 'success');

                if (data.length > 0) {
                    const first = data[0];
                    addLog(`\nì²« ë²ˆì§¸ ê³ ê°:`, 'info');
                    addLog(`- ID: ${first.customerId}`, 'info');
                    addLog(`- ì´ë¦„: ${first.clientName}`, 'info');
                    addLog(`- ì „í™”: ${first.clientPhone}`, 'info');
                    addLog(`- í”„ë¡œì íŠ¸: ${first.projectName}`, 'info');
                }

            } catch (error) {
                addLog(`âŒ ì˜¤ë¥˜ ë°œìƒ: ${error.name}`, 'error');
                addLog(`ë©”ì‹œì§€: ${error.message}`, 'error');
                addLog(`ìŠ¤íƒ: ${error.stack}`, 'error');
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ í…ŒìŠ¤íŠ¸
        window.addEventListener('DOMContentLoaded', () => {
            addLog('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ', 'info');
            if (typeof CUSTOMER_SYNC_URL !== 'undefined') {
                addLog(`CUSTOMER_SYNC_URL í™•ì¸ë¨`, 'success');
            } else {
                addLog(`CUSTOMER_SYNC_URL ì—†ìŒ`, 'error');
            }
        });
    </script>
</body>
</html>
